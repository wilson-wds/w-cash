<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>金融業客戶關係管理系統 (CRM)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* CSS for printing only the history section */
        @media print {
            body > *:not(#print-area) { /* Hide all direct children of body except the print area */
                display: none !important;
            }
            #print-area { /* Ensure the print area is visible and takes full width */
                display: block !important;
                width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            /* Adjust table and text within print area for better print layout */
            #print-area table {
                width: 100%;
                border-collapse: collapse;
            }
            #print-area th, #print-area td {
                border: 1px solid #ddd;
                padding: 8px;
                text-align: left;
            }
            #print-area h2 {
                text-align: center;
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expose Firebase services to the window object for React to access
        window.firebase = {
            initializeApp,
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged,
            GoogleAuthProvider,
            signInWithPopup,
            signOut,
            getFirestore,
            doc,
            getDoc,
            addDoc,
            setDoc,
            updateDoc,
            deleteDoc,
            onSnapshot,
            collection,
            query,
            where,
            getDocs,
            serverTimestamp // Added serverTimestamp
        };
    </script>

    <script>
        // ====================================================================================================
        // *** 重要：請務必將以下 Firebase 配置替換為您自己專案的真實數值！ ***
        // 您可以在 Firebase Console -> 專案設定 (齒輪圖示) -> 「您的應用程式」中找到它。
        // 請確保複製的是完整的 JavaScript 物件，例如：{ apiKey: "...", authDomain: "...", ... }
        // 注意：不要在 JSON.stringify() 內部再加額外的引號，例如 JSON.stringify("{ ... }") 是錯誤的。
        // ====================================================================================================
        const __firebase_config = JSON.stringify({
          apiKey: "AIzaSyD1HulbSZpgpNFVQvmhd7GYUCUx6-7dn9s",
          authDomain: "money-5afb9.firebaseapp.com",
          projectId: "money-5afb9",
          storageBucket: "money-5afb9.firebasestorage.app",
          messagingSenderId: "136016647296",
          appId: "1:136016647296:web:fb8be3f22148e230cec265"
        });

        // *** 重要：請自訂一個唯一的應用程式 ID，如果不在 Canvas 環境中運行 ***
        // 這個 ID 必須與您在 Firestore 安全規則中使用的 {appId} 變數完全相符。
        // 建議與您的 Firebase Project ID 相同，以保持一致性。
        const __app_id = "money-5afb9"; // 使用您提供的 projectId 作為 app_id

        // 這是 Canvas 環境特有的初始認證 Token。
        // 在您本地運行或使用 GitHub Pages 時，此變數通常保持為空字串或移除。
        // 應用程式會自動回退到匿名登入。
        const __initial_auth_token = "";
        // ====================================================================================================
        // *** 上述配置替換完畢後，請儲存檔案並重新上傳到您的託管平台！ ***
        // ====================================================================================================
    </script>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        // Helper function to get today's date inYYYY-MM-DD format
        const getTodayDateString = () => {
            const today = new Date();
            const year = today.getFullYear();
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            const day = today.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        // CRM-specific advice messages
        const transactionSuccessAdvice = [
            "恭喜！客戶滿意度是您最大的資產。",
            "持續為客戶創造價值，建立長期信任關係。",
            "您的專業和努力得到了回報，繼續保持！",
            "謹慎管理客戶關係，讓成功持續增長。",
            "祝您客戶源源不絕，業績長紅！",
        ];

        const transactionFailureAdvice = [
            "別氣餒，每一次挫折都是學習的機會。",
            "重新檢視客戶需求，找出可以改進的地方。",
            "控制風險是首要任務，保護您的客戶關係。",
            "暫時休息一下，讓思緒沉澱再出發。",
            "分析失利原因，避免重蹈覆轍。",
            "調整心態，堅持理性判斷。",
        ];

        const transactionNeutralAdvice = [
            "客戶關係維護良好，持續觀察市場機會。",
            "保持耐心，客戶關係的建立需要時間。",
            "這是一個穩定的階段，可以考慮微調服務策略。",
            "持續提供優質服務，等待更好的合作機會。",
        ];

        function FinancialCRM() {
            const [db, setDb] = React.useState(null);
            const [auth, setAuth] = React.useState(null);
            const [userId, setUserId] = React.useState(null);
            const [userName, setUserName] = React.useState(null);
            const [userEmail, setUserEmail] = React.useState(null);
            const [isAuthReady, setIsAuthReady] = React.useState(false);
            const [loadingFirebase, setLoadingFirebase] = React.useState(true);

            // Client and Transaction input states
            const [clientName, setClientName] = React.useState('');
            const [loanAmount, setLoanAmount] = React.useState(''); // 借款金額
            const [interestRate, setInterestRate] = React.useState(''); // 利率
            const [interestRatePeriod, setInterestRatePeriod] = React.useState('年'); // 利率週期 (年/月/日)
            const [repaymentMethod, setRepaymentMethod] = React.useState('本+利'); // 還款方式
            const [loanTerm, setLoanTerm] = React.useState(''); // 期數
            const [notes, setNotes] = React.useState(''); // 備註

            // New client detail fields
            const [contactMethod, setContactMethod] = React.useState(''); // 聯絡方式
            const [address, setAddress] = React.useState(''); // 住址
            const [residentialArea, setResidentialArea] = React.useState(''); // 居住地
            const [occupation, setOccupation] = React.useState(''); // 職業
            const [companyPhone, setCompanyPhone] = React.useState(''); // 公司電話
            const [companyAddress, setCompanyAddress] = React.useState(''); // 公司地址
            const [disbursementNotes, setDisbursementNotes] = React.useState(''); // 出款備註
            const [emergencyContact1Name, setEmergencyContact1Name] = React.useState(''); // 緊急聯絡人1
            const [emergencyContact1Phone, setEmergencyContact1Phone] = React.useState(''); // 緊急聯絡人1電話
            const [emergencyContact2Name, setEmergencyContact2Name] = React.useState(''); // 緊急聯絡人2
            const [emergencyContact2Phone, setEmergencyContact2Phone] = React.useState(''); // 緊急聯絡人2電話

            const [projectedReturn, setProjectedReturn] = React.useState(null); // 預期報酬 (年利息參考)
            const [errorMessage, setErrorMessage] = React.useState('');
            const [transactionsHistory, setTransactionsHistory] = React.useState([]);

            // Cash Flow states for the current transaction
            const [cashFlows, setCashFlows] = React.useState([]); // 金流紀錄列表
            const [newCashFlowType, setNewCashFlowType] = React.useState('出款'); // 金流類型
            const [newCashFlowDate, setNewCashFlowDate] = React.useState(getTodayDateString()); // 金流日期
            const [newCashFlowAmount, setNewCashFlowAmount] = React.useState(''); // 金流金額
            const [newCashFlowItem, setNewCashFlowItem] = React.useState('本金+利息'); // 金流名目
            const [newCashFlowNotes, setNewCashFlowNotes] = React.useState(''); // 金流備註

            // Event History states for the current transaction
            const [eventHistoryRecords, setEventHistoryRecords] = React.useState([]); // 事件紀錄列表
            const [newEventDate, setNewEventDate] = React.useState(getTodayDateString()); // 事件日期
            const [newEventType, setNewEventType] = React.useState(''); // 事件類型
            const [newEventNotes, setNewEventNotes] = React.useState(''); // 事件備註
            const [showEventHistoryModal, setShowEventHistoryModal] = React.useState(false); // 控制事件紀錄彈窗顯示

            // Modals and editing states
            const [showConfirmDeleteDialog, setShowConfirmDeleteDialog] = React.useState(false);
            const [recordToDelete, setRecordToDelete] = React.useState(null);
            const [editingRecordId, setEditingRecordId] = React.useState(null);

            // Page navigation state
            const [currentPage, setCurrentPage] = React.useState('clientList'); // 'clientList', 'addClient', 'cashFlowSummary', 'eventHistory'

            // Version history data
            const versionHistoryData = [
                {
                    version: "1.9.5",
                    date: "2025-05-30",
                    content: "偵錯顯示問題：確保應用程式在無資料時能正常顯示「沒有符合篩選條件的交易紀錄」訊息。優化錯誤處理和載入狀態。",
                },
                {
                    version: "1.9.4",
                    date: "2025-05-30",
                    content: "修正客戶列表未顯示紀錄問題：確認資料庫中有紀錄，並確保列表能正確載入。同步 `calculateLoanNetProfit` 邏輯，避免顯示為 0.00。",
                },
                {
                    version: "1.9.3",
                    date: "2025-05-30",
                    content: "修正客戶列表「淨利」欄位顯示為 0 的問題：確保 `updateTransactionStatus` 函數在更新主交易紀錄時，能夠正確且及時地從 Firestore 讀取所有相關金流紀錄並計算 `actualProfit`。同時，優化 `calculateLoanNetProfit` 函數，使其在 `actualProfit` 未設定時顯示「待計算」。",
                },
                {
                    version: "1.9.2",
                    date: "2025-05-30",
                    content: "修正「淨利」欄位顯示：當淨利尚未計算時，顯示「待計算」。",
                },
                {
                    version: "1.9.1",
                    date: "2025-05-30",
                    content: "解決 `ReferenceError`：將依賴 `cashFlows` 的金流計算變數包裹在 `React.useMemo` 中，確保其在渲染時可用。優化應用程式層級的總計計算。",
                },
                {
                    version: "1.9",
                    date: "2025-05-30",
                    content: "新增客戶頁面：欄位改為兩欄顯示，新增返回鍵，金流收支/事件紀錄導覽鈕上移，移除目標報酬區塊。金流收支頁面：概覽和紀錄列表上移。客戶列表頁面：新增淨利欄位，移除隨機文字。",
                },
                {
                    version: "1.8.1",
                    date: "2025-05-30",
                    content: "客戶列表頁面再次優化：新增「淨利」欄位，並調整金流狀況計算邏輯。新增客戶頁面：金流收支導覽鈕上移，新增「事件紀錄」導覽鈕，並移除「達成目標報酬所需借款額」區塊。",
                },
                {
                    version: "1.8",
                    date: "2025-05-30",
                    content: "新增客戶頁面擴充：加入聯絡方式、住址、居住地、職業、公司電話、公司地址、出款備註、緊急聯絡人1/2及其電話。新增「金流收支」導覽鈕，並在該頁面顯示總出款、總收入、金流狀況及每期應繳金額。新增金流紀錄功能，包含類型、日期、金額、名目、備註欄位。",
                },
                {
                    version: "1.7",
                    date: "2025-05-30",
                    content: "客戶列表頁面再次優化：移除日期篩選器，列表取消顯示「利率週期」和「實際報酬」欄位。「實際結果」中的「成功」改為「成交」。統計數據新增「總收入」。",
                },
                {
                    version: "1.6",
                    date: "2025-05-30",
                    content: "客戶列表頁面和導覽重構。將「客戶借貸紀錄」改為「客戶列表」，移除日期區間和各類型篩選器。將「篩選後總實際報酬」改為「金流狀況」，「篩選後總借款金額」改為「總出款」（顯示負值）。「成功交易數」改為「總客戶數」。將「新增客戶交易/互動」改為獨立的「新增客戶」頁面，並透過導覽鈕切換。",
                },
                {
                    version: "1.5",
                    date: "2025-05-30",
                    content: "客戶列表頁面優化：將「客戶借貸紀錄」改為「客戶列表」，移除多餘篩選器，並調整統計數據顯示。",
                },
                {
                    version: "1.4",
                    date: "2025-05-30",
                    content: "新增客戶交易/互動頁面改版：聯絡資訊改為借款金額，產品服務類型改為利率及利率週期，交易金額改為還款方式，並新增期數欄位。",
                },
                {
                    version: "1.3",
                    date: "2025-05-29",
                    content: "解決 Firebase 匿名認證失敗問題：提醒用戶在 Firebase Console 中啟用匿名認證。版本號更新。",
                },
                {
                    version: "1.2",
                    date: "2025-05-29",
                    content: "更新 Firebase 配置資訊，確保應用程式能正確連接到您的 Firebase 專案。",
                },
                {
                    version: "1.1",
                    date: "2025-05-29",
                    content: "修正預覽無法正常顯示問題：確保 Firebase 配置變數正確傳遞並初始化。更新版本號。",
                },
                {
                    version: "1.0",
                    date: "2025-05-29",
                    content: "初始版本：基於運彩模板改編為金融業CRM。新增客戶管理、交易紀錄、產品類型管理、互動結果追蹤及相關統計。",
                },
            ];
            const [currentVersion, setCurrentVersion] = React.useState(versionHistoryData[0].version);
            const [showUpdateLogModal, setShowUpdateLogModal] = React.useState(false);
            const [showSettingsModal, setShowSettingsModal] = React.useState(false);

            // Fixed options for dropdowns
            const [managedInterestRatePeriods, setManagedInterestRatePeriods] = React.useState(['年', '月', '日']);
            const [managedRepaymentMethods, setManagedRepaymentMethods] = React.useState(['本+利', '純繳利息']);
            const [managedCashFlowTypes, setManagedCashFlowTypes] = React.useState(['出款', '還款']); // 金流類型
            const [managedCashFlowItems, setManagedCashFlowItems] = React.useState(['本金+利息', '本金', '利息', '其他']); // 金流名目
            const [managedOutcomeTypes, setManagedOutcomeTypes] = React.useState([]); // For settings modal, if custom outcomes are still desired
            const [newOutcomeTypeInput, setNewOutcomeTypeInput] = React.useState('');


            // --- Firebase Initialization and Authentication ---
            React.useEffect(() => {
                const initializeFirebase = async () => {
                    try {
                        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
                        const app = window.firebase.initializeApp(firebaseConfig);
                        const authInstance = window.firebase.getAuth(app);
                        const dbInstance = window.firebase.getFirestore(app);

                        setAuth(authInstance);
                        setDb(dbInstance);

                        console.log("Firebase Config:", firebaseConfig);

                        const unsubscribe = window.firebase.onAuthStateChanged(authInstance, async (user) => {
                            if (user) {
                                setUserId(user.uid);
                                setUserName(user.displayName || user.email || '匿名用戶');
                                setUserEmail(user.email);
                                console.log("User signed in:", user.uid);
                            } else {
                                try {
                                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token !== '') {
                                        await window.firebase.signInWithCustomToken(authInstance, __initial_auth_token);
                                        console.log("Signed in with custom token.");
                                    } else {
                                        await window.firebase.signInAnonymously(authInstance);
                                        console.log("Signed in anonymously.");
                                    }
                                } catch (anonError) {
                                    console.error("Anonymous sign-in failed:", anonError);
                                    setErrorMessage("匿名登入失敗，請檢查 Firebase 認證設定或 API 金鑰。");
                                }
                            }
                            setIsAuthReady(true);
                            setLoadingFirebase(false);
                        });

                        return () => unsubscribe();
                    } catch (error) {
                        console.error("Firebase initialization failed:", error);
                        setErrorMessage("Firebase 初始化失敗，請檢查設定。");
                        setLoadingFirebase(false);
                    }
                };

                initializeFirebase();
            }, []);

            // --- Load managed outcome types from Firestore (for settings modal) ---
            React.useEffect(() => {
                if (!db || !isAuthReady || !userId) return;

                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const outcomeTypesRef = window.firebase.collection(db, `artifacts/${appId}/users/${userId}/settings/userSettings/outcomeTypes`);

                const unsubscribeOutcomeTypes = window.firebase.onSnapshot(outcomeTypesRef, (snapshot) => {
                    const types = snapshot.docs.map(doc => doc.id);
                    setManagedOutcomeTypes(types.sort());
                }, (error) => {
                    console.error("Error fetching outcome types:", error);
                });

                return () => {
                    unsubscribeOutcomeTypes();
                };
            }, [db, isAuthReady, userId]);

            // --- Load cash flow records for the currently edited transaction ---
            React.useEffect(() => {
                if (!db || !isAuthReady || !userId || !editingRecordId || currentPage !== 'cashFlowSummary') {
                    setCashFlows([]); // Clear cash flows if not editing or not on cash flow page
                    return;
                }

                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const cashFlowsCollectionRef = window.firebase.collection(db, `artifacts/${appId}/users/${userId}/transactions/${editingRecordId}/cashFlows`);

                const unsubscribeCashFlows = window.firebase.onSnapshot(cashFlowsCollectionRef, (snapshot) => {
                    const records = [];
                    snapshot.forEach(doc => {
                        records.push({ id: doc.id, ...doc.data() });
                    });
                    records.sort((a, b) => {
                        const dateA = new Date(a.date.replace(/-/g, '/')).getTime();
                        const dateB = new Date(b.date.replace(/-/g, '/')).getTime();
                        return dateB - dateA; // Newest first
                    });
                    setCashFlows(records);
                }, (error) => {
                    console.error("Error fetching cash flow data:", error);
                    setErrorMessage("無法載入金流紀錄。");
                });

                return () => unsubscribeCashFlows();
            }, [db, isAuthReady, userId, editingRecordId, currentPage]); // Re-fetch when editingRecordId or currentPage changes

            // --- Load event history records for the currently edited transaction ---
            React.useEffect(() => {
                if (!db || !isAuthReady || !userId || !editingRecordId || !showEventHistoryModal) {
                    setEventHistoryRecords([]);
                    return;
                }

                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const eventsCollectionRef = window.firebase.collection(db, `artifacts/${appId}/users/${userId}/transactions/${editingRecordId}/events`);

                const unsubscribeEvents = window.firebase.onSnapshot(eventsCollectionRef, (snapshot) => {
                    const records = [];
                    snapshot.forEach(doc => {
                        records.push({ id: doc.id, ...doc.data() });
                    });
                    records.sort((a, b) => {
                        const dateA = new Date(a.date.replace(/-/g, '/')).getTime();
                        const dateB = new Date(b.date.replace(/-/g, '/')).getTime();
                        return dateB - dateA; // Newest first
                    });
                    setEventHistoryRecords(records);
                }, (error) => {
                    console.error("Error fetching event history data:", error);
                    setErrorMessage("無法載入事件紀錄。");
                });

                return () => unsubscribeEvents();
            }, [db, isAuthReady, userId, editingRecordId, showEventHistoryModal]);


            const handleGoogleSignIn = async () => {
                setErrorMessage('');
                if (!auth) {
                    setErrorMessage("認證服務未準備好。");
                    return;
                }
                try {
                    const provider = new window.firebase.GoogleAuthProvider();
                    await window.firebase.signInWithPopup(auth, provider);
                } catch (error) {
                    console.error("Google Sign-In failed:", error);
                    let msg = "Google 登入失敗。";
                    if (error.code === 'auth/popup-closed-by-user') {
                        msg = "Google 登入視窗已關閉。";
                    } else if (error.code === 'auth/cancelled-popup-request') {
                        msg = "已取消先前的登入請求。";
                    } else if (error.code === 'auth/unauthorized-domain') {
                        msg = "未授權的網域。請在 Firebase Console 中新增您的網域。";
                    }
                    setErrorMessage(msg + " 請檢查 Firebase 認證設定。");
                }
            };

            const handleSignOut = async () => {
                setErrorMessage('');
                if (!auth) {
                    setErrorMessage("認證服務未準備好。");
                    return;
                }
                try {
                    await window.firebase.signOut(auth);
                    setUserId(null);
                    setUserName(null);
                    setUserEmail(null);
                    setTransactionsHistory([]);
                } catch (error) {
                    console.error("Sign Out failed:", error);
                    setErrorMessage("登出失敗。");
                }
            };

            // --- Load transactions history from Firestore ---
            React.useEffect(() => {
                if (!db || !isAuthReady || !userId) {
                    if (transactionsHistory.length > 0) {
                        setTransactionsHistory([]);
                    }
                    return;
                }

                let unsubscribe;
                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const transactionsCollectionRef = window.firebase.collection(db, `artifacts/${appId}/users/${userId}/transactions`);

                    unsubscribe = window.firebase.onSnapshot(transactionsCollectionRef, (snapshot) => {
                        const records = [];
                        snapshot.forEach(doc => {
                            records.push({ id: doc.id, ...doc.data() });
                        });
                        records.sort((a, b) => {
                            const timeA = a.timestamp ? (a.timestamp.toDate ? a.timestamp.toDate().getTime() : a.timestamp) : a.id;
                            const timeB = b.timestamp ? (b.timestamp.toDate ? b.timestamp.toDate().getTime() : b.timestamp) : b.id;
                            return timeB - timeA; // Newest first
                        });
                        setTransactionsHistory(records);
                    }, (error) => {
                        console.error("Error fetching real-time data:", error);
                        setErrorMessage("無法載入即時交易紀錄。");
                    });

                } catch (error) {
                    console.error("Failed to set up Firestore listener:", error);
                    setErrorMessage("設定資料庫監聽失敗。");
                }

                return () => {
                    if (unsubscribe) unsubscribe();
                };
            }, [db, isAuthReady, userId]);

            // Calculate projected return (年利息參考)
            const calculateProjectedReturn = React.useCallback(() => {
                const parsedLoanAmount = parseFloat(loanAmount);
                const parsedInterestRate = parseFloat(interestRate);

                if (isNaN(parsedLoanAmount) || parsedLoanAmount <= 0 || isNaN(parsedInterestRate)) {
                    setProjectedReturn(null);
                } else {
                    let interestForPeriod;
                    switch (interestRatePeriod) {
                        case '年':
                            interestForPeriod = parsedLoanAmount * (parsedInterestRate / 100);
                            break;
                        case '月':
                            interestForPeriod = parsedLoanAmount * (parsedInterestRate / 100 / 12);
                            break;
                        case '日':
                            interestForPeriod = parsedLoanAmount * (parsedInterestRate / 100 / 365);
                            break;
                        default:
                            interestForPeriod = 0;
                    }
                    setProjectedReturn(interestForPeriod.toFixed(2));
                }
            }, [loanAmount, interestRate, interestRatePeriod]);

            React.useEffect(() => {
                calculateProjectedReturn();
            }, [loanAmount, interestRate, interestRatePeriod, calculateProjectedReturn]);

            // Calculate Amount Due Per Period (PMT)
            const calculateAmountDuePerPeriod = React.useCallback((amount, rate, term, periodType, repaymentMethodType) => {
                const P = parseFloat(amount);
                let i = parseFloat(rate) / 100; // Convert percentage to decimal
                let n = parseInt(term, 10);

                if (isNaN(P) || P <= 0 || isNaN(i) || i < 0 || (repaymentMethodType === '本+利' && (isNaN(n) || n <= 0))) {
                    return null; // Invalid inputs
                }

                // Adjust interest rate and term based on period type
                switch (periodType) {
                    case '年':
                        // i and n are already annual
                        break;
                    case '月':
                        i = i / 12;
                        // n is already monthly
                        break;
                    case '日':
                        i = i / 365;
                        // n is already daily
                        break;
                    default:
                        return null; // Unknown period type
                }

                if (repaymentMethodType === '純繳利息') {
                    return (P * i).toFixed(2); // Only interest payment
                } else if (repaymentMethodType === '本+利') {
                    if (i === 0) {
                        return (P / n).toFixed(2); // Simple division if no interest
                    }
                    // Amortized loan payment formula
                    const payment = P * (i * Math.pow(1 + i, n)) / (Math.pow(1 + i, n) - 1);
                    return payment.toFixed(2);
                }
                return null;
            }, []);

            const handleSaveRecordButtonClick = async () => {
                setErrorMessage('');
                if (!db || !userId) {
                    setErrorMessage("資料庫未準備好或未登入。請先登入。");
                    return;
                }

                const parsedLoanAmount = parseFloat(loanAmount);
                const parsedInterestRate = parseFloat(interestRate);
                const parsedLoanTerm = parseInt(loanTerm, 10);

                if (clientName.trim() === '') {
                    setErrorMessage('請輸入客戶名稱。');
                    return;
                }
                if (isNaN(parsedLoanAmount) || parsedLoanAmount <= 0) {
                    setErrorMessage('請輸入有效的借款金額 (必須是正數)。');
                    return;
                }
                if (isNaN(parsedInterestRate) || parsedInterestRate < 0) {
                    setErrorMessage('請輸入有效的利率 (必須大於或等於 0)。');
                    return;
                }
                if (interestRatePeriod.trim() === '') {
                    setErrorMessage('請選擇利率週期。');
                    return;
                }
                if (repaymentMethod.trim() === '') {
                    setErrorMessage('請選擇還款方式。');
                    return;
                }
                if (repaymentMethod === '本+利' && (isNaN(parsedLoanTerm) || parsedLoanTerm <= 0)) {
                    setErrorMessage('選擇「本+利」還款方式時，期數必須是正數。');
                    return;
                }

                const now = new Date();
                const localDateTimeString = now.toLocaleString('zh-TW', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                }).replace(/\//g, '-');

                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const transactionsCollectionRef = window.firebase.collection(db, `artifacts/${appId}/users/${userId}/transactions`);

                    const recordData = {
                        clientName: clientName.trim(),
                        loanAmount: parsedLoanAmount, // 借款金額
                        interestRate: parsedInterestRate, // 利率
                        interestRatePeriod: interestRatePeriod.trim(), // 利率週期
                        repaymentMethod: repaymentMethod.trim(), // 還款方式
                        loanTerm: repaymentMethod === '本+利' ? parsedLoanTerm : null, // 期數
                        notes: notes.trim(),
                        // New client detail fields
                        contactMethod: contactMethod.trim(),
                        address: address.trim(),
                        residentialArea: residentialArea.trim(),
                        occupation: occupation.trim(),
                        companyPhone: companyPhone.trim(),
                        companyAddress: companyAddress.trim(),
                        disbursementNotes: disbursementNotes.trim(),
                        emergencyContact1Name: emergencyContact1Name.trim(),
                        emergencyContact1Phone: emergencyContact1Phone.trim(),
                        emergencyContact2Name: emergencyContact2Name.trim(),
                        emergencyContact2Phone: emergencyContact2Phone.trim(),

                        actualOutcome: null,
                        outcomeNotes: '',
                        date: localDateTimeString,
                        status: 'pending',
                        timestamp: window.firebase.serverTimestamp ? window.firebase.serverTimestamp() : Date.now(),
                        addedBy: userId,
                        actualProfit: null, // Initialize actualProfit for new records
                    };

                    if (editingRecordId) {
                        const docRef = window.firebase.doc(transactionsCollectionRef, editingRecordId);
                        await window.firebase.updateDoc(docRef, recordData);
                        setErrorMessage("紀錄已成功更新。");
                        setEditingRecordId(null);
                    } else {
                        await window.firebase.addDoc(transactionsCollectionRef, recordData);
                        setErrorMessage("新增紀錄成功。");
                    }

                    // Default outcome types if not already present
                    const outcomeTypesSettingsRef = window.firebase.collection(db, `artifacts/${appId}/users/${userId}/settings/userSettings/outcomeTypes`);
                    if (!managedOutcomeTypes.includes('成交')) {
                        await window.firebase.setDoc(window.firebase.doc(outcomeTypesSettingsRef, '成交'), { exists: true });
                    }
                    if (!managedOutcomeTypes.includes('失敗')) {
                        await window.firebase.setDoc(window.firebase.doc(outcomeTypesSettingsRef, '失敗'), { exists: true });
                    }
                    if (!managedOutcomeTypes.includes('待定')) {
                        await window.firebase.setDoc(window.firebase.doc(outcomeTypesSettingsRef, '待定'), { exists: true });
                    }

                    resetFields();
                    setCurrentPage('clientList'); // After saving, return to client list
                } catch (error) {
                    console.error("Error saving document:", error);
                    setErrorMessage("儲存紀錄失敗。");
                }
            };

            const updateTransactionStatus = async (id, newStatus, outcomeNotes = '') => {
                setErrorMessage('');
                if (!db || !userId) {
                    setErrorMessage("資料庫未準備好或未登入。");
                    return;
                }
                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const docRef = window.firebase.doc(db, `artifacts/${appId}/users/${userId}/transactions`, id);
                    const docSnap = await window.firebase.getDoc(docRef);

                    if (docSnap.exists()) {
                        const recordData = docSnap.data();
                        let calculatedActualProfit = 0; // Initialize to 0 for calculation

                        // Fetch cash flows for this specific transaction to calculate actual profit
                        const cashFlowsForThisLoanRef = window.firebase.collection(db, `artifacts/${appId}/users/${userId}/transactions/${id}/cashFlows`);
                        const cashFlowsSnapshot = await window.firebase.getDocs(cashFlowsForThisLoanRef);
                        let totalIncomingForLoan = 0;
                        let totalOutgoingForLoan = 0;
                        cashFlowsSnapshot.forEach(cfDoc => {
                            const cfData = cfDoc.data();
                            if (cfData.type === '還款') {
                                totalIncomingForLoan += cfData.amount;
                            } else if (cfData.type === '出款') {
                                totalOutgoingForLoan += cfData.amount;
                            }
                        });

                        // Calculate actual profit based on cash flows
                        calculatedActualProfit = totalIncomingForLoan - totalOutgoingForLoan;

                        await window.firebase.updateDoc(docRef, {
                            actualOutcome: newStatus,
                            actualProfit: calculatedActualProfit, // Store the calculated net profit
                            status: newStatus,
                            outcomeNotes: outcomeNotes,
                            settledBy: userId,
                            settledAt: window.firebase.serverTimestamp ? window.firebase.serverTimestamp() : Date.now(),
                        });
                    } else {
                        setErrorMessage("找不到該紀錄。");
                        console.error("Attempted to update a non-existent document:", id);
                    }
                } catch (error) {
                    console.error("Error updating document:", error);
                    setErrorMessage("更新紀錄失敗。");
                }
            };

            const handleEditRecord = (record) => {
                setClientName(record.clientName);
                setLoanAmount(record.loanAmount.toString());
                setInterestRate(record.interestRate.toString());
                setInterestRatePeriod(record.interestRatePeriod || '年');
                setRepaymentMethod(record.repaymentMethod || '本+利');
                setLoanTerm(record.loanTerm ? record.loanTerm.toString() : '');
                setNotes(record.notes || '');
                // Set new fields for editing
                setContactMethod(record.contactMethod || '');
                setAddress(record.address || '');
                setResidentialArea(record.residentialArea || '');
                setOccupation(record.occupation || '');
                setCompanyPhone(record.companyPhone || '');
                setCompanyAddress(record.companyAddress || '');
                setDisbursementNotes(record.disbursementNotes || '');
                setEmergencyContact1Name(record.emergencyContact1Name || '');
                setEmergencyContact1Phone(record.emergencyContact1Phone || '');
                setEmergencyContact2Name(record.emergencyContact2Name || '');
                setEmergencyContact2Phone(record.emergencyContact2Phone || '');

                setEditingRecordId(record.id);
                setErrorMessage('');
                setProjectedReturn(null);
                setCurrentPage('addClient'); // Switch to form for editing
            };

            const handleCancelEdit = () => {
                setEditingRecordId(null);
                resetFields();
                setCurrentPage('clientList'); // Return to list after cancel
            };

            const handleDeleteRecord = async () => {
                setErrorMessage('');
                if (!db || !userId || !recordToDelete) {
                    setErrorMessage("無法刪除紀錄，資料庫未準備好或未登入。");
                    setShowConfirmDeleteDialog(false);
                    setRecordToDelete(null);
                    return;
                }

                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const docRef = window.firebase.doc(db, `artifacts/${appId}/users/${userId}/transactions`, recordToDelete);
                    await window.firebase.deleteDoc(docRef);
                    setErrorMessage("紀錄已成功刪除。");
                    setShowConfirmDeleteDialog(false);
                    setRecordToDelete(null);
                } catch (error) {
                    console.error("Error deleting document:", error);
                    setErrorMessage("刪除紀錄失敗。");
                    setShowConfirmDeleteDialog(false);
                    setRecordToDelete(null);
                }
            };

            // Functions to manage outcome types in settings
            const handleAddManagedOutcomeType = async () => {
                if (newOutcomeTypeInput.trim() === '') {
                    setErrorMessage("請輸入有效的結果類型名稱。");
                    return;
                }
                if (managedOutcomeTypes.includes(newOutcomeTypeInput.trim())) {
                    setErrorMessage("此結果類型已存在。");
                    return;
                }
                setErrorMessage('');
                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const outcomeTypesRef = window.firebase.collection(db, `artifacts/${appId}/users/${userId}/settings/userSettings/outcomeTypes`);
                    await window.firebase.setDoc(window.firebase.doc(outcomeTypesRef, newOutcomeTypeInput.trim()), { exists: true });
                    setNewOutcomeTypeInput('');
                } catch (error) {
                    console.error("Error adding outcome type:", error);
                    setErrorMessage("新增結果類型失敗。");
                }
            };

            const handleDeleteManagedOutcomeType = async (typeToDelete) => {
                setErrorMessage('');
                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const outcomeTypesRef = window.firebase.collection(db, `artifacts/${appId}/users/${userId}/settings/userSettings/outcomeTypes`);
                    await window.firebase.deleteDoc(window.firebase.doc(outcomeTypesRef, typeToDelete));
                } catch (error) {
                    console.error("Error deleting outcome type:", error);
                    setErrorMessage("刪除結果類型失敗。");
                }
            };

            // --- Cash Flow Record Management ---
            const handleSaveCashFlowRecord = async () => {
                setErrorMessage('');
                if (!db || !userId || !editingRecordId) {
                    setErrorMessage("無法新增金流紀錄，請先選擇或新增客戶。");
                    return;
                }

                const parsedCashFlowAmount = parseFloat(newCashFlowAmount);

                if (isNaN(parsedCashFlowAmount) || parsedCashFlowAmount === 0) {
                    setErrorMessage('請輸入有效的金流金額 (非零)。');
                    return;
                }
                if (newCashFlowType.trim() === '') {
                    setErrorMessage('請選擇金流類型。');
                    return;
                }
                if (newCashFlowDate.trim() === '') {
                    setErrorMessage('請選擇金流日期。');
                    return;
                }
                if (newCashFlowItem.trim() === '') {
                    setErrorMessage('請選擇金流名目。');
                    return;
                }

                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const cashFlowsCollectionRef = window.firebase.collection(db, `artifacts/${appId}/users/${userId}/transactions/${editingRecordId}/cashFlows`);

                    await window.firebase.addDoc(cashFlowsCollectionRef, {
                        type: newCashFlowType.trim(),
                        date: newCashFlowDate,
                        amount: parsedCashFlowAmount,
                        item: newCashFlowItem.trim(),
                        notes: newCashFlowNotes.trim(),
                        timestamp: window.firebase.serverTimestamp ? window.firebase.serverTimestamp() : Date.now(),
                        addedBy: userId,
                    });
                    setErrorMessage("金流紀錄新增成功。");
                    setNewCashFlowAmount('');
                    setNewCashFlowItem('本金+利息');
                    setNewCashFlowNotes('');
                } catch (error) {
                    console.error("Error saving cash flow document:", error);
                    setErrorMessage("儲存金流紀錄失敗。");
                }
            };

            const handleDeleteCashFlowRecord = async (cashFlowId) => {
                setErrorMessage('');
                if (!db || !userId || !editingRecordId) {
                    setErrorMessage("無法刪除金流紀錄，資料庫未準備好或未登入。");
                    return;
                }
                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const docRef = window.firebase.doc(db, `artifacts/${appId}/users/${userId}/transactions/${editingRecordId}/cashFlows`, cashFlowId);
                    await window.firebase.deleteDoc(docRef);
                    setErrorMessage("金流紀錄已成功刪除。");
                } catch (error) {
                    console.error("Error deleting cash flow document:", error);
                    setErrorMessage("刪除金流紀錄失敗。");
                }
            };

            // --- Event History Record Management ---
            const handleSaveEventRecord = async () => {
                setErrorMessage('');
                if (!db || !userId || !editingRecordId) {
                    setErrorMessage("無法新增事件紀錄，請先選擇或新增客戶。");
                    return;
                }
                if (newEventType.trim() === '') {
                    setErrorMessage('請輸入事件類型。');
                    return;
                }
                if (newEventNotes.trim() === '') {
                    setErrorMessage('請輸入事件備註。');
                    return;
                }

                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const eventsCollectionRef = window.firebase.collection(db, `artifacts/${appId}/users/${userId}/transactions/${editingRecordId}/events`);

                    await window.firebase.addDoc(eventsCollectionRef, {
                        date: newEventDate,
                        type: newEventType.trim(),
                        notes: newEventNotes.trim(),
                        timestamp: window.firebase.serverTimestamp ? window.firebase.serverTimestamp() : Date.now(),
                        addedBy: userId,
                    });
                    setErrorMessage("事件紀錄新增成功。");
                    setNewEventType('');
                    setNewEventNotes('');
                } catch (error) {
                    console.error("Error saving event document:", error);
                    setErrorMessage("儲存事件紀錄失敗。");
                }
            };

            const handleDeleteEventRecord = async (eventId) => {
                setErrorMessage('');
                if (!db || !userId || !editingRecordId) {
                    setErrorMessage("無法刪除事件紀錄，資料庫未準備好或未登入。");
                    return;
                }
                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const docRef = window.firebase.doc(db, `artifacts/${appId}/users/${userId}/transactions/${editingRecordId}/events`, eventId);
                    await window.firebase.deleteDoc(docRef);
                    setErrorMessage("事件紀錄已成功刪除。");
                } catch (error) {
                    console.error("Error deleting event document:", error);
                    setErrorMessage("刪除事件紀錄失敗。");
                }
            };


            const filteredTransactionsHistory = React.useMemo(() => {
                const filtered = [...transactionsHistory];

                return filtered.sort((a, b) => {
                    const dateA = a.timestamp ? (a.timestamp.toDate ? a.timestamp.toDate().getTime() : a.timestamp) : 0;
                    const dateB = b.timestamp ? (b.timestamp.toDate ? b.timestamp.toDate().getTime() : b.timestamp) : 0;
                    return dateB - dateA;
                });
            }, [transactionsHistory]);

            // Adjust totals for loan context
            const totalLoanAmountSum = React.useMemo(() => {
                return filteredTransactionsHistory.reduce((sum, record) => {
                    return sum + record.loanAmount;
                }, 0);
            }, [filteredTransactionsHistory]);

            const totalActualProfitAppLevel = React.useMemo(() => {
                return filteredTransactionsHistory.reduce((sum, record) => {
                    if (record.status === 'completed_success' || record.status === 'completed_failure') {
                        return sum + (record.actualProfit || 0); // Use actualProfit field
                    }
                    return sum;
                }, 0);
            }, [filteredTransactionsHistory]);

            const totalIncomingFromCashFlowsAppLevel = React.useMemo(() => {
                // This is a simplified sum. For accurate app-level totals, you'd need to sum all cash flows across all transactions.
                // For now, it's just summing 'actualProfit' which is calculated based on cash flows for *completed* loans.
                // To get true '總收入' and '總出款' for the whole app, you'd need to query all cashFlows subcollections.
                // This is a placeholder for a more complex aggregation.
                return filteredTransactionsHistory.reduce((sum, record) => {
                    return sum + (record.actualProfit > 0 ? record.actualProfit : 0); // Only positive actualProfit as income
                }, 0);
            }, [filteredTransactionsHistory]);

            const totalOutgoingFromCashFlowsAppLevel = React.useMemo(() => {
                // This is a simplified sum. For accurate app-level totals, you'd need to sum all cash flows across all transactions.
                return filteredTransactionsHistory.reduce((sum, record) => {
                    return sum + (record.actualProfit < 0 ? Math.abs(record.actualProfit) : 0); // Only negative actualProfit as outgoing
                }, 0);
            }, [filteredTransactionsHistory]);


            // Total Net Profit for a specific loan based on its cash flows
            const calculateLoanNetProfit = React.useCallback((loanId) => {
                const loanRecord = transactionsHistory.find(rec => rec.id === loanId);
                if (!loanRecord) return null; // Return null if record not found

                // Check if actualProfit is explicitly set and not null
                if (loanRecord.actualProfit !== undefined && loanRecord.actualProfit !== null) {
                    return loanRecord.actualProfit;
                }

                // If actualProfit is not set, return null to indicate it needs calculation
                return null;
            }, [transactionsHistory]);

            const totalCustomers = React.useMemo(() => {
                const uniqueClients = new Set();
                filteredTransactionsHistory.forEach(record => {
                    uniqueClients.add(record.clientName);
                });
                return uniqueClients.size;
            }, [filteredTransactionsHistory]);

            const totalIncomingFromCashFlows = React.useMemo(() => {
                return cashFlows.reduce((sum, record) => {
                    if (record.type === '還款') {
                        return sum + record.amount;
                    }
                    return sum;
                }, 0);
            }, [cashFlows]);

            const totalOutgoingFromCashFlows = React.useMemo(() => {
                return cashFlows.reduce((sum, record) => {
                    if (record.type === '出款') {
                        return sum + record.amount;
                    }
                    return sum;
                }, 0);
            }, [cashFlows]);

            const currentCashFlowStatus = React.useMemo(() => {
                return (totalIncomingFromCashFlows - totalOutgoingFromCashFlows).toFixed(2);
            }, [totalIncomingFromCashFlows, totalOutgoingFromCashFlows]);


            const resetFields = () => {
                setClientName('');
                setLoanAmount('');
                setInterestRate('');
                setInterestRatePeriod('年');
                setRepaymentMethod('本+利');
                setLoanTerm('');
                setNotes('');
                setProjectedReturn(null);
                setErrorMessage('');
                setEditingRecordId(null); // Clear editing state
                setCashFlows([]); // Clear cash flows
                setEventHistoryRecords([]); // Clear event history
                // Reset new client detail fields
                setContactMethod('');
                setAddress('');
                setResidentialArea('');
                setOccupation('');
                setCompanyPhone('');
                setCompanyAddress('');
                setDisbursementNotes('');
                setEmergencyContact1Name('');
                setEmergencyContact1Phone('');
                setEmergencyContact2Name('');
                setEmergencyContact2Phone('');
                // Reset cash flow input fields
                setNewCashFlowType('出款');
                setNewCashFlowDate(getTodayDateString());
                setNewCashFlowAmount('');
                setNewCashFlowItem('本金+利息');
                setNewCashFlowNotes('');
                // Reset event input fields
                setNewEventDate(getTodayDateString());
                setNewEventType('');
                setNewEventNotes('');
            };

            const exportToCsv = () => {
                if (filteredTransactionsHistory.length === 0) {
                    setErrorMessage('沒有紀錄可以導出。');
                    return;
                }

                const headers = ["序號", "借款日期", "客戶名稱", "借款金額", "淨利", "利率(%)", "還款方式", "期數", "實際結果", "聯絡方式", "住址", "居住地", "職業", "公司電話", "公司地址", "出款備註", "緊急聯絡人1", "緊急聯絡人1電話", "緊急聯絡人2", "緊急聯絡人2電話", "一般備註"];
                const csvRows = [];

                csvRows.push(headers.join(','));

                filteredTransactionsHistory.forEach((record, index) => {
                    const netProfitValue = calculateLoanNetProfit(record.id);
                    const netProfitDisplay = netProfitValue !== null ? netProfitValue.toFixed(2) : '待計算';
                    const row = [
                        index + 1,
                        record.date.substring(0, 10), // Only date part
                        record.clientName,
                        record.loanAmount,
                        netProfitDisplay, // Added Net Profit
                        record.interestRate,
                        record.repaymentMethod,
                        record.loanTerm || 'N/A',
                        record.status === 'pending' ? '待定' : (record.actualOutcome === 'completed_success' ? '成交' : '失敗'),
                        record.contactMethod || '',
                        record.address || '',
                        record.residentialArea || '',
                        record.occupation || '',
                        record.companyPhone || '',
                        record.companyAddress || '',
                        record.disbursementNotes || '',
                        record.emergencyContact1Name || '',
                        record.emergencyContact1Phone || '',
                        record.emergencyContact2Name || '',
                        record.emergencyContact2Phone || '',
                        record.notes || ''
                    ];
                    csvRows.push(row.join(','));
                });

                csvRows.push('');
                csvRows.push(`總出款:,${(totalLoanAmountSum * -1).toFixed(2)} NTD`);
                csvRows.push(`總收入:,${totalIncomingFromCashFlowsAppLevel.toFixed(2)} NTD`);
                csvRows.push(`金流狀況 (淨額):,${totalActualProfitAppLevel.toFixed(2)} NTD`); // Recalculated for overall app
                csvRows.push(`總客戶數:,${totalCustomers}`);

                const csvString = csvRows.join('\n');
                const blob = new Blob(['\ufeff' + csvString], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `客戶列表_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
            };

            const handlePrintRecordsOnly = () => {
                const printContent = document.getElementById('transaction-history-section');
                if (!printContent) {
                    setErrorMessage('找不到客戶列表區塊進行列印。');
                    return;
                }

                let printContentHtml = `
                    <!DOCTYPE html>
                    <html lang="zh-TW">
                    <head>
                        <meta charset="UTF-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <title>客戶列表列印</title>
                        <style>
                            body { font-family: 'Inter', sans-serif; margin: 20px; }
                            h2 { text-align: center; margin-bottom: 20px; font-size: 1.5em; }
                            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                            th { background-color: #f2f2f2; }
                            .success-text { color: #16A34A; font-weight: bold; }
                            .failure-text { color: #DC2626; font-weight: bold; }
                            .blue-text { color: #2563EB; font-weight: bold; }
                            .red-text { color: #DC2626; font-weight: bold; }
                            .outcome-badge {
                                display: inline-block;
                                padding: 4px 8px;
                                border-radius: 9999px;
                                font-weight: 600;
                                font-size: 0.8em;
                                line-height: 1;
                            }
                            .success-badge { background-color: #D1FAE5; color: #065F46; }
                            .failure-badge { background-color: #FEE2E2; color: #991B1B; }
                        </style>
                        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
                    </head>
                    <body>
                        <h2>客戶列表</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>序號</th>
                                    <th>借款日期</th>
                                    <th>客戶名稱</th>
                                    <th>借款金額</th>
                                    <th>淨利</th>
                                    <th>利率(%)</th>
                                    <th>還款方式</th>
                                    <th>期數</th>
                                    <th>實際結果</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filteredTransactionsHistory.map((record, index) => `
                                    <tr>
                                        <td>${index + 1}</td>
                                        <td>${record.date.substring(0, 10)}</td>
                                        <td>${record.clientName}</td>
                                        <td>${record.loanAmount}</td>
                                        <td>${calculateLoanNetProfit(record.id) !== null ? calculateLoanNetProfit(record.id).toFixed(2) : '待計算'}</td>
                                        <td>${record.interestRate}</td>
                                        <td>${record.repaymentMethod}</td>
                                        <td>${record.loanTerm || 'N/A'}</td>
                                        <td>
                                            <span class="outcome-badge ${record.status === 'completed_success' ? 'success-badge' : (record.status === 'completed_failure' ? 'failure-badge' : '')}">
                                                ${record.status === 'pending' ? '待定' : (record.actualOutcome === 'completed_success' ? '成交' : '失敗')}
                                            </span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <div style="text-align: center; margin-top: 20px; font-size: 1.1em; font-weight: bold;">
                            金流狀況:
                            <span class="${parseFloat(totalActualProfitAppLevel) >= 0 ? 'blue-text' : 'red-text'}">
                                ${totalActualProfitAppLevel.toFixed(2)} NTD
                            </span>
                        </div>
                        <div style="text-align: center; margin-top: 10px; font-size: 1em;">
                            總出款: ${(totalLoanAmountSum * -1).toFixed(2)} NTD
                        </div>
                        <div style="text-align: center; margin-top: 10px; font-size: 1em;">
                            總收入: ${totalIncomingFromCashFlowsAppLevel.toFixed(2)} NTD
                        </div>
                        <div style="text-align: center; margin-top: 10px; font-size: 1em;">
                            總客戶數: ${totalCustomers}
                        </div>
                        <div style="text-align: center; margin-top: 30px; font-size: 0.8em; color: #6B7280;">
                            威爾設計版權所有 ver ${currentVersion}
                        </div>
                    </body>
                    </html>
                `;
                const printWindow = window.open('', '_blank', 'width=800,height=600');
                if (printWindow) {
                    printWindow.document.write(printContentHtml);
                    printWindow.document.close();
                    printWindow.focus();

                    printWindow.onload = () => {
                        printWindow.print();
                        printWindow.close();
                    };
                } else {
                    setErrorMessage('無法開啟列印視窗，請檢查瀏覽器設定或彈出視窗阻擋。');
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-100 to-white flex flex-col items-center justify-center p-4 font-sans">
                    {/* Display loading state */}
                    {loadingFirebase && (
                        <div className="absolute inset-0 bg-gray-200 bg-opacity-75 flex items-center justify-center z-50">
                            <div className="text-gray-800 text-lg font-bold">載入中...</div>
                        </div>
                    )}

                    {/* User Info and Sign-in/Sign-out buttons */}
                    <div className="absolute top-4 left-4 right-4 flex flex-col sm:flex-row justify-between items-start sm:items-center bg-gray-100 text-gray-700 text-xs px-3 py-2 rounded-full shadow-md z-10">
                        {userId ? (
                            <div className="flex items-center">
                                <span className="font-bold mr-1">登入用戶:</span>
                                {userName || userEmail || userId}
                                {userEmail && <span className="ml-2 text-gray-500">({userEmail})</span>}
                            </div>
                        ) : (
                            <span className="font-bold">未登入</span>
                        )}
                        <div className="mt-2 sm:mt-0 flex space-x-2">
                            {userId && !userEmail ? (
                                <button
                                    onClick={handleGoogleSignIn}
                                    className="bg-blue-500 hover:bg-blue-600 text-white text-xs px-3 py-1 rounded-full transition duration-200"
                                    disabled={loadingFirebase || !isAuthReady}
                                >
                                    Google 登入
                                </button>
                            ) : userId && userEmail ? (
                                <button
                                    onClick={handleSignOut}
                                    className="bg-red-500 hover:bg-red-600 text-white text-xs px-3 py-1 rounded-full transition duration-200"
                                    disabled={loadingFirebase || !isAuthReady}
                                >
                                    登出
                                </button>
                            ) : (
                                <button
                                    onClick={handleGoogleSignIn}
                                    className="bg-blue-500 hover:bg-blue-600 text-white text-xs px-3 py-1 rounded-full transition duration-200"
                                    disabled={loadingFirebase || !isAuthReady}
                                >
                                    Google 登入
                                </button>
                            )}
                        </div>
                        {/* Settings Button */}
                        <button
                            onClick={() => setShowSettingsModal(true)}
                            className="absolute top-2 right-4 p-2 rounded-full bg-gray-200 hover:bg-gray-300 text-gray-700 transition duration-200 focus:outline-none focus:ring-2 focus:ring-gray-400"
                            title="設定"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fillRule="evenodd" d="M11.49 3.17c-.38-1.16-1.47-1.16-1.85 0L9 4.38a1 1 0 01-.78.78l-1.16.38c-1.16.38-1.16 1.47 0 1.85l.38.78a1 1 0 01.78.78l.38 1.16c.38 1.16 1.47 1.16 1.85 0l.78-.38a1 1 0 01.78-.78l1.16-.38c1.16-.38 1.16-1.47 0-1.85l-.38-.78a1 1 0 01-.78-.78l-.38-1.16zM15.5 13a3.5 3.5 0 11-7 0 3.5 3.5 0 017 0zM17.5 12a.5.5 0 00-.5.5v2a.5.5 0 00.5.5h2a.5.5 0 00.5-.5v-2a.5.5 0 00-.5-.5h-2z" clipRule="evenodd" />
                            </svg>
                        </button>
                    </div>

                    {/* Confirmation Dialog for single record delete */}
                    {showConfirmDeleteDialog && recordToDelete && (
                        <div className="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50">
                            <div className="bg-white p-6 rounded-lg shadow-xl text-center">
                                <p className="text-lg font-semibold mb-4">確定要刪除這筆紀錄嗎？</p>
                                <p className="text-sm text-gray-600 mb-6">此操作無法復原。</p>
                                <div className="flex justify-center space-x-4">
                                    <button
                                        onClick={() => { setShowConfirmDeleteDialog(false); setRecordToDelete(null); }}
                                        className="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-200"
                                    >
                                        取消
                                    </button>
                                    <button
                                        onClick={handleDeleteRecord}
                                        className="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200"
                                    >
                                        確認刪除
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Settings Modal */}
                    {showSettingsModal && (
                        <div className="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4">
                            <div className="bg-white p-6 rounded-lg shadow-xl max-w-md w-full">
                                <h2 className="text-2xl font-bold text-gray-900 mb-4 text-center">設定</h2>
                                {/* Outcome Type Management (only custom outcomes allowed) */}
                                <div className="mb-4 border-t pt-4 mt-4">
                                    <h3 className="text-lg font-semibold text-gray-800 mb-2">管理結果類型</h3>
                                    <div className="flex flex-wrap gap-2 mb-2">
                                        {managedOutcomeTypes.map(type => (
                                            <span key={type} className="bg-green-100 text-green-800 px-2 py-1 rounded-full text-sm flex items-center">
                                                {type}
                                                <button
                                                    onClick={() => handleDeleteManagedOutcomeType(type)}
                                                    className="ml-1 text-green-600 hover:text-green-800 focus:outline-none"
                                                >
                                                    &times;
                                                </button>
                                            </span>
                                        ))}
                                    </div>
                                    <div className="flex">
                                        <input
                                            type="text"
                                            placeholder="新增結果類型"
                                            value={newOutcomeTypeInput}
                                            onChange={(e) => setNewOutcomeTypeInput(e.target.value)}
                                            onKeyDown={(e) => {
                                                if (e.key === 'Enter') {
                                                    handleAddManagedOutcomeType();
                                                }
                                            }}
                                            className="flex-grow px-4 py-2 border border-gray-300 rounded-l-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800"
                                        />
                                        <button
                                            onClick={handleAddManagedOutcomeType}
                                            className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-r-lg transition duration-200"
                                        >
                                            新增
                                        </button>
                                    </div>
                                </div>
                                <div className="text-center mt-4">
                                    <button
                                        onClick={() => setShowSettingsModal(false)}
                                        className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200"
                                    >
                                        確定更新
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Event History Modal */}
                    {showEventHistoryModal && editingRecordId && (
                        <div className="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4">
                            <div className="bg-white p-6 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                                <h2 className="text-2xl font-bold text-gray-900 mb-4 text-center">
                                    事件紀錄 (客戶: {transactionsHistory.find(rec => rec.id === editingRecordId)?.clientName})
                                </h2>

                                {/* Add New Event Record */}
                                <div className="mb-8 p-6 bg-gray-100 rounded-lg shadow-inner">
                                    <h3 className="text-xl font-semibold text-gray-800 mb-4">新增事件</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <label htmlFor="newEventDate" className="block text-gray-700 text-sm font-semibold mb-2">
                                                日期:
                                            </label>
                                            <input
                                                type="date"
                                                id="newEventDate"
                                                value={newEventDate}
                                                onChange={(e) => setNewEventDate(e.target.value)}
                                                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800"
                                            />
                                        </div>
                                        <div>
                                            <label htmlFor="newEventType" className="block text-gray-700 text-sm font-semibold mb-2">
                                                類型:
                                            </label>
                                            <input
                                                type="text"
                                                id="newEventType"
                                                value={newEventType}
                                                onChange={(e) => setNewEventType(e.target.value)}
                                                placeholder="例如: 電話聯絡, 會面"
                                                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800"
                                            />
                                        </div>
                                        <div className="md:col-span-2">
                                            <label htmlFor="newEventNotes" className="block text-gray-700 text-sm font-semibold mb-2">
                                                備註:
                                            </label>
                                            <textarea
                                                id="newEventNotes"
                                                value={newEventNotes}
                                                onChange={(e) => setNewEventNotes(e.target.value)}
                                                placeholder="例如: 討論還款計畫"
                                                rows="2"
                                                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800"
                                            ></textarea>
                                        </div>
                                    </div>
                                    <button
                                        onClick={handleSaveEventRecord}
                                        className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75"
                                        disabled={loadingFirebase || !isAuthReady}
                                    >
                                        新增事件
                                    </button>
                                </div>

                                {/* Event History Table */}
                                <div className="mt-8">
                                    <h3 className="text-xl font-extrabold text-gray-900 mb-4 text-center">事件紀錄列表</h3>
                                    {eventHistoryRecords.length > 0 ? (
                                        <div className="overflow-x-auto">
                                            <table className="min-w-full bg-white rounded-lg shadow-md">
                                                <thead>
                                                    <tr className="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                                                        <th className="py-3 px-6 text-left">日期</th>
                                                        <th className="py-3 px-6 text-left">類型</th>
                                                        <th className="py-3 px-6 text-left">備註</th>
                                                        <th className="py-3 px-6 text-left">操作</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="text-gray-600 text-sm font-light">
                                                    {eventHistoryRecords.map(event => (
                                                        <tr key={event.id} className="border-b border-gray-200 hover:bg-gray-100">
                                                            <td className="py-3 px-6 text-left whitespace-nowrap">{event.date}</td>
                                                            <td className="py-3 px-6 text-left whitespace-nowrap">{event.type}</td>
                                                            <td className="py-3 px-6 text-left">{event.notes}</td>
                                                            <td className="py-3 px-6 text-left">
                                                                <button
                                                                    onClick={() => handleDeleteEventRecord(event.id)}
                                                                    className="bg-gray-400 hover:bg-gray-500 text-white text-xs px-2 py-1 rounded-md transition duration-200"
                                                                >
                                                                    刪除
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    ) : (
                                        <p className="text-center text-gray-500 mt-4">
                                            此客戶目前沒有事件紀錄。
                                        </p>
                                    )}
                                </div>

                                <div className="text-center mt-8">
                                    <button
                                        onClick={() => setShowEventHistoryModal(false)}
                                        className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200"
                                    >
                                        關閉
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}


                    {/* Main container for CRM pages */}
                    <div className="flex flex-col md:flex-row md:space-x-8 w-full max-w-7xl mt-20 sm:mt-24">
                        {/* Conditional Rendering based on currentPage */}
                        {currentPage === 'addClient' && (
                            <div className="bg-white p-8 rounded-xl shadow-2xl w-full mb-8 transform transition-all duration-300 hover:scale-[1.01]">
                                <h1 className="text-3xl font-extrabold text-gray-900 mb-6 text-center">
                                    新增客戶
                                </h1>

                                {/* Top navigation for Add/Edit Client Page */}
                                <div className="flex flex-wrap justify-center sm:justify-start gap-2 mb-6">
                                    <button
                                        onClick={() => setCurrentPage('clientList')}
                                        className="bg-gray-400 hover:bg-gray-500 text-white text-sm font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75"
                                    >
                                        返回客戶列表
                                    </button>
                                    {editingRecordId && (
                                        <button
                                            onClick={() => setCurrentPage('cashFlowSummary')}
                                            className="bg-purple-600 hover:bg-purple-700 text-white text-sm font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-75"
                                        >
                                            金流收支
                                        </button>
                                    )}
                                    {editingRecordId && ( // New: Event History Button
                                        <button
                                            onClick={() => setShowEventHistoryModal(true)} // Open modal
                                            className="bg-yellow-600 hover:bg-yellow-700 text-white text-sm font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-opacity-75"
                                        >
                                            事件紀錄
                                        </button>
                                    )}
                                </div>


                                {/* Input fields arranged in two columns */}
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    {/* Client Name */}
                                    <div className="md:col-span-2 mb-4">
                                        <label htmlFor="clientName" className="block text-gray-700 text-sm font-semibold mb-2">
                                            客戶名稱:
                                        </label>
                                        <input
                                            type="text"
                                            id="clientName"
                                            value={clientName}
                                            onChange={(e) => setClientName(e.target.value)}
                                            placeholder="例如: 王小明"
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800"
                                        />
                                    </div>

                                    {/* Contact Method */}
                                    <div className="mb-4">
                                        <label htmlFor="contactMethod" className="block text-gray-700 text-sm font-semibold mb-2">
                                            聯絡方式:
                                        </label>
                                        <input
                                            type="text"
                                            id="contactMethod"
                                            value={contactMethod}
                                            onChange={(e) => setContactMethod(e.target.value)}
                                            placeholder="例如: 手機號碼、Email"
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800"
                                        />
                                    </div>

                                    {/* Address */}
                                    <div className="mb-4">
                                        <label htmlFor="address" className="block text-gray-700 text-sm font-semibold mb-2">
                                            住址:
                                        </label>
                                        <input
                                            type="text"
                                            id="address"
                                            value={address}
                                            onChange={(e) => setAddress(e.target.value)}
                                            placeholder="例如: 台北市信義區忠孝東路一段1號"
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800"
                                        />
                                    </div>

                                    {/* Residential Area */}
                                    <div className="mb-4">
                                        <label htmlFor="residentialArea" className="block text-gray-700 text-sm font-semibold mb-2">
                                            居住地:
                                        </label>
                                        <input
                                            type="text"
                                            id="residentialArea"
                                            value={residentialArea}
                                            onChange={(e) => setResidentialArea(e.target.value)}
                                            placeholder="例如: 台北市"
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800"
                                        />
                                    </div>

                                    {/* Occupation */}
                                    <div className="mb-4">
                                        <label htmlFor="occupation" className="block text-gray-700 text-sm font-semibold mb-2">
                                            職業:
                                        </label>
                                        <input
                                            type="text"
                                            id="occupation"
                                            value={occupation}
                                            onChange={(e) => setOccupation(e.target.value)}
                                            placeholder="例如: 工程師"
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800"
                                        />
                                    </div>

                                    {/* Company Phone */}
                                    <div className="mb-4">
                                        <label htmlFor="companyPhone" className="block text-gray-700 text-sm font-semibold mb-2">
                                            公司電話:
                                        </label>
                                        <input
                                            type="text"
                                            id="companyPhone"
                                            value={companyPhone}
                                            onChange={(e) => setCompanyPhone(e.target.value)}
                                            placeholder="例如: (02)1234-5678"
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800"
                                        />
                                    </div>

                                    {/* Company Address */}
                                    <div className="mb-4">
                                        <label htmlFor="companyAddress" className="block text-gray-700 text-sm font-semibold mb-2">
                                            公司地址:
                                        </label>
                                        <input
                                            type="text"
                                            id="companyAddress"
                                            value={companyAddress}
                                            onChange={(e) => setCompanyAddress(e.target.value)}
                                            placeholder="例如: 台北市內湖區瑞光路99號"
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800"
                                        />
                                    </div>

                                    {/* Loan Amount */}
                                    <div className="mb-4">
                                        <label htmlFor="loanAmount" className="block text-gray-700 text-sm font-semibold mb-2">
                                            借款金額 (NTD):
                                        </label>
                                        <input
                                            type="number"
                                            id="loanAmount"
                                            value={loanAmount}
                                            onChange={(e) => setLoanAmount(e.target.value)}
                                            placeholder="例如: 100000"
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800"
                                        />
                                    </div>

                                    {/* Interest Rate and Period */}
                                    <div className="mb-4 flex space-x-2">
                                        <div className="flex-1">
                                            <label htmlFor="interestRate" className="block text-gray-700 text-sm font-semibold mb-2">
                                                利率 (%):
                                            </label>
                                            <input
                                                type="number"
                                                id="interestRate"
                                                value={interestRate}
                                                onChange={(e) => setInterestRate(e.target.value)}
                                                placeholder="例如: 5.0 (代表 5%)"
                                                step="0.01"
                                                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800"
                                            />
                                        </div>
                                        <div>
                                            <label htmlFor="interestRatePeriod" className="block text-gray-700 text-sm font-semibold mb-2">
                                                週期:
                                            </label>
                                            <select
                                                id="interestRatePeriod"
                                                value={interestRatePeriod}
                                                onChange={(e) => setInterestRatePeriod(e.target.value)}
                                                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800"
                                            >
                                                {managedInterestRatePeriods.map(period => (
                                                    <option key={period} value={period}>{period}</option>
                                                ))}
                                            </select>
                                        </div>
                                    </div>

                                    {/* Repayment Method */}
                                    <div className="mb-4">
                                        <label htmlFor="repaymentMethod" className="block text-gray-700 text-sm font-semibold mb-2">
                                            還款方式:
                                        </label>
                                        <select
                                            id="repaymentMethod"
                                            value={repaymentMethod}
                                            onChange={(e) => setRepaymentMethod(e.target.value)}
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800"
                                        >
                                            {managedRepaymentMethods.map(method => (
                                                <option key={method} value={method}>{method}</option>
                                            ))}
                                        </select>
                                    </div>

                                    {/* Loan Term Input - conditionally displayed */}
                                    {repaymentMethod === '本+利' && (
                                        <div className="mb-4">
                                            <label htmlFor="loanTerm" className="block text-gray-700 text-sm font-semibold mb-2">
                                                期數:
                                            </label>
                                            <input
                                                type="number"
                                                id="loanTerm"
                                                value={loanTerm}
                                                onChange={(e) => setLoanTerm(e.target.value)}
                                                placeholder="例如: 12 (單位與利率週期一致)"
                                                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800"
                                            />
                                            <p className="text-xs text-gray-500 mt-1">
                                                例如：若利率為年利率，期數為年；若利率為月利率，期數為月。
                                            </p>
                                        </div>
                                    )}

                                    {/* Disbursement Notes */}
                                    <div className="md:col-span-2 mb-4">
                                        <label htmlFor="disbursementNotes" className="block text-gray-700 text-sm font-semibold mb-2">
                                            出款備註:
                                        </label>
                                        <textarea
                                            id="disbursementNotes"
                                            value={disbursementNotes}
                                            onChange={(e) => setDisbursementNotes(e.target.value)}
                                            placeholder="例如: 首次出款，已確認帳戶資訊。"
                                            rows="2"
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800"
                                        ></textarea>
                                    </div>

                                    {/* Emergency Contact 1 */}
                                    <div className="mb-4">
                                        <label htmlFor="emergencyContact1Name" className="block text-gray-700 text-sm font-semibold mb-2">
                                            緊急聯絡人1姓名:
                                        </label>
                                        <input
                                            type="text"
                                            id="emergencyContact1Name"
                                            value={emergencyContact1Name}
                                            onChange={(e) => setEmergencyContact1Name(e.target.value)}
                                            placeholder="例如: 李大明"
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800"
                                        />
                                    </div>
                                    <div className="mb-4">
                                        <label htmlFor="emergencyContact1Phone" className="block text-gray-700 text-sm font-semibold mb-2">
                                            緊急聯絡人1電話:
                                        </label>
                                        <input
                                            type="text"
                                            id="emergencyContact1Phone"
                                            value={emergencyContact1Phone}
                                            onChange={(e) => setEmergencyContact1Phone(e.target.value)}
                                            placeholder="例如: 0912345678"
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800"
                                        />
                                    </div>

                                    {/* Emergency Contact 2 */}
                                    <div className="mb-4">
                                        <label htmlFor="emergencyContact2Name" className="block text-gray-700 text-sm font-semibold mb-2">
                                            緊急聯絡人2姓名:
                                        </label>
                                        <input
                                            type="text"
                                            id="emergencyContact2Name"
                                            value={emergencyContact2Name}
                                            onChange={(e) => setEmergencyContact2Name(e.target.value)}
                                            placeholder="例如: 陳小華"
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800"
                                        />
                                    </div>
                                    <div className="mb-4">
                                        <label htmlFor="emergencyContact2Phone" className="block text-gray-700 text-sm font-semibold mb-2">
                                            緊急聯絡人2電話:
                                        </label>
                                        <input
                                            type="text"
                                            id="emergencyContact2Phone"
                                            value={emergencyContact2Phone}
                                            onChange={(e) => setEmergencyContact2Phone(e.target.value)}
                                            placeholder="例如: 0987654321"
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800"
                                        />
                                    </div>

                                    {/* General Notes */}
                                    <div className="md:col-span-2 mb-4">
                                        <label htmlFor="notes" className="block text-gray-700 text-sm font-semibold mb-2">
                                            一般備註:
                                        </label>
                                        <textarea
                                            id="notes"
                                            value={notes}
                                            onChange={(e) => setNotes(e.target.value)}
                                            placeholder="例如: 客戶對此產品感興趣，需進一步追蹤。"
                                            rows="3"
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800"
                                        ></textarea>
                                    </div>
                                </div> {/* End of two-column grid */}

                                {/* Error message display */}
                                {errorMessage && (
                                    <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-4" role="alert">
                                        <span className="block sm:inline">{errorMessage}</span>
                                    </div>
                                )}

                                {/* Action buttons for Add/Edit Client (Moved to bottom) */}
                                <div className="flex space-x-4 mb-6 mt-6">
                                    <button
                                        onClick={handleSaveRecordButtonClick}
                                        className="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75"
                                        disabled={loadingFirebase || !isAuthReady}
                                    >
                                        {editingRecordId ? '更新客戶資料' : '新增客戶資料'}
                                    </button>
                                    <button
                                        onClick={resetFields}
                                        className="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75"
                                    >
                                        重設
                                    </button>
                                    {editingRecordId && (
                                        <button
                                            onClick={handleCancelEdit}
                                            className="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75 ml-2"
                                        >
                                            取消編輯
                                        </button>
                                    )}
                                </div>

                                {/* Display area for the projected return (每期預期利息) */}
                                {projectedReturn !== null && (
                                    <div className="mt-6 p-6 bg-gray-50 rounded-xl shadow-inner text-center mb-4">
                                        <h2 className="text-xl font-semibold text-gray-700 mb-2">借貸預覽 ({interestRatePeriod}預期利息):</h2>
                                        <p className={`text-4xl font-extrabold ${parseFloat(projectedReturn) >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                            {projectedReturn} NTD
                                        </p>
                                        <p className="text-sm text-gray-600 mt-2">此為借款金額在當前{interestRatePeriod}利率下，一{interestRatePeriod}預期產生之利息。</p>
                                    </div>
                                )}
                            </div>
                        )}

                        {currentPage === 'clientList' && (
                            <div id="transaction-history-section" className="bg-white p-8 rounded-xl shadow-2xl w-full overflow-y-auto max-h-[85vh] min-h-[200px]">
                                <h2 className="text-xl font-extrabold text-gray-900 mb-4 text-center">客戶列表</h2>

                                {/* Top navigation/action buttons */}
                                <div className="mb-4 flex flex-col sm:flex-row sm:space-x-4 items-end justify-end">
                                    <button
                                        onClick={() => setCurrentPage('addClient')}
                                        className="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 mb-2 sm:mb-0"
                                    >
                                        新增客戶
                                    </button>
                                    <button
                                        onClick={exportToCsv}
                                        className="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75 mb-2 sm:mb-0"
                                    >
                                        導出列表
                                    </button>
                                    <button
                                        onClick={handlePrintRecordsOnly}
                                        className="w-full sm:w-auto bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-75"
                                    >
                                        列印列表
                                    </button>
                                </div>

                                {filteredTransactionsHistory.length > 0 ? (
                                    <>
                                        <div className="overflow-x-auto">
                                            <table className="min-w-full bg-white rounded-lg shadow-md">
                                                <thead>
                                                    <tr className="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                                                        <th className="py-3 px-6 text-left">序號</th>
                                                        <th className="py-3 px-6 text-left">借款日期</th>
                                                        <th className="py-3 px-6 text-left">客戶名稱</th>
                                                        <th className="py-3 px-6 text-left">借款金額</th>
                                                        <th className="py-3 px-6 text-left">淨利</th> {/* Added Net Profit */}
                                                        <th className="py-3 px-6 text-left">利率(%)</th>
                                                        <th className="py-3 px-6 text-left">還款方式</th>
                                                        <th className="py-3 px-6 text-left">期數</th>
                                                        <th className="py-3 px-6 text-left">實際結果</th>
                                                        <th className="py-3 px-6 text-left">操作</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="text-gray-600 text-sm font-light">
                                                    {filteredTransactionsHistory.map((record, index) => (
                                                        <tr key={record.id} className="border-b border-gray-200 hover:bg-gray-100">
                                                            <td className="py-3 px-6 text-left whitespace-nowrap">{index + 1}</td>
                                                            <td className="py-3 px-6 text-left whitespace-nowrap">{record.date.substring(0, 10)}</td> {/* Only date part */}
                                                            <td className="py-3 px-6 text-left whitespace-nowrap">{record.clientName}</td>
                                                            <td className="py-3 px-6 text-left whitespace-nowrap">{record.loanAmount}</td>
                                                            <td className={`py-3 px-6 text-left whitespace-nowrap ${calculateLoanNetProfit(record.id) !== null && calculateLoanNetProfit(record.id) >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                                {calculateLoanNetProfit(record.id) !== null ? calculateLoanNetProfit(record.id).toFixed(2) : '待計算'}
                                                            </td> {/* Display Net Profit */}
                                                            <td className="py-3 px-6 text-left">{record.interestRate}</td>
                                                            {/* Removed Interest Rate Period */}
                                                            <td className="py-3 px-6 text-left whitespace-nowrap">{record.repaymentMethod}</td>
                                                            <td className="py-3 px-6 text-left whitespace-nowrap">{record.loanTerm || 'N/A'}</td>
                                                            <td className="py-3 px-6 text-left">
                                                                {record.status === 'pending' ? (
                                                                    <div className="flex space-x-2">
                                                                        <button
                                                                            onClick={() => updateTransactionStatus(record.id, 'completed_success')}
                                                                            className="bg-green-500 hover:bg-green-600 text-white text-xs px-2 py-1 rounded-md transition duration-200"
                                                                            disabled={loadingFirebase || !isAuthReady}
                                                                        >
                                                                            成交
                                                                        </button>
                                                                        <button
                                                                            onClick={() => updateTransactionStatus(record.id, 'completed_failure')}
                                                                            className="bg-red-500 hover:bg-red-600 text-white text-xs px-2 py-1 rounded-md transition duration-200"
                                                                            disabled={loadingFirebase || !isAuthReady}
                                                                        >
                                                                            失敗
                                                                        </button>
                                                                    </div>
                                                                ) : (
                                                                    <span className={`px-2 py-1 font-semibold leading-tight rounded-full ${record.actualOutcome === 'completed_success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                                                                        {record.actualOutcome === 'completed_success' ? '成交' : '失敗'}
                                                                    </span>
                                                                )}
                                                            </td>
                                                            {/* Removed Actual Return */}
                                                            <td className="py-3 px-6 text-left">
                                                                <div className="flex space-x-2">
                                                                    <button
                                                                        onClick={() => handleEditRecord(record)}
                                                                        className="bg-blue-500 hover:bg-blue-600 text-white text-xs px-2 py-1 rounded-md transition duration-200"
                                                                        disabled={loadingFirebase || !isAuthReady}
                                                                    >
                                                                        編輯
                                                                    </button>
                                                                    <button
                                                                        onClick={() => { setShowConfirmDeleteDialog(true); setRecordToDelete(record.id); }}
                                                                        className="bg-gray-400 hover:bg-gray-500 text-white text-xs px-2 py-1 rounded-md transition duration-200"
                                                                        disabled={loadingFirebase || !isAuthReady}
                                                                    >
                                                                        刪除
                                                                    </button>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                        <div className="mt-4 text-center text-lg font-bold">
                                            金流狀況 (淨額):
                                            <span className={`ml-2 ${parseFloat(totalActualProfitAppLevel) >= 0 ? 'text-blue-600' : 'text-red-600'}`}>
                                                ${totalActualProfitAppLevel.toFixed(2)} NTD
                                            </span>
                                        </div>
                                        {/* Updated statistics display */}
                                        <div className="mt-2 text-center text-base font-semibold text-gray-700">
                                            總出款: <span className="text-blue-700">${(totalLoanAmountSum * -1).toFixed(2)} NTD</span> | {/* Display as negative */}
                                            總收入: <span className="text-blue-700">${totalIncomingFromCashFlowsAppLevel.toFixed(2)} NTD</span> |
                                            總客戶數: <span className="text-green-700">{totalCustomers}</span>
                                        </div>
                                    </>
                                ) : (
                                    <p className="text-center text-gray-500 mt-8">
                                        沒有符合篩選條件的交易紀錄。
                                    </p>
                                )}
                            </div>
                        )}

                        {currentPage === 'cashFlowSummary' && editingRecordId && (
                            <div className="bg-white p-8 rounded-xl shadow-2xl w-full mb-8 transform transition-all duration-300 hover:scale-[1.01]">
                                <h1 className="text-3xl font-extrabold text-gray-900 mb-6 text-center">
                                    金流收支 (客戶: {transactionsHistory.find(rec => rec.id === editingRecordId)?.clientName})
                                </h1>

                                {/* Summary Statistics for Current Loan (Moved to top) */}
                                <div className="mb-8 p-6 bg-blue-50 rounded-lg shadow-inner text-center">
                                    <h2 className="text-xl font-semibold text-blue-800 mb-4">當前借款金流概覽</h2>
                                    <div className="grid grid-cols-2 gap-4 text-lg font-bold text-gray-700">
                                        <div>
                                            <p>總出款金額:</p>
                                            <span className="text-red-600 text-3xl">
                                                ${(transactionsHistory.find(rec => rec.id === editingRecordId)?.loanAmount * -1 || 0).toFixed(2)} NTD
                                            </span>
                                        </div>
                                        <div>
                                            <p>金流收入:</p>
                                            <span className="text-green-600 text-3xl">
                                                ${totalIncomingFromCashFlows.toFixed(2)} NTD
                                            </span>
                                        </div>
                                        <div className="col-span-2">
                                            <p>金流狀況 (淨額):</p>
                                            <span className={`text-4xl ${parseFloat(currentCashFlowStatus) >= 0 ? 'text-blue-600' : 'text-red-600'}`}>
                                                ${currentCashFlowStatus} NTD
                                            </span>
                                        </div>
                                        {transactionsHistory.find(rec => rec.id === editingRecordId) && (transactionsHistory.find(rec => rec.id === editingRecordId)?.repaymentMethod === '本+利' || transactionsHistory.find(rec => rec.id === editingRecordId)?.repaymentMethod === '純繳利息') && (
                                            <div className="col-span-2">
                                                <p>每期應繳金額:</p>
                                                <span className="text-purple-600 text-3xl">
                                                    ${calculateAmountDuePerPeriod(
                                                        transactionsHistory.find(rec => rec.id === editingRecordId)?.loanAmount,
                                                        transactionsHistory.find(rec => rec.id === editingRecordId)?.interestRate,
                                                        transactionsHistory.find(rec => rec.id === editingRecordId)?.loanTerm,
                                                        transactionsHistory.find(rec => rec.id === editingRecordId)?.interestRatePeriod,
                                                        transactionsHistory.find(rec => rec.id === editingRecordId)?.repaymentMethod
                                                    )} NTD
                                                </span>
                                            </div>
                                        )}
                                    </div>
                                </div>

                                {/* Cash Flow History Table (Moved to top) */}
                                <div className="mt-8">
                                    <h2 className="text-xl font-extrabold text-gray-900 mb-4 text-center">金流紀錄列表</h2>
                                    {cashFlows.length > 0 ? (
                                        <div className="overflow-x-auto">
                                            <table className="min-w-full bg-white rounded-lg shadow-md">
                                                <thead>
                                                    <tr className="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                                                        <th className="py-3 px-6 text-left">類型</th>
                                                        <th className="py-3 px-6 text-left">日期</th>
                                                        <th className="py-3 px-6 text-left">金額</th>
                                                        <th className="py-3 px-6 text-left">名目</th>
                                                        <th className="py-3 px-6 text-left">備註</th>
                                                        <th className="py-3 px-6 text-left">操作</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="text-gray-600 text-sm font-light">
                                                    {cashFlows.map(cf => (
                                                        <tr key={cf.id} className="border-b border-gray-200 hover:bg-gray-100">
                                                            <td className="py-3 px-6 text-left whitespace-nowrap">{cf.type}</td>
                                                            <td className="py-3 px-6 text-left whitespace-nowrap">{cf.date}</td>
                                                            <td className={`py-3 px-6 text-left ${cf.type === '還款' ? 'text-green-600' : 'text-red-600'}`}>
                                                                ${cf.amount.toFixed(2)}
                                                            </td>
                                                            <td className="py-3 px-6 text-left whitespace-nowrap">{cf.item}</td>
                                                            <td className="py-3 px-6 text-left">{cf.notes}</td>
                                                            <td className="py-3 px-6 text-left">
                                                                <button
                                                                    onClick={() => handleDeleteCashFlowRecord(cf.id)}
                                                                    className="bg-gray-400 hover:bg-gray-500 text-white text-xs px-2 py-1 rounded-md transition duration-200"
                                                                >
                                                                    刪除
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    ) : (
                                        <p className="text-center text-gray-500 mt-4">
                                            此客戶目前沒有金流紀錄。
                                        </p>
                                    )}
                                </div>

                                {/* Add New Cash Flow Record (Moved to top) */}
                                <div className="mb-8 p-6 bg-gray-100 rounded-lg shadow-inner mt-8">
                                    <h2 className="text-xl font-semibold text-gray-800 mb-4">新增金流紀錄</h2>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <label htmlFor="newCashFlowType" className="block text-gray-700 text-sm font-semibold mb-2">
                                                類型:
                                            </label>
                                            <select
                                                id="newCashFlowType"
                                                value={newCashFlowType}
                                                onChange={(e) => setNewCashFlowType(e.target.value)}
                                                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800"
                                            >
                                                {managedCashFlowTypes.map(type => (
                                                    <option key={type} value={type}>{type}</option>
                                                ))}
                                            </select>
                                        </div>
                                        <div>
                                            <label htmlFor="newCashFlowDate" className="block text-gray-700 text-sm font-semibold mb-2">
                                                日期:
                                            </label>
                                            <input
                                                type="date"
                                                id="newCashFlowDate"
                                                value={newCashFlowDate}
                                                onChange={(e) => setNewCashFlowDate(e.target.value)}
                                                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800"
                                            />
                                        </div>
                                        <div>
                                            <label htmlFor="newCashFlowAmount" className="block text-gray-700 text-sm font-semibold mb-2">
                                                金額 (NTD):
                                            </label>
                                            <input
                                                type="number"
                                                id="newCashFlowAmount"
                                                value={newCashFlowAmount}
                                                onChange={(e) => setNewCashFlowAmount(e.target.value)}
                                                placeholder="例如: 1000"
                                                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800"
                                            />
                                        </div>
                                        <div>
                                            <label htmlFor="newCashFlowItem" className="block text-gray-700 text-sm font-semibold mb-2">
                                                名目:
                                            </label>
                                            <select
                                                id="newCashFlowItem"
                                                value={newCashFlowItem}
                                                onChange={(e) => setNewCashFlowItem(e.target.value)}
                                                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800"
                                            >
                                                {managedCashFlowItems.map(item => (
                                                    <option key={item} value={item}>{item}</option>
                                                ))}
                                            </select>
                                        </div>
                                        <div className="md:col-span-2">
                                            <label htmlFor="newCashFlowNotes" className="block text-gray-700 text-sm font-semibold mb-2">
                                                備註:
                                            </label>
                                            <textarea
                                                id="newCashFlowNotes"
                                                value={newCashFlowNotes}
                                                onChange={(e) => setNewCashFlowNotes(e.target.value)}
                                                placeholder="例如: 繳交第一期利息"
                                                rows="2"
                                                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800"
                                            ></textarea>
                                        </div>
                                    </div>
                                    <button
                                        onClick={handleSaveCashFlowRecord}
                                        className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75"
                                        disabled={loadingFirebase || !isAuthReady}
                                    >
                                        新增金流
                                    </button>
                                </div>

                                {/* Return to client list button */}
                                <div className="mt-8 text-center">
                                    <button
                                        onClick={() => setCurrentPage('clientList')}
                                        className="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75"
                                    >
                                        返回客戶列表
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                    {/* Copyright notice at the bottom */}
                    <div className="w-full text-center text-gray-600 text-sm mt-8 pb-4">
                        威爾設計版權所有 ver {currentVersion}
                        <button
                            onClick={() => setShowUpdateLogModal(true)}
                            className="ml-2 px-2 py-1 bg-gray-200 hover:bg-gray-300 text-gray-700 text-xs rounded-full transition duration-200"
                        >
                            更新紀錄
                        </button>
                    </div>

                    {/* Update Log Modal */}
                    {showUpdateLogModal && (
                        <div className="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4">
                            <div className="bg-white p-6 rounded-lg shadow-xl max-w-md w-full max-h-[80vh] overflow-y-auto">
                                <h2 className="text-2xl font-bold text-gray-900 mb-4 text-center">更新紀錄</h2>
                                {versionHistoryData.map((v, i) => (
                                    <div key={v.version} className={`mb-4 pb-4 ${i < versionHistoryData.length - 1 ? 'border-b border-gray-200' : ''}`}>
                                        <p className="text-lg font-semibold text-blue-700">版本: {v.version}</p>
                                        <p className="text-sm text-gray-500 mb-2">日期: {v.date}</p>
                                        <p className="text-gray-700">{v.content}</p>
                                    </div>
                                ))}
                                <div className="text-center mt-4">
                                    <button
                                        onClick={() => setShowUpdateLogModal(false)}
                                        className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200"
                                    >
                                        關閉
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Mount the React app to the root div
        const domContainer = document.querySelector('#root');
        const root = ReactDOM.createRoot(domContainer);
        root.render(<FinancialCRM />);
    </script>
</body>
</html>
