<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>金融業客戶關係管理系統 (CRM)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Define custom colors for Red and White style */
        :root {
            --red-white-primary: #E53E3E; /* Bright Red */
            --red-white-light: #FFEBEE;   /* Very light red for backgrounds */
            --red-white-text-dark: #212121;    /* Dark gray for text */
            --red-white-gray-light: #F7F7F7;   /* Very light gray for subtle backgrounds */
            --red-white-medium-gray: #B0BEC5;  /* Medium gray for secondary elements */
            --red-white-accent-dark: #C53030; /* Darker red for accents/hover */
            --red-white-border-color: #CFD8DC; /* Light gray for borders */

            /* Standard colors for status/values (kept for financial clarity) */
            --status-success: #28a745; /* Green for positive */
            --status-failure: #dc3545; /* Red for negative */
            --status-pending: #ffc107; /* Yellow for pending */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--red-white-gray-light); /* Overall light background */
            color: var(--red-white-text-dark);
        }

        /* Adjust default Tailwind styling for inputs and selects for a cleaner look */
        input:not([type="checkbox"]):not([type="radio"]), select, textarea {
            border-radius: 0.5rem; /* Slightly rounded corners */
            border: 1px solid var(--red-white-border-color); /* Lighter border color */
            background-color: white;
            padding: 0.75rem 1rem; /* More padding */
            font-size: 0.95rem;
            color: var(--red-white-text-dark); /* Ensure text color is dark */
            transition: all 0.2s ease-in-out;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--red-white-primary);
            box-shadow: 0 0 0 3px rgba(229, 62, 62, 0.2); /* Subtle red focus ring */
            outline: none; /* Remove default outline */
        }

        /* Custom button styles for Red and White look */
        .btn-primary {
            background-color: var(--red-white-primary);
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease-in-out, transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            border: 1px solid var(--red-white-primary);
        }
        .btn-primary:hover {
            background-color: var(--red-white-accent-dark); /* Darker red on hover */
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        }
        .btn-primary:focus {
            outline: none;
            box-shadow: 0 0 0 4px rgba(229, 62, 62, 0.3);
        }

        .btn-secondary {
            background-color: var(--red-white-medium-gray);
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease-in-out, transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--red-white-medium-gray);
        }
        .btn-secondary:hover {
            background-color: #90A4AE; /* Darker gray on hover */
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-secondary:focus {
            outline: none;
            box-shadow: 0 0 0 4px rgba(176, 190, 197, 0.5);
        }

        .btn-danger {
            background-color: var(--status-failure); /* Red */
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease-in-out, transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--status-failure);
        }
        .btn-danger:hover {
            background-color: #c82333; /* Darker red on hover */
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        .btn-danger:focus {
            outline: none;
            box-shadow: 0 0 0 4px rgba(211, 47, 47, 0.3);
        }

        /* Specific styles for success/failure/pending badges */
        .success-badge { background-color: var(--status-success); color: white; font-weight: 600; border-radius: 9999px; padding: 0.35rem 1rem; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .failure-badge { background-color: var(--status-failure); color: white; font-weight: 600; border-radius: 9999px; padding: 0.35rem 1rem; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .pending-badge { background-color: var(--status-pending); color: var(--red-white-text-dark); font-weight: 600; border-radius: 9999px; padding: 0.35rem 1rem; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }

        /* General card/container styling */
        .card {
            background-color: white;
            border-radius: 0.75rem; /* More rounded cards */
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1); /* Clearer, more defined shadow */
            padding: 2.5rem; /* More padding */
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            border: 1px solid var(--red-white-border-color);
        }
        .card:hover {
            transform: translateY(-4px); /* Subtle lift */
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15); /* Deeper shadow on hover */
        }

        /* Header specific styling */
        .app-header {
            background-color: var(--red-white-primary);
            color: white;
            padding: 1rem 2rem;
            border-radius: 0.75rem; /* Slightly rounded header */
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.25);
            font-weight: 700;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.75rem;
        }
        .app-header .user-info {
            display: flex;
            align-items: center;
            font-size: 0.95rem;
        }
        .app-header button {
            background-color: rgba(255, 255, 255, 0.15); /* More subtle white */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .app-header button:hover {
            background-color: rgba(255, 255, 255, 0.25);
            transform: translateY(-1px);
        }
        .app-header .settings-button {
            background-color: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 0.6rem;
            border-radius: 0.375rem; /* Square-ish button */
        }
        .app-header .settings-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: scale(1.05); /* Simple scale, no rotation */
        }

        /* Table styling */
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            overflow: hidden;
        }
        table thead tr {
            background-color: var(--red-white-primary);
            color: white;
            text-transform: uppercase;
            font-size: 0.9rem;
            letter-spacing: 0.05em;
        }
        table th, table td {
            padding: 14px 28px;
            text-align: left;
            border-bottom: 1px solid var(--red-white-border-color);
        }
        table th:first-child { border-top-left-radius: 0.5rem; }
        table th:last-child { border-top-right-radius: 0.5rem; }
        table tbody tr:last-child td:first-child { border-bottom-left-radius: 0.5rem; }
        table tbody tr:last-child td:last-child { border-bottom-right-radius: 0.5rem; }

        table tbody tr:hover {
            background-color: #f2f2f2; /* Light gray hover for table rows */
        }

        /* Specific styles for action buttons in table cells */
        .table-action-button {
            font-weight: 600;
            padding: 0.35rem 0.75rem; /* Smaller padding */
            border-radius: 0.375rem; /* Consistent border-radius */
            transition: all 0.2s ease-in-out;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            border: 1px solid transparent; /* Default transparent border */
            color: white; /* Default white text for action buttons */
        }

        .table-action-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        /* Override specific button colors for clarity */
        .btn-edit {
            background-color: #2196F3; /* Blue for edit */
            border-color: #2196F3;
        }
        .btn-edit:hover {
            background-color: #1976D2;
        }

        .btn-delete {
            background-color: #F44336; /* Red for delete */
            border-color: #F44336;
        }
        .btn-delete:hover {
            background-color: #D32F2F;
        }

        .btn-cashflow {
            background-color: var(--red-white-primary); /* Primary red for cash flow */
            border-color: var(--red-white-primary);
        }
        .btn-cashflow:hover {
            background-color: var(--red-white-accent-dark);
        }

        .btn-event {
            background-color: var(--red-white-medium-gray); /* Gray for event */
            color: white; /* White text for gray button */
            border-color: var(--red-white-medium-gray);
        }
        .btn-event:hover {
            background-color: #90A4AE;
        }

        /* Styles for the "成交" / "失敗" buttons in "實際結果" column */
        .outcome-action-button {
            font-weight: 600;
            padding: 0.35rem 0.75rem;
            border-radius: 0.375rem;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            border: 1px solid transparent;
            color: white !important; /* Ensure text is white for visibility */
        }

        .outcome-action-button.success {
            background-color: var(--status-success) !important; /* Force background color */
            border-color: var(--status-success);
        }
        .outcome-action-button.success:hover {
            background-color: #388E3C !important;
        }

        .outcome-action-button.failure {
            background-color: var(--status-failure) !important; /* Force background color */
            border-color: var(--status-failure);
        }
        .outcome-action-button.failure:hover {
            background-color: #C62828 !important;
        }

        /* Marquee specific styles */
        .marquee-container {
            overflow: hidden;
            white-space: nowrap;
            box-sizing: border-box;
            background-color: var(--red-white-light); /* Light red background for marquee */
            border: 1px solid var(--red-white-border-color);
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            margin-bottom: 1rem;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }

        .marquee-text {
            display: inline-block;
            padding-left: 100%; /* Start off-screen to the right */
            animation: marquee 15s linear infinite; /* Adjust time for speed */
            color: var(--red-white-text-dark);
            font-weight: 500;
        }

        @keyframes marquee {
            0% { transform: translate(0, 0); }
            100% { transform: translate(-100%, 0); }
        }


        /* Print specific styles */
        @media print {
            body > *:not(#print-area) {
                display: none !important;
            }
            #print-area {
                display: block !important;
                width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            #print-area table {
                width: 100%;
                border-collapse: collapse;
            }
            #print-area th, #print-area td {
                border: 1px solid #ddd;
                padding: 8px;
                text-align: left;
            }
            #print-area h2 {
                text-align: center;
                margin-bottom: 20px;
            }
            .success-text { color: #16A34A; font-weight: bold; }
            .failure-text { color: #DC2626; font-weight: bold; }
            .blue-text { color: #2563EB; font-weight: bold; }
            .red-text { color: #DC2626; font-weight: bold; }
            .outcome-badge {
                display: inline-block;
                padding: 4px 8px;
                border-radius: 9999px;
                font-weight: 600;
                font-size: 0.8em;
                line-height: 1;
            }
            .success-badge { background-color: #D1FAE5; color: #065F46; }
            .failure-badge { background-color: #FEE2E2; color: #991B1B; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        // Import Firebase modules from CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expose Firebase services to the window object for React to access
        // This is necessary because React is loaded via UMD, not as a module.
        window.firebase = {
            initializeApp,
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged,
            GoogleAuthProvider,
            signInWithPopup,
            signOut,
            getFirestore,
            doc,
            getDoc,
            addDoc,
            setDoc,
            updateDoc,
            deleteDoc,
            onSnapshot,
            collection,
            query,
            where,
            getDocs,
            serverTimestamp // Added serverTimestamp
        };
    </script>

    <script>
        // ====================================================================================================
        // *** 重要：請務必將以下 Firebase 配置替換為您自己專案的真實數值！ ***
        // 您可以在 Firebase Console -> 專案設定 (齒輪圖示) -> 「您的應用程式」中找到它。
        // 請確保複製的是完整的 JavaScript 物件，例如：{ apiKey: "...", authDomain: "...", ... }
        // 注意：不要在 JSON.stringify() 內部再加額外的引號，例如 JSON.stringify("{ ... }") 是錯誤的。
        // ====================================================================================================
        const __firebase_config = JSON.stringify({
          apiKey: "AIzaSyD1HulbSZpgpNFVQvmhd7GYUCUx6-7dn9s",
          authDomain: "money-5afb9.firebaseapp.com",
          projectId: "money-5afb9",
          storageBucket: "money-5afb9.firebasestorage.app",
          messagingSenderId: "136016647296",
          appId: "1:136016647296:web:fb8be3f22148e230cec265"
        });

        // *** 重要：請自訂一個唯一的應用程式 ID，如果不在 Canvas 環境中運行 ***
        // 這個 ID 必須與您在 Firestore 安全規則中使用的 {appId} 變數完全相符。
        // 建議與您的 Firebase Project ID 相同，以保持一致性。
        const __app_id = "money-5afb9"; // 使用您提供的 projectId 作為 app_id

        // 這是 Canvas 環境特有的初始認證 Token。
        // 在您本地運行或使用 GitHub Pages 時，此變數通常保持為空字串或移除。
        // 應用程式會自動回退到匿名登入。
        const __initial_auth_token = "";
        // ====================================================================================================
        // *** 上述配置替換完畢後，請儲存檔案並重新上傳到您的託管平台！ ***
        // ====================================================================================================
    </script>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>


    <script type="text/babel">
        // Helper function to get today's date inYYYY-MM-DD format
        const getTodayDateString = () => {
            const today = new Date();
            const year = today.getFullYear();
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            const day = today.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        // CRM-specific advice messages (Not currently used in the UI, but good for future expansion)
        const transactionSuccessAdvice = [
            "恭喜！客戶滿意度是您最大的資產。",
            "持續為客戶創造價值，建立長期信任關係。",
            "您的專業和努力得到了回報，繼續保持！",
            "謹慎管理客戶關係，讓成功持續增長。",
            "祝您客戶源源不絕，業績長紅！",
        ];

        const transactionFailureAdvice = [
            "別氣餒，每一次挫折都是學習的機會。",
            "重新檢視客戶需求，找出可以改進的地方。",
            "控制風險是首要任務，保護您的客戶關係。",
            "暫時休息一下，讓思緒沉澱再出發。",
            "分析失利原因，避免重蹈覆轍。",
            "調整心態，堅持理性判斷。",
        ];

        const transactionNeutralAdvice = [
            "客戶關係維護良好，持續觀察市場機會。",
            "保持耐心，客戶關係的建立需要時間。",
            "這是一個穩定的階段，可以考慮微調服務策略。",
            "持續提供優質服務，等待更好的合作機會。",
        ];

        function FinancialCRM() {
            // State variables for Firebase and authentication
            const [db, setDb] = React.useState(null);
            const [auth, setAuth] = React.useState(null);
            const [userId, setUserId] = React.useState(null);
            const [userName, setUserName] = React.useState(null);
            const [userEmail, setUserEmail] = React.useState(null);
            const [isAuthReady, setIsAuthReady] = React.useState(false);
            const [loadingFirebase, setLoadingFirebase] = React.useState(true);

            // State variables for client and transaction input fields
            const [clientName, setClientName] = React.useState('');
            const [loanAmount, setLoanAmount] = React.useState(''); // 借款金額
            const [interestRate, setInterestRate] = React.useState(''); // 利率
            const [interestRatePeriod, setInterestRatePeriod] = React.useState('年'); // 利率週期 (年/月/日)
            const [repaymentMethod, setRepaymentMethod] = React.useState('本+利'); // 還款方式
            const [loanTerm, setLoanTerm] = React.useState(''); // 期數
            const [notes, setNotes] = React.useState(''); // 備註

            // New client detail fields
            const [contactMethod, setContactMethod] = React.useState(''); // 聯絡方式
            const [homePhone, setHomePhone] = React.useState(''); // 住宅電話
            const [lineId, setLineId] = React.useState(''); // Line ID
            const [facebook, setFacebook] = React.useState(''); // FB
            const [instagram, setInstagram] = React.useState(''); // IG
            const [idNumber, setIdNumber] = React.useState(''); // 身分證字號
            const [birthday, setBirthday] = React.useState(''); // 生日
            const [address, setAddress] = React.useState(''); // 住址
            const [residentialArea, setResidentialArea] = React.useState(''); // 居住地
            const [occupation, setOccupation] = React.useState(''); // 職業
            const [companyPhone, setCompanyPhone] = React.useState(''); // 公司電話
            const [companyAddress, setCompanyAddress] = React.useState(''); // 公司地址
            const [disbursementNotes, setDisbursementNotes] = React.useState(''); // 出款備註
            const [emergencyContact1Name, setEmergencyContact1Name] = React.useState(''); // 緊急聯絡人1
            const [emergencyContact1Phone, setEmergencyContact1Phone] = React.useState(''); // 緊急聯絡人1電話
            const [emergencyContact2Name, setEmergencyContact2Name] = React.useState(''); // 緊急聯絡人2
            const [emergencyContact2Phone, setEmergencyContact2Phone] = React.useState(''); // 緊急聯絡人2電話
            const [loanDate, setLoanDate] = React.useState(getTodayDateString()); // 新增：借款日期

            const [projectedReturn, setProjectedReturn] = React.useState(null); // 預期報酬 (年利息參考)
            const [errorMessage, setErrorMessage] = React.useState('');
            const [transactionsHistory, setTransactionsHistory] = React.useState([]); // All client transactions

            // Cash Flow states for the current transaction
            const [cashFlows, setCashFlows] = React.useState([]); // 金流紀錄列表
            // Removed newCashFlowType state and its dropdown/custom input
            const [newCashFlowDate, setNewCashFlowDate] = React.useState(getTodayDateString()); // 金流日期
            const [newCashFlowAmount, setNewCashFlowAmount] = React.useState(''); // 金流金額
            const [newCashFlowItem, setNewCashFlowItem] = React.useState('本金+利息'); // 金流名目
            const [newCashFlowNotes, setNewCashFlowNotes] = React.useState(''); // 金流備註

            // State for custom cash flow items (type is now inferred from amount)
            const [customCashFlowItemInput, setCustomCashFlowItemInput] = React.useState('');
            // Kept managedCashFlowTypes for consistency in Firestore, but it's not used in UI for new entry
            const [managedCashFlowTypes, setManagedCashFlowTypes] = React.useState(['出款', '還款']);
            const [managedCashFlowItems, setManagedCashFlowItems] = React.useState(['本金+利息', '本金', '利息', '其他']); // 金流名目

            // Event History states for the current transaction
            const [eventHistoryRecords, setEventHistoryRecords] = React.useState([]); // 事件紀錄列表
            const [newEventDate, setNewEventDate] = React.useState(getTodayDateString()); // 事件日期
            const [newEventType, setNewEventType] = React.useState(''); // 事件類型
            const [newEventNotes, setNewEventNotes] = React.useState(''); // 事件備註
            const [showEventHistoryModal, setShowEventHistoryModal] = React.useState(false); // 控制事件紀錄彈窗顯示

            // Modals and editing states
            const [showConfirmDeleteDialog, setShowConfirmDeleteDialog] = React.useState(false);
            const [recordToDelete, setRecordToDelete] = React.useState(null);
            const [editingRecordId, setEditingRecordId] = React.useState(null); // ID of the transaction being edited or viewed for cash flow/events

            // Page navigation state
            const [currentPage, setCurrentPage] = React.useState('clientList'); // 'clientList', 'addClient', 'cashFlowSummary', 'eventHistory'
            const [showChart, setShowChart] = React.useState(false); // State to toggle chart visibility
            const chartRef = React.useRef(null); // Ref for Chart.js instance

            // Marquee content state
            const [marqueeContents, setMarqueeContents] = React.useState(['', '', '']); // State for 3 marquee contents

            // Version history data for the update log modal
            const versionHistoryData = [
                {
                    version: "1.20.1",
                    date: "2025-06-01",
                    content: "修正 Firebase 文件路徑錯誤 (Invalid document reference)。統一使用者設定儲存至 `settings/mainSettings` 文件，並更新結果類型和跑馬燈內容的讀寫邏輯。修正表格內「實際結果」及「操作」按鈕在未懸停時不可見的問題，確保所有按鈕都有明確的背景色和文字對比度。新增統計圖表功能，顯示選定年月份的總出款、總收入、金流狀況趨勢。",
                },
                {
                    version: "1.20.0",
                    date: "2025-06-01",
                    content: "修正 Firebase 文件路徑錯誤 (Invalid document reference)。統一使用者設定儲存至 `settings/mainSettings` 文件，並更新結果類型和跑馬燈內容的讀寫邏輯。修正表格內「實際結果」及「操作」按鈕在未懸停時不可見的問題，確保所有按鈕都有明確的背景色和文字對比度。新增統計圖表功能，顯示選定年月份的總出款、總收入、金流狀況趨勢。",
                },
                {
                    version: "1.19.2",
                    date: "2025-06-01",
                    content: "修正 Chart.js 顏色配置的語法錯誤。修正表格內「實際結果」及「操作」按鈕在未懸停時不可見的問題，確保所有按鈕都有明確的背景色和文字對比度。新增統計圖表功能，顯示選定年月份的總出款、總收入、金流狀況趨勢。設定頁面調整：結果類型管理部分不再預設新增「成交」、「失敗」、「待定」選項。首頁新增跑馬燈功能，內容可在設定頁中編輯。",
                },
                {
                    version: "1.19.1",
                    date: "2025-06-01",
                    content: "修正 Chart.js 顏色配置的語法錯誤。修正表格內「實際結果」及「操作」按鈕在未懸停時不可見的問題，確保所有按鈕都有明確的背景色和文字對比度。新增統計圖表功能，顯示選定年月份的總出款、總收入、金流狀況趨勢。設定頁面調整：結果類型管理部分不再預設新增「成交」、「失敗」、「待定」選項。首頁新增跑馬燈功能，內容可在設定頁中編輯。",
                },
                {
                    version: "1.19.0",
                    date: "2025-06-01",
                    content: "介面風格調整為紅白配色，採用鮮明紅色作為主色調，搭配白色和中性灰色。修正 Chart.js 顏色配置的語法錯誤。修正表格內「實際結果」及「操作」按鈕在未懸停時不可見的問題，確保所有按鈕都有明確的背景色和文字對比度。新增統計圖表功能，顯示選定年月份的總出款、總收入、金流狀況趨勢。",
                },
                {
                    version: "1.18.1",
                    date: "2025-06-01",
                    content: "修正 Chart.js 顏色配置的語法錯誤。修正表格內「實際結果」及「操作」按鈕在未懸停時不可見的問題，確保所有按鈕都有明確的背景色和文字對比度。新增統計圖表功能，顯示選定年月份的總出款、總收入、金流狀況趨勢。",
                },
                {
                    version: "1.18.0",
                    date: "2025-06-01",
                    content: "修正表格內「實際結果」及「操作」按鈕在未懸停時不可見的問題，確保所有按鈕都有明確的背景色和文字對比度。新增統計圖表功能，顯示選定年月份的總出款、總收入、金流狀況趨勢。",
                },
                {
                    version: "1.17.2",
                    date: "2025-06-01",
                    content: "修正表格內「實際結果」及「操作」按鈕在未懸停時不可見的問題，確保所有按鈕都有明確的背景色和文字對比度。",
                },
                {
                    version: "1.17.1",
                    date: "2025-06-01",
                    content: "金流數字顯示優化：客戶列表總覽區塊的「總出款」固定顯示紅色，「總淨利」根據正負值顯示綠色或紅色。金流收支頁面總覽區塊的「總出款金額」和「金流收入」固定顯示紅/綠色，「金流狀況 (淨額)」根據正負值顯示主要深色或紅色。修正「實際結果」按鈕和表格內操作按鈕的配色，使其更清晰可見。",
                },
                {
                    version: "1.17.0",
                    date: "2025-06-01",
                    content: "介面風格調整為合作金庫風格，採用深綠色主色調，搭配專業穩重的設計元素。金流數字顯示優化：客戶列表總覽區塊的「總出款」固定顯示紅色，「總淨利」根據正負值顯示綠色或紅色。金流收支頁面總覽區塊的「總出款金額」和「金流收入」固定顯示紅/綠色，「金流狀況 (淨額)」根據正負值顯示主要深色或紅色。修正「實際結果」按鈕在未懸停時不可見的問題，並統一調整表格內操作按鈕的配色，使其更符合工業風格且清晰可見。",
                },
                {
                    version: "1.16.3",
                    date: "2025-06-01",
                    content: "金流數字顯示優化：客戶列表總覽區塊的「總出款」固定顯示紅色，「總淨利」根據正負值顯示綠色或紅色。金流收支頁面總覽區塊的「總出款金額」和「金流收入」固定顯示紅/綠色，「金流狀況 (淨額)」根據正負值顯示主要深色或紅色。修正「實際結果」按鈕在未懸停時不可見的問題，並統一調整表格內操作按鈕的配色，使其更符合工業風格且清晰可見。",
                },
                {
                    version: "1.16.2",
                    date: "2025-06-01",
                    content: "金流數字顯示優化：客戶列表總覽區塊的「總出款」固定顯示紅色，「總淨利」根據正負值顯示綠色或紅色。金流收支頁面總覽區塊的「總出款金額」和「金流收入」固定顯示紅/綠色，「金流狀況 (淨額)」根據正負值顯示主要深色或紅色。修正「實際結果」按鈕在未懸停時不可見的問題，並統一調整表格內操作按鈕的配色，使其更符合工業風格且清晰可見。",
                },
                {
                    version: "1.16.1",
                    date: "2025-06-01",
                    content: "修正「實際結果」按鈕在未懸停時不可見的問題，並統一調整表格內操作按鈕的配色，使其更符合工業風格且清晰可見。",
                },
                {
                    version: "1.16.0",
                    date: "2025-06-01",
                    content: "介面風格調整為工業風，採用深色、中性灰和金屬色調，按鈕和卡片設計更為方正、堅固。金流紀錄列表排序改為日期升序（最後輸入的項目在最下方）。新增金流紀錄頁面：移除「類型」下拉式選單，類型依金額正負自動判斷；「名目」保留自訂功能。客戶列表下方新增年月份篩選器，篩選客戶交易紀錄並更新統計數據。",
                },
                {
                    version: "1.15.0",
                    date: "2025-06-01",
                    content: "介面風格調整為年輕化風格，採用全新色彩主題，強化圓潤設計語言，增加動態互動效果，並優化排版。金流紀錄列表排序改為日期升序（最後輸入的項目在最下方）。新增金流紀錄頁面：移除「類型」下拉式選單，類型依金額正負自動判斷；「名目」保留自訂功能。客戶列表下方新增年月份篩選器，篩選客戶交易紀錄並更新統計數據。",
                },
                {
                    version: "1.14.0",
                    date: "2025-06-01",
                    content: "介面風格調整為中國信託網站風格，強化主色調應用、優化背景與卡片設計、統一按鈕與輸入框風格、強調重要資訊。金流紀錄列表排序改為日期升序（最後輸入的項目在最下方）。新增金流紀錄頁面：移除「類型」下拉式選單，類型依金額正負自動判斷；「名目」保留自訂功能。客戶列表下方新增年月份篩選器，篩選客戶交易紀錄並更新統計數據。",
                },
                {
                    version: "1.13.0",
                    date: "2025-06-01",
                    content: "介面風格調整為中國信託網站風格。金流紀錄列表排序改為日期升序（最後輸入的項目在最下方）。新增金流紀錄頁面：移除「類型」下拉式選單，類型依金額正負自動判斷；「名目」保留自訂功能。客戶列表下方新增年月份篩選器，篩選客戶交易紀錄並更新統計數據。",
                },
                {
                    version: "1.12.0",
                    date: "2025-06-01",
                    content: "金流紀錄列表排序改為日期升序（最後輸入的項目在最下方）。新增金流紀錄頁面：移除「類型」下拉式選單，類型依金額正負自動判斷；「名目」保留自訂功能。客戶列表下方新增年月份篩選器，篩選客戶交易紀錄並更新統計數據。",
                },
                {
                    version: "1.11.1",
                    date: "2025-06-01",
                    content: "修正 `managedRepaymentMethods` 未定義的錯誤。金流紀錄列表排序改為最後輸入的項目在最下方。新增金流紀錄頁面：類型與名目新增可自行輸入的欄位。客戶列表下方新增年月份篩選與現金流量概覽。",
                },
                {
                    version: "1.11.0",
                    date: "2025-06-01",
                    content: "金流紀錄列表排序改為最後輸入的項目在最下方。新增金流紀錄頁面：類型與名目新增可自行輸入的欄位。客戶列表下方新增年月份篩選與現金流量概覽。",
                },
                {
                    version: "1.10.4",
                    date: "2025-05-30",
                    content: "新增客戶頁面：加入「借款日期」欄位。客戶列表頁面：在「借款金額」與「利率」之間新增「淨額」欄位。修正 `ReferenceError` 和利息計算邏輯。",
                },
                {
                    version: "1.10.3",
                    date: "2025-05-30",
                    content: "新增客戶頁面：加入「借款日期」欄位。客戶列表頁面：在「借款金額」與「利率」之間新增「淨額」欄位。修正 `ReferenceError` 和利息計算邏輯。",
                },
                {
                    version: "1.10.2",
                    date: "2025-05-30",
                    content: "修正 `ReferenceError: outcomeTypesRef is not defined` 錯誤。修正 `emergencyContact22Name` 的打字錯誤。修正利息計算邏輯，確保利率是所選週期下的實際利率。客戶列表的「淨額」欄位現在會正確顯示「待計算」或實際淨利。",
                },
                {
                    version: "1.10.1",
                    date: "2025-05-30",
                    content: "修正 `emergencyContact22Name` 的打字錯誤。修正利息計算邏輯，確保利率是所選週期下的實際利率。客戶列表的「淨額」欄位現在會正確顯示「待計算」或實際淨利。",
                },
                {
                    version: "1.10",
                    date: "2025-05-30",
                    content: "修正 `ReferenceError: emergencyContact22Name is not defined` 錯誤。修正利息計算邏輯：現在利率將被視為所選週期下的實際利率。客戶列表新增「淨額」欄位。",
                },
                {
                    version: "1.9.9",
                    date: "2025-05-30",
                    content: "客戶列表頁面：在「借款金額」與「利率」之間新增「淨額」欄位。該欄位顯示單一客戶的淨利，並在金流紀錄更新時即時反映。",
                },
                {
                    version: "1.9.8",
                    date: "2025-05-30",
                    content: "客戶列表頁面：移除「淨利」欄位。新增客戶頁面：新增住宅電話、Line ID、FB、IG、身分證字號、生日欄位，並調整欄位佈局。",
                },
                {
                    version: "1.9.7",
                    date: "2025-05-30",
                    content: "客戶列表頁面：移除「淨利」欄位。金流紀錄列表：確認排序為最新新增的紀錄顯示在最上方。新增金流或刪除金流後，客戶列表的「淨利」欄位會即時更新。",
                },
                {
                    version: "1.9.6",
                    date: "2025-05-30",
                    content: "客戶列表頁面優化：移除「淨利」欄位。金流紀錄列表：確認排序為最新新增的紀錄顯示在最上方。",
                },
                {
                    version: "1.9.5",
                    date: "2025-05-30",
                    content: "偵錯顯示問題：確保應用程式在無資料時能正常顯示「沒有符合篩選條件的交易紀錄」訊息。優化錯誤處理和載入狀態。",
                },
                {
                    version: "1.9.4",
                    date: "2025-05-30",
                    content: "修正客戶列表未顯示紀錄問題：確認資料庫中有紀錄，並確保列表能正確載入。同步 `calculateLoanNetProfit` 邏輯，避免顯示為 0.00。",
                },
                {
                    version: "1.9.3",
                    date: "2025-05-30",
                    content: "修正客戶列表「淨利」欄位顯示為 0 的問題：確保 `updateTransactionStatus` 函數在更新主交易紀錄時，能夠正確且及時地從 Firestore 讀取所有相關金流紀錄並計算 `actualProfit`。同時，優化 `calculateLoanNetProfit` 函數，使其在 `actualProfit` 未設定時顯示「待計算」。",
                },
                {
                    version: "1.9.2",
                    date: "2025-05-30",
                    content: "修正「淨利」欄位顯示：當淨利尚未計算時，顯示「待計算」。",
                },
                {
                    version: "1.9.1",
                    date: "2025-05-30",
                    content: "解決 `ReferenceError`：將依賴 `cashFlows` 的金流計算變數包裹在 `React.useMemo` 中，確保其在渲染時可用。優化應用程式層級的總計計算。",
                },
                {
                    version: "1.9",
                    date: "2025-05-30",
                    content: "新增客戶頁面：欄位改為兩欄顯示，新增返回鍵，金流收支/事件紀錄導覽鈕上移，移除目標報酬區塊。金流收支頁面：概覽和紀錄列表上移。客戶列表頁面：新增淨利欄位，移除隨機文字。",
                },
                {
                    version: "1.8.1",
                    date: "2025-05-30",
                    content: "客戶列表頁面再次優化：新增「淨利」欄位，並調整金流狀況計算邏輯。新增客戶頁面：金流收支導覽鈕上移，新增「事件紀錄」導覽鈕，並移除「達成目標報酬所需借款額」區塊。",
                },
                {
                    version: "1.8",
                    date: "2025-05-30",
                    content: "新增客戶頁面擴充：加入聯絡方式、住址、居住地、職業、公司電話、公司地址、出款備註、緊急聯絡人1/2及其電話。新增「金流收支」導覽鈕，並在該頁面顯示總出款、總收入、金流狀況及每期應繳金額。新增金流紀錄功能，包含類型、日期、金額、名目、備註欄位。",
                },
                {
                    version: "1.7",
                    date: "2025-05-30",
                    content: "客戶列表頁面再次優化：移除日期篩選器，列表取消顯示「利率週期」和「實際報酬」欄位。「實際結果」中的「成功」改為「成交」。統計數據新增「總收入」。",
                },
                {
                    version: "1.6",
                    date: "2025-05-30",
                    content: "客戶列表頁面和導覽重構。將「客戶借貸紀錄」改為「客戶列表」，移除日期區間和各類型篩選器。將「篩選後總實際報酬」改為「金流狀況」，「篩選後總借款金額」改為「總出款」（顯示負值）。「成功交易數」改為「總客戶數」。將「新增客戶交易/互動」改為獨立的「新增客戶」頁面，並透過導覽鈕切換。",
                },
                {
                    version: "1.5",
                    date: "2025-05-30",
                    content: "客戶列表頁面優化：將「客戶借貸紀錄」改為「客戶列表」，移除多餘篩選器，並調整統計數據顯示。",
                },
                {
                    version: "1.4",
                    date: "2025-05-30",
                    content: "新增客戶交易/互動頁面改版：聯絡資訊改為借款金額，產品服務類型改為利率及利率週期，交易金額改為還款方式，並新增期數欄位。",
                },
                {
                    version: "1.3",
                    date: "2025-05-29",
                    content: "解決 Firebase 匿名認證失敗問題：提醒用戶在 Firebase Console 中啟用匿名認證。版本號更新。",
                },
                {
                    version: "1.2",
                    date: "2025-05-29",
                    content: "更新 Firebase 配置資訊，確保應用程式能正確連接到您的 Firebase 專案。",
                },
                {
                    version: "1.1",
                    date: "2025-05-29",
                    content: "修正預覽無法正常顯示問題：確保 Firebase 配置變數正確傳遞並初始化。更新版本號。",
                },
                {
                    version: "1.0",
                    date: "2025-05-29",
                    content: "初始版本：基於運彩模板改編為金融業CRM。新增客戶管理、交易紀錄、產品類型管理、互動結果追蹤及相關統計。",
                },
            ];
            const [currentVersion, setCurrentVersion] = React.useState(versionHistoryData[0].version);
            const [showUpdateLogModal, setShowUpdateLogModal] = React.useState(false);
            const [showSettingsModal, setShowSettingsModal] = React.useState(false);

            // Fixed options for dropdowns
            const [managedInterestRatePeriods, setManagedInterestRatePeriods] = React.useState(['年', '月', '日']);
            const [managedRepaymentMethods, setManagedRepaymentMethods] = React.useState(['本+利', '純繳利息']);
            const [managedOutcomeTypes, setManagedOutcomeTypes] = React.useState([]); // For settings modal, if custom outcomes are still desired
            const [newOutcomeTypeInput, setNewOutcomeTypeInput] = React.useState('');

            // State for monthly/yearly summary filter
            const currentYear = new Date().getFullYear();
            const yearOptions = Array.from({ length: 5 }, (_, i) => currentYear - i); // Current year and past 4 years
            const monthOptions = [
                { value: 'all', label: '全部月份' },
                { value: '01', label: '1月' }, { value: '02', label: '2月' }, { value: '03', label: '3月' },
                { value: '04', label: '4月' }, { value: '05', label: '5月' }, { value: '06', label: '6月' },
                { value: '07', label: '7月' }, { value: '08', label: '8月' }, { value: '09', label: '9月' },
                { value: '10', label: '10月' }, { value: '11', label: '11月' }, { value: '12', label: '12月' },
            ];
            const [selectedSummaryYear, setSelectedSummaryYear] = React.useState('all');
            const [selectedSummaryMonth, setSelectedSummaryMonth] = React.useState('all');


            // --- Firebase Initialization and Authentication ---
            React.useEffect(() => {
                const initializeFirebase = async () => {
                    try {
                        // Parse Firebase config from global variable
                        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
                        const app = window.firebase.initializeApp(firebaseConfig);
                        const authInstance = window.firebase.getAuth(app);
                        const dbInstance = window.firebase.getFirestore(app);

                        setAuth(authInstance);
                        setDb(dbInstance);

                        console.log("Firebase Config:", firebaseConfig);

                        // Listen for authentication state changes
                        const unsubscribe = window.firebase.onAuthStateChanged(authInstance, async (user) => {
                            if (user) {
                                // User is signed in
                                setUserId(user.uid);
                                setUserName(user.displayName || user.email || '匿名用戶');
                                setUserEmail(user.email);
                                console.log("User signed in:", user.uid);
                            } else {
                                // User is signed out, attempt anonymous or custom token sign-in
                                try {
                                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token !== '') {
                                        await window.firebase.signInWithCustomToken(authInstance, __initial_auth_token);
                                        console.log("Signed in with custom token.");
                                    } else {
                                        await window.firebase.signInAnonymously(authInstance);
                                        console.log("Signed in anonymously.");
                                    }
                                } catch (anonError) {
                                    console.error("Anonymous sign-in failed:", anonError);
                                    setErrorMessage("匿名登入失敗，請檢查 Firebase 認證設定或 API 金鑰。");
                                }
                            }
                            setIsAuthReady(true); // Mark authentication as ready
                            setLoadingFirebase(false); // End loading state
                        });

                        return () => unsubscribe(); // Cleanup auth listener on component unmount
                    } catch (error) {
                        console.error("Firebase initialization failed:", error);
                        setErrorMessage("Firebase 初始化失敗，請檢查設定。");
                        setLoadingFirebase(false);
                    }
                };

                initializeFirebase();
            }, []); // Empty dependency array means this effect runs once on mount

            // --- Load managed outcome types from Firestore (for settings modal) ---
            React.useEffect(() => {
                // Ensure db, auth, and userId are available before attempting to fetch
                if (!db || !isAuthReady || !userId) return;

                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                // Corrected path: userSettings is now a document, not a collection
                const userSettingsDocRef = window.firebase.doc(db, `artifacts/${appId}/users/${userId}/settings`, 'mainSettings');

                // Set up real-time listener for user settings document
                const unsubscribeUserSettings = window.firebase.onSnapshot(userSettingsDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        setManagedOutcomeTypes(data.outcomeTypes || []); // No default values here, user must add them
                        setMarqueeContents(data.marqueeContents || ['', '', '']);
                    } else {
                        // If userSettingsDoc doesn't exist, create it with empty arrays
                        window.firebase.setDoc(userSettingsDocRef, {
                            outcomeTypes: [],
                            marqueeContents: ['', '', '']
                        });
                        setManagedOutcomeTypes([]);
                        setMarqueeContents(['', '', '']);
                    }
                }, (error) => {
                    console.error("Error fetching user settings data:", error);
                });

                return () => unsubscribeUserSettings();
            }, [db, isAuthReady, userId]);

            // --- Load managed cash flow types from Firestore ---
            React.useEffect(() => {
                if (!db || !isAuthReady || !userId) return;

                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const cashFlowTypesRef = window.firebase.collection(db, `artifacts/${appId}/users/${userId}/settings/userSettings/cashFlowTypes`);

                const unsubscribeCashFlowTypes = window.firebase.onSnapshot(cashFlowTypesRef, (snapshot) => {
                    const types = snapshot.docs.map(doc => doc.id);
                    // Add default types if they are not already present
                    const defaultTypes = ['出款', '還款'];
                    const combinedTypes = [...new Set([...defaultTypes, ...types])]; // Use Set to ensure uniqueness
                    setManagedCashFlowTypes(combinedTypes.sort());
                }, (error) => {
                    console.error("Error fetching cash flow types:", error);
                });

                return () => unsubscribeCashFlowTypes();
            }, [db, isAuthReady, userId]);

            // --- Load managed cash flow items from Firestore ---
            React.useEffect(() => {
                if (!db || !isAuthReady || !userId) return;

                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const cashFlowItemsRef = window.firebase.collection(db, `artifacts/${appId}/users/${userId}/settings/userSettings/cashFlowItems`);

                const unsubscribeCashFlowItems = window.firebase.onSnapshot(cashFlowItemsRef, (snapshot) => {
                    const items = snapshot.docs.map(doc => doc.id);
                    // Add default items if they are not already present
                    const defaultItems = ['本金+利息', '本金', '利息', '其他'];
                    const combinedItems = [...new Set([...defaultItems, ...items])]; // Use Set to ensure uniqueness
                    setManagedCashFlowItems(combinedItems.sort());
                }, (error) => {
                    console.error("Error fetching cash flow items:", error);
                });

                return () => unsubscribeCashFlowItems();
            }, [db, isAuthReady, userId]);

            // --- Load cash flow records for the currently edited transaction ---
            React.useEffect(() => {
                // Only fetch if db, auth is ready, a user is logged in, a record is being edited, and on the cash flow summary page
                if (!db || !isAuthReady || !userId || !editingRecordId || currentPage !== 'cashFlowSummary') {
                    setCashFlows([]); // Clear cash flows if conditions are not met
                    return;
                }

                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                // Construct the Firestore collection reference for cash flows of the specific transaction
                const cashFlowsCollectionRef = window.firebase.collection(db, `artifacts/${appId}/users/${userId}/transactions/${editingRecordId}/cashFlows`);

                // Set up real-time listener for cash flow records
                const unsubscribeCashFlows = window.firebase.onSnapshot(cashFlowsCollectionRef, (snapshot) => {
                    const records = [];
                    snapshot.forEach(doc => {
                        records.push({ id: doc.id, ...doc.data() });
                    });
                    // Sort cash flow records by date (oldest first) - last entered item at the bottom
                    records.sort((a, b) => {
                        const dateA = new Date(a.date.replace(/-/g, '/')).getTime();
                        const dateB = new Date(b.date.replace(/-/g, '/')).getTime();
                        return dateA - dateB; // Oldest first (ascending order)
                    });
                    setCashFlows(records);
                }, (error) => {
                    console.error("Error fetching cash flow data:", error);
                    setErrorMessage("無法載入金流紀錄。");
                });

                return () => unsubscribeCashFlows(); // Cleanup listener
            }, [db, isAuthReady, userId, editingRecordId, currentPage]); // Re-fetch when editingRecordId or currentPage changes

            // --- Load event history records for the currently edited transaction ---
            React.useEffect(() => {
                // Only fetch if db, auth is ready, a user is logged in, a record is being edited, and the event history modal is open
                if (!db || !isAuthReady || !userId || !editingRecordId || !showEventHistoryModal) {
                    setEventHistoryRecords([]); // Clear event history if conditions are not met
                    return;
                }

                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                // Construct the Firestore collection reference for event history of the specific transaction
                const eventsCollectionRef = window.firebase.collection(db, `artifacts/${appId}/users/${userId}/transactions/${editingRecordId}/events`);

                // Set up real-time listener for event history records
                const unsubscribeEvents = window.firebase.onSnapshot(eventsCollectionRef, (snapshot) => {
                    const records = [];
                    snapshot.forEach(doc => {
                        records.push({ id: doc.id, ...doc.data() });
                    });
                    // Sort event history records by date (newest first)
                    records.sort((a, b) => {
                        const dateA = new Date(a.date.replace(/-/g, '/')).getTime();
                        const dateB = new Date(b.date.replace(/-/g, '/')).getTime();
                        return dateB - dateA; // Newest first
                    });
                    setEventHistoryRecords(records);
                }, (error) => {
                    console.error("Error fetching event history data:", error);
                    setErrorMessage("無法載入事件紀錄。");
                });

                return () => unsubscribeEvents(); // Cleanup listener
            }, [db, isAuthReady, userId, editingRecordId, showEventHistoryModal]);


            // Handles Google Sign-In
            const handleGoogleSignIn = async () => {
                setErrorMessage('');
                if (!auth) {
                    setErrorMessage("認證服務未準備好。");
                    return;
                }
                try {
                    const provider = new window.firebase.GoogleAuthProvider();
                    await window.firebase.signInWithPopup(auth, provider);
                } catch (error) {
                    console.error("Google Sign-In failed:", error);
                    let msg = "Google 登入失敗。";
                    if (error.code === 'auth/popup-closed-by-user') {
                        msg = "Google 登入視窗已關閉。";
                    } else if (error.code === 'auth/cancelled-popup-request') {
                        msg = "已取消先前的登入請求。";
                    } else if (error.code === 'auth/unauthorized-domain') {
                        msg = "未授權的網域。請在 Firebase Console 中新增您的網域。";
                    }
                    setErrorMessage(msg + " 請檢查 Firebase 認證設定。");
                }
            };

            // Handles user sign-out
            const handleSignOut = async () => {
                setErrorMessage('');
                if (!auth) {
                    setErrorMessage("認證服務未準備好。");
                    return;
                }
                try {
                    await window.firebase.signOut(auth);
                    setUserId(null);
                    setUserName(null);
                    setUserEmail(null);
                    setTransactionsHistory([]); // Clear history on sign out
                } catch (error) {
                    console.error("Sign Out failed:", error);
                    setErrorMessage("登出失敗。");
                }
            };

            // --- Load all client transactions history from Firestore ---
            React.useEffect(() => {
                // Ensure db, auth is ready, and userId is available before attempting to fetch
                if (!db || !isAuthReady || !userId) {
                    // If not ready or signed out, clear transactions history
                    if (transactionsHistory.length > 0) {
                        setTransactionsHistory([]);
                    }
                    return;
                }

                let unsubscribe;
                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    // Construct the Firestore collection reference for all user transactions
                    const transactionsCollectionRef = window.firebase.collection(db, `artifacts/${appId}/users/${userId}/transactions`);

                    // Set up real-time listener for transactions
                    unsubscribe = window.firebase.onSnapshot(transactionsCollectionRef, (snapshot) => {
                        const records = [];
                        snapshot.forEach(doc => {
                            records.push({ id: doc.id, ...doc.data() });
                        });
                        // Sort transactions by timestamp (newest first)
                        records.sort((a, b) => {
                            const timeA = a.timestamp ? (a.timestamp.toDate ? a.timestamp.toDate().getTime() : a.timestamp) : 0;
                            const timeB = b.timestamp ? (b.timestamp.toDate ? b.timestamp.toDate().getTime() : b.timestamp) : 0;
                            return timeB - timeA; // Newest first
                        });
                        setTransactionsHistory(records);
                    }, (error) => {
                        console.error("Error fetching real-time data:", error);
                        setErrorMessage("無法載入即時交易紀錄。");
                    });

                } catch (error) {
                    console.error("Failed to set up Firestore listener:", error);
                    setErrorMessage("設定資料庫監聽失敗。");
                }

                return () => {
                    if (unsubscribe) unsubscribe(); // Cleanup listener on component unmount or dependencies change
                };
            }, [db, isAuthReady, userId]); // Re-run if db, auth readiness, or userId changes

            // Calculate projected return (年利息參考) based on loan amount, interest rate, and period
            const calculateProjectedReturn = React.useCallback(() => {
                const parsedLoanAmount = parseFloat(loanAmount);
                const parsedInterestRate = parseFloat(interestRate);

                if (isNaN(parsedLoanAmount) || parsedLoanAmount <= 0 || isNaN(parsedInterestRate)) {
                    setProjectedReturn(null);
                } else {
                    let interestForPeriod;
                    // The interest rate is assumed to be the rate for the selected period (annual, monthly, or daily)
                    switch (interestRatePeriod) {
                        case '年':
                            interestForPeriod = parsedLoanAmount * (parsedInterestRate / 100);
                            break;
                        case '月':
                            interestForPeriod = parsedLoanAmount * (parsedInterestRate / 100);
                            break;
                        case '日':
                            interestForPeriod = parsedLoanAmount * (parsedInterestRate / 100);
                            break;
                        default:
                            interestForPeriod = 0;
                    }
                    setProjectedReturn(interestForPeriod.toFixed(2));
                }
            }, [loanAmount, interestRate, interestRatePeriod]);

            // Recalculate projected return whenever relevant inputs change
            React.useEffect(() => {
                calculateProjectedReturn();
            }, [loanAmount, interestRate, interestRatePeriod, calculateProjectedReturn]);

            // Calculate Amount Due Per Period (PMT) for amortized loans or simple interest for interest-only loans
            const calculateAmountDuePerPeriod = React.useCallback((amount, rate, term, periodType, repaymentMethodType) => {
                const P = parseFloat(amount); // Principal amount
                let i = parseFloat(rate) / 100; // Interest rate per period (as decimal)
                let n = parseInt(term, 10); // Number of periods

                if (isNaN(P) || P <= 0 || isNaN(i) || i < 0 || (repaymentMethodType === '本+利' && (isNaN(n) || n <= 0))) {
                    return null; // Return null for invalid inputs
                }

                if (repaymentMethodType === '純繳利息') {
                    return (P * i).toFixed(2); // For interest-only repayment, payment is just interest for one period
                } else if (repaymentMethodType === '本+利') {
                    if (i === 0) {
                        return (P / n).toFixed(2); // If interest is zero, simple principal division
                    }
                    // Amortized loan payment formula (PMT)
                    const payment = P * (i * Math.pow(1 + i, n)) / (Math.pow(1 + i, n) - 1);
                    return payment.toFixed(2);
                }
                return null; // Should not reach here
            }, []);

            // Handles saving or updating a client/loan record
            const handleSaveRecordButtonClick = async () => {
                setErrorMessage(''); // Clear previous error messages
                if (!db || !userId) {
                    setErrorMessage("資料庫未準備好或未登入。請先登入。");
                    return;
                }

                // Parse numerical inputs
                const parsedLoanAmount = parseFloat(loanAmount);
                const parsedInterestRate = parseFloat(interestRate);
                const parsedLoanTerm = parseInt(loanTerm, 10);

                // Input validation
                if (clientName.trim() === '') {
                    setErrorMessage('請輸入客戶名稱。');
                    return;
                }
                if (idNumber.trim() === '') { // 身分證字號為必填
                    setErrorMessage('請輸入身分證字號。');
                    return;
                }
                if (isNaN(parsedLoanAmount) || parsedLoanAmount <= 0) {
                    setErrorMessage('請輸入有效的借款金額 (必須是正數)。');
                    return;
                }
                if (isNaN(parsedInterestRate) || parsedInterestRate < 0) {
                    setErrorMessage('請輸入有效的利率 (必須大於或等於 0)。');
                    return;
                }
                if (interestRatePeriod.trim() === '') {
                    setErrorMessage('請選擇利率週期。');
                    return;
                }
                if (repaymentMethod.trim() === '') {
                    setErrorMessage('請選擇還款方式。');
                    return;
                }
                if (repaymentMethod === '本+利' && (isNaN(parsedLoanTerm) || parsedLoanTerm <= 0)) {
                    setErrorMessage('選擇「本+利」還款方式時，期數必須是正數。');
                    return;
                }
                if (loanDate.trim() === '') { // 借款日期為必填
                    setErrorMessage('請選擇借款日期。');
                    return;
                }

                // Get current local date and time for timestamping
                const now = new Date();
                const localDateTimeString = now.toLocaleString('zh-TW', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                }).replace(/\//g, '-');

                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    // Reference to the main transactions collection
                    const transactionsCollectionRef = window.firebase.collection(db, `artifacts/${appId}/users/${userId}/transactions`);
                    
                    // Data object for the transaction record
                    const recordData = {
                        clientName: clientName.trim(),
                        loanAmount: parsedLoanAmount,
                        interestRate: parsedInterestRate,
                        interestRatePeriod: interestRatePeriod.trim(),
                        repaymentMethod: repaymentMethod.trim(),
                        loanTerm: repaymentMethod === '本+利' ? parsedLoanTerm : null, // Only save loanTerm if repayment is '本+利'
                        notes: notes.trim(),
                        // New client detail fields
                        contactMethod: contactMethod.trim(),
                        homePhone: homePhone.trim(),
                        lineId: lineId.trim(),
                        facebook: facebook.trim(),
                        instagram: instagram.trim(),
                        idNumber: idNumber.trim(),
                        birthday: birthday.trim(),
                        address: address.trim(),
                        residentialArea: residentialArea.trim(),
                        occupation: occupation.trim(),
                        companyPhone: companyPhone.trim(),
                        companyAddress: companyAddress.trim(),
                        disbursementNotes: disbursementNotes.trim(),
                        emergencyContact1Name: emergencyContact1Name.trim(),
                        emergencyContact1Phone: emergencyContact1Phone.trim(),
                        emergencyContact2Name: emergencyContact2Name.trim(),
                        emergencyContact2Phone: emergencyContact2Phone.trim(),
                        loanDate: loanDate, // New: Loan Date field
                        actualOutcome: null, // Outcome status (e.g., '成交', '失敗', '待定')
                        outcomeNotes: '', // Notes related to the outcome
                        date: localDateTimeString, // Timestamp of record creation/update
                        status: 'pending', // Initial status
                        timestamp: window.firebase.serverTimestamp ? window.firebase.serverTimestamp() : Date.now(),
                        addedBy: userId, // User who added the record
                        actualProfit: null, // Initialize actualProfit for new records, will be calculated from cash flows
                    };

                    if (editingRecordId) {
                        // Update existing record
                        const docRef = window.firebase.doc(transactionsCollectionRef, editingRecordId);
                        await window.firebase.updateDoc(docRef, recordData);
                        setErrorMessage("紀錄已成功更新。");
                        setEditingRecordId(null); // Clear editing state
                    } else {
                        // Add new record
                        await window.firebase.addDoc(transactionsCollectionRef, recordData);
                        setErrorMessage("新增紀錄成功。");
                    }

                    resetFields(); // Clear form fields
                    setCurrentPage('clientList'); // After saving, return to client list view
                } catch (error) {
                    console.error("Error saving document:", error);
                    setErrorMessage("儲存紀錄失敗。");
                }
            };

            // Updates the status of a transaction (e.g., '成交', '失敗')
            const updateTransactionStatus = async (id, newStatus, outcomeNotes = '') => {
                setErrorMessage('');
                if (!db || !userId) {
                    setErrorMessage("資料庫未準備好或未登入。");
                    return;
                }
                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const docRef = window.firebase.doc(db, `artifacts/${appId}/users/${userId}/transactions`, id);
                    const docSnap = await window.firebase.getDoc(docRef);

                    if (docSnap.exists()) {
                        let calculatedActualProfit = 0; // Initialize to 0 for calculation

                        // Fetch all cash flows for this specific transaction to calculate its actual profit
                        const cashFlowsForThisLoanRef = window.firebase.collection(db, `artifacts/${appId}/users/${userId}/transactions/${id}/cashFlows`);
                        const cashFlowsSnapshot = await window.firebase.getDocs(cashFlowsForThisLoanRef);
                        let totalIncomingForLoan = 0;
                        let totalOutgoingForLoan = 0;
                        cashFlowsSnapshot.forEach(cfDoc => {
                            const cfData = cfDoc.data();
                            if (cfData.type === '還款') {
                                totalIncomingForLoan += cfData.amount;
                            } else if (cfData.type === '出款') {
                                totalOutgoingForLoan += cfData.amount;
                            }
                        });

                        // Calculate actual profit based on cash flows (Incoming - Outgoing)
                        calculatedActualProfit = totalIncomingForLoan - totalOutgoingForLoan;

                        // Update the main transaction document with the new status and calculated profit
                        await window.firebase.updateDoc(docRef, {
                            actualOutcome: newStatus,
                            actualProfit: calculatedActualProfit, // Store the calculated net profit
                            status: newStatus,
                            outcomeNotes: outcomeNotes,
                            settledBy: userId,
                            settledAt: window.firebase.serverTimestamp ? window.firebase.serverTimestamp() : Date.now(),
                        });
                    } else {
                        setErrorMessage("找不到該紀錄。");
                        console.error("Attempted to update a non-existent document:", id);
                    }
                } catch (error) {
                    console.error("Error updating document:", error);
                    setErrorMessage("更新紀錄失敗。");
                }
            };

            // Populates the form fields with data from a selected record for editing
            const handleEditRecord = (record) => {
                setClientName(record.clientName);
                setLoanAmount(record.loanAmount.toString());
                setInterestRate(record.interestRate.toString());
                setInterestRatePeriod(record.interestRatePeriod || '年');
                setRepaymentMethod(record.repaymentMethod || '本+利');
                setLoanTerm(record.loanTerm ? record.loanTerm.toString() : '');
                setNotes(record.notes || '');
                // Set new client detail fields for editing
                setContactMethod(record.contactMethod || '');
                setHomePhone(record.homePhone || '');
                setLineId(record.lineId || '');
                setFacebook(record.facebook || '');
                setInstagram(record.instagram || '');
                setIdNumber(record.idNumber || '');
                setBirthday(record.birthday || '');
                setAddress(record.address || '');
                setResidentialArea(record.residentialArea || '');
                setOccupation(record.occupation || '');
                setCompanyPhone(record.companyPhone || '');
                setCompanyAddress(record.companyAddress || '');
                setDisbursementNotes(record.disbursementNotes || '');
                setEmergencyContact1Name(record.emergencyContact1Name || '');
                setEmergencyContact1Phone(record.emergencyContact1Phone || '');
                setEmergencyContact2Name(record.emergencyContact2Name || '');
                setEmergencyContact2Phone(record.emergencyContact2Phone || '');
                setLoanDate(record.loanDate || getTodayDateString()); // Set loanDate for editing

                setEditingRecordId(record.id); // Set the ID of the record being edited
                setErrorMessage(''); // Clear any old error messages
                setProjectedReturn(null); // Reset projected return calculation
                setCurrentPage('addClient'); // Switch to the form page for editing
            };

            // Cancels the editing process and clears the form
            const handleCancelEdit = () => {
                setEditingRecordId(null); // Clear editing state
                resetFields(); // Clear form fields
                setCurrentPage('clientList'); // Return to the client list view
            };

            // Initiates the delete confirmation dialog
            const handleDeleteRecord = async () => {
                setErrorMessage('');
                if (!db || !userId || !recordToDelete) {
                    setErrorMessage("無法刪除紀錄，資料庫未準備好或未登入。");
                    setShowConfirmDeleteDialog(false);
                    setRecordToDelete(null);
                    return;
                }

                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    // Reference to the document to be deleted
                    const docRef = window.firebase.doc(db, `artifacts/${appId}/users/${userId}/transactions`, recordToDelete);
                    await window.firebase.deleteDoc(docRef); // Perform the deletion
                    setErrorMessage("紀錄已成功刪除。");
                    setShowConfirmDeleteDialog(false); // Close the confirmation dialog
                    setRecordToDelete(null); // Clear the record to delete state
                } catch (error) {
                    console.error("Error deleting document:", error);
                    setErrorMessage("刪除紀錄失敗。");
                }
            };

            // Functions to manage custom outcome types in settings modal
            const handleAddManagedOutcomeType = async () => {
                if (newOutcomeTypeInput.trim() === '') {
                    setErrorMessage("請輸入有效的結果類型名稱。");
                    return;
                }
                if (managedOutcomeTypes.includes(newOutcomeTypeInput.trim())) {
                    setErrorMessage("此結果類型已存在。");
                    return;
                }
                setErrorMessage('');
                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const userSettingsDocRef = window.firebase.doc(db, `artifacts/${appId}/users/${userId}/settings`, 'mainSettings');
                    const docSnap = await window.firebase.getDoc(userSettingsDocRef);
                    const currentOutcomeTypes = docSnap.exists() ? (docSnap.data().outcomeTypes || []) : [];
                    const updatedOutcomeTypes = [...currentOutcomeTypes, newOutcomeTypeInput.trim()];

                    await window.firebase.setDoc(userSettingsDocRef, { outcomeTypes: updatedOutcomeTypes }, { merge: true });
                    setNewOutcomeTypeInput(''); // Clear the input field
                } catch (error) {
                    console.error("Error adding outcome type:", error);
                    setErrorMessage("新增結果類型失敗。");
                }
            };

            // Deletes a custom outcome type from settings
            const handleDeleteManagedOutcomeType = async (typeToDelete) => {
                setErrorMessage('');
                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const userSettingsDocRef = window.firebase.doc(db, `artifacts/${appId}/users/${userId}/settings`, 'mainSettings');
                    const docSnap = await window.firebase.getDoc(userSettingsDocRef);
                    const currentOutcomeTypes = docSnap.exists() ? (docSnap.data().outcomeTypes || []) : [];
                    const updatedOutcomeTypes = currentOutcomeTypes.filter(type => type !== typeToDelete);

                    await window.firebase.setDoc(userSettingsDocRef, { outcomeTypes: updatedOutcomeTypes }, { merge: true });
                } catch (error) {
                    console.error("Error deleting outcome type:", error);
                    setErrorMessage("刪除結果類型失敗。");
                }
            };

            // --- Cash Flow Record Management ---
            // Handles saving a new cash flow record for the current loan
            const handleSaveCashFlowRecord = async () => {
                setErrorMessage('');
                if (!db || !userId || !editingRecordId) {
                    setErrorMessage("無法新增金流紀錄，請先選擇或新增客戶。");
                    return;
                }

                const parsedCashFlowAmount = parseFloat(newCashFlowAmount);
                let finalCashFlowItem = newCashFlowItem;

                // Determine cash flow type based on amount
                let inferredCashFlowType;
                if (parsedCashFlowAmount > 0) {
                    inferredCashFlowType = '還款';
                } else if (parsedCashFlowAmount < 0) {
                    inferredCashFlowType = '出款';
                } else {
                    setErrorMessage('請輸入有效的金流金額 (非零)。');
                    return;
                }

                // If "其他" is selected for item, use the custom input value
                if (newCashFlowItem === '其他') {
                    if (customCashFlowItemInput.trim() === '') {
                        setErrorMessage('請輸入自訂金流名目。');
                        return;
                    }
                    finalCashFlowItem = customCashFlowItemInput.trim();
                }

                // Basic validation for cash flow inputs
                if (isNaN(parsedCashFlowAmount) || parsedCashFlowAmount === 0) {
                    setErrorMessage('請輸入有效的金流金額 (非零)。');
                    return;
                }
                if (newCashFlowDate.trim() === '') {
                    setErrorMessage('請選擇金流日期。');
                    return;
                }
                if (finalCashFlowItem.trim() === '') {
                    setErrorMessage('請選擇或輸入金流名目。');
                    return;
                }

                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    // Reference to the cash flow sub-collection for the current transaction
                    const cashFlowsCollectionRef = window.firebase.collection(db, `artifacts/${appId}/users/${userId}/transactions/${editingRecordId}/cashFlows`);

                    // Add the new cash flow document
                    await window.firebase.addDoc(cashFlowsCollectionRef, {
                        type: inferredCashFlowType, // Use inferred type
                        date: newCashFlowDate,
                        amount: parsedCashFlowAmount,
                        item: finalCashFlowItem,
                        notes: newCashFlowNotes.trim(),
                        timestamp: window.firebase.serverTimestamp ? window.firebase.serverTimestamp() : Date.now(),
                        addedBy: userId,
                    });
                    setErrorMessage("金流紀錄新增成功。");
                    // Reset cash flow input fields
                    setNewCashFlowAmount('');
                    setNewCashFlowItem('本金+利息');
                    setNewCashFlowNotes('');
                    setCustomCashFlowItemInput(''); // Clear custom item input

                    // Save new custom item to Firestore if it's not already in managed lists
                    if (newCashFlowItem === '其他' && !managedCashFlowItems.includes(finalCashFlowItem)) {
                        const cashFlowItemsRef = window.firebase.collection(db, `artifacts/${appId}/users/${userId}/settings/userSettings/cashFlowItems`);
                        await window.firebase.setDoc(window.firebase.doc(cashFlowItemsRef, finalCashFlowItem), { exists: true });
                    }

                    // After saving a cash flow, re-calculate and update the actualProfit on the parent transaction document
                    const parentTransactionDocRef = window.firebase.doc(db, `artifacts/${appId}/users/${userId}/transactions`, editingRecordId);
                    const cashFlowsSnapshot = await window.firebase.getDocs(cashFlowsCollectionRef); // Get all cash flows again
                    let totalIncomingForLoan = 0;
                    let totalOutgoingForLoan = 0;
                    cashFlowsSnapshot.forEach(cfDoc => {
                        const cfData = cfDoc.data();
                        if (cfData.type === '還款') {
                            totalIncomingForLoan += cfData.amount;
                        } else if (cfData.type === '出款') {
                            totalOutgoingForLoan += Math.abs(cfData.amount); // Use absolute value for outgoing
                        }
                    });
                    const calculatedActualProfit = totalIncomingForLoan - totalOutgoingForLoan;
                    await window.firebase.updateDoc(parentTransactionDocRef, {
                        actualProfit: calculatedActualProfit, // Update the actualProfit field
                    });

                } catch (error) {
                    console.error("Error saving cash flow document:", error);
                    setErrorMessage("儲存金流紀錄失敗。");
                }
            };

            // Handles deleting a cash flow record
            const handleDeleteCashFlowRecord = async (cashFlowId) => {
                setErrorMessage('');
                if (!db || !userId || !editingRecordId) {
                    setErrorMessage("無法刪除金流紀錄，資料庫未準備好或未登入。");
                    return;
                }
                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    // Reference to the specific cash flow document to delete
                    const docRef = window.firebase.doc(db, `artifacts/${appId}/users/${userId}/transactions/${editingRecordId}/cashFlows`, cashFlowId);
                    await window.firebase.deleteDoc(docRef); // Perform the deletion
                    setErrorMessage("金流紀錄已成功刪除。");

                    // After deleting a cash flow, re-calculate and update the actualProfit on the parent transaction document
                    const parentTransactionDocRef = window.firebase.doc(db, `artifacts/${appId}/users/${userId}/transactions`, editingRecordId);
                    const cashFlowsCollectionRef = window.firebase.collection(db, `artifacts/${appId}/users/${userId}/transactions/${editingRecordId}/cashFlows`);
                    const cashFlowsSnapshot = await window.firebase.getDocs(cashFlowsCollectionRef); // Get remaining cash flows
                    let totalIncomingForLoan = 0;
                    let totalOutgoingForLoan = 0;
                    cashFlowsSnapshot.forEach(cfDoc => {
                        const cfData = cfDoc.data();
                        if (cfData.type === '還款') {
                            totalIncomingForLoan += cfData.amount;
                        } else if (cfData.type === '出款') {
                            totalOutgoingForLoan += Math.abs(cfData.amount); // Use absolute value for outgoing
                        }
                    });
                    const calculatedActualProfit = totalIncomingForLoan - totalOutgoingForLoan;
                    await window.firebase.updateDoc(parentTransactionDocRef, {
                        actualProfit: calculatedActualProfit, // Update the actualProfit field
                    });

                } catch (error) {
                    console.error("Error deleting cash flow document:", error);
                    setErrorMessage("刪除金流紀錄失敗。");
                }
            };

            // --- Event History Record Management ---
            // Handles saving a new event record for the current loan
            const handleSaveEventRecord = async () => {
                setErrorMessage('');
                if (!db || !userId || !editingRecordId) {
                    setErrorMessage("無法新增事件紀錄，請先選擇或新增客戶。");
                    return;
                }
                // Basic validation for event inputs
                if (newEventType.trim() === '') {
                    setErrorMessage('請輸入事件類型。');
                    return;
                }
                if (newEventNotes.trim() === '') {
                    setErrorMessage('請輸入事件備註。');
                    return;
                }

                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    // Reference to the event sub-collection for the current transaction
                    const eventsCollectionRef = window.firebase.collection(db, `artifacts/${appId}/users/${userId}/transactions/${editingRecordId}/events`);

                    // Add the new event document
                    await window.firebase.addDoc(eventsCollectionRef, {
                        date: newEventDate,
                        type: newEventType.trim(),
                        notes: newEventNotes.trim(),
                        timestamp: window.firebase.serverTimestamp ? window.firebase.serverTimestamp() : Date.now(),
                        addedBy: userId,
                    });
                    setErrorMessage("事件紀錄新增成功。");
                    // Reset event input fields
                    setNewEventType('');
                    setNewEventNotes('');
                } catch (error) {
                    console.error("Error saving event document:", error);
                    setErrorMessage("儲存事件紀錄失敗。");
                }
            };

            // Handles deleting an event record
            const handleDeleteEventRecord = async (eventId) => {
                setErrorMessage('');
                if (!db || !userId || !editingRecordId) {
                    setErrorMessage("無法刪除事件紀錄，資料庫未準備好或未登入。");
                    return;
                }
                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    // Reference to the specific event document to delete
                    const docRef = window.firebase.doc(db, `artifacts/${appId}/users/${userId}/transactions/${editingRecordId}/events`, eventId);
                    await window.firebase.deleteDoc(docRef); // Perform the deletion
                    setErrorMessage("事件紀錄已成功刪除。");
                } catch (error) {
                    console.error("Error deleting event document:", error);
                    setErrorMessage("刪除事件紀錄失敗。");
                }
            };

            // Memoized filtered and sorted transaction history for efficient rendering
            const filteredTransactionsHistory = React.useMemo(() => {
                const filtered = [...transactionsHistory];

                // Apply year and month filter if selected
                const filteredByPeriod = filtered.filter(record => {
                    const recordDate = record.loanDate ? new Date(record.loanDate) : (record.date ? new Date(record.date.substring(0, 10)) : null);
                    if (!recordDate || isNaN(recordDate.getTime())) return false; // Skip invalid dates

                    const recordYear = recordDate.getFullYear().toString();
                    const recordMonth = (recordDate.getMonth() + 1).toString().padStart(2, '0');

                    const matchesYear = selectedSummaryYear === 'all' || recordYear === selectedSummaryYear;
                    const matchesMonth = selectedSummaryMonth === 'all' || recordMonth === selectedSummaryMonth;

                    return matchesYear && matchesMonth;
                });

                return filteredByPeriod.sort((a, b) => {
                    // Sort by timestamp, newest first. Handle cases where timestamp might be missing or not a Firestore Timestamp object.
                    const timeA = a.timestamp ? (a.timestamp.toDate ? a.timestamp.toDate().getTime() : a.timestamp) : 0;
                    const timeB = b.timestamp ? (b.timestamp.toDate ? b.timestamp.toDate().getTime() : b.timestamp) : 0;
                    return timeB - timeA;
                });
            }, [transactionsHistory, selectedSummaryYear, selectedSummaryMonth]); // Re-run when filters change

            // Calculate total loan amount across all filtered transactions for the summary
            const totalLoanAmountSumFiltered = React.useMemo(() => {
                return filteredTransactionsHistory.reduce((sum, record) => {
                    return sum + record.loanAmount;
                }, 0);
            }, [filteredTransactionsHistory]);

            // Calculate overall actual profit across all filtered transactions for the summary
            const totalActualProfitAppLevelFiltered = React.useMemo(() => {
                return filteredTransactionsHistory.reduce((sum, record) => {
                    // Only sum if actualProfit is defined and not null
                    if (record.actualProfit !== undefined && record.actualProfit !== null) {
                        return sum + record.actualProfit;
                    }
                    return sum;
                }, 0);
            }, [filteredTransactionsHistory]);

            // Calculate total incoming from cash flows for the current loan (for cashFlowSummary page)
            const totalIncomingFromCashFlows = React.useMemo(() => {
                return cashFlows.reduce((sum, record) => {
                    if (record.type === '還款') {
                        return sum + record.amount;
                    }
                    return sum;
                }, 0);
            }, [cashFlows]);

            // Calculate total outgoing from cash flows for the current loan (for cashFlowSummary page)
            const totalOutgoingFromCashFlows = React.useMemo(() => {
                return cashFlows.reduce((sum, record) => {
                    if (record.type === '出款') {
                        return sum + Math.abs(record.amount); // Use absolute value for outgoing
                    }
                    return sum;
                }, 0);
            }, [cashFlows]);

            // Calculate current cash flow status (net) for the current loan
            const currentCashFlowStatus = React.useMemo(() => {
                return (totalIncomingFromCashFlows - totalOutgoingFromCashFlows).toFixed(2);
            }, [totalIncomingFromCashFlows, totalOutgoingFromCashFlows]);

            // Calculate Net Profit for a specific loan based on its stored actualProfit
            const calculateLoanNetProfit = React.useCallback((loanId) => {
                const loanRecord = transactionsHistory.find(rec => rec.id === loanId);
                if (!loanRecord) return null; // Return null if record not found

                // Check if actualProfit is explicitly set and not null
                if (loanRecord.actualProfit !== undefined && loanRecord.actualProfit !== null) {
                    return loanRecord.actualProfit;
                }

                // If actualProfit is not set, return '待計算' (pending calculation)
                return '待計算';
            }, [transactionsHistory]); // Dependency on transactionsHistory to re-evaluate when it changes

            // Calculate total unique customers for the filtered period
            const totalCustomersFiltered = React.useMemo(() => {
                const uniqueClients = new Set();
                filteredTransactionsHistory.forEach(record => {
                    uniqueClients.add(record.clientName);
                });
                return uniqueClients.size;
            }, [filteredTransactionsHistory]);

            // Resets all form fields to their initial empty or default states
            const resetFields = () => {
                setClientName('');
                setLoanAmount('');
                setInterestRate('');
                setInterestRatePeriod('年');
                setRepaymentMethod('本+利');
                setLoanTerm('');
                setNotes('');
                setProjectedReturn(null);
                setErrorMessage('');
                setEditingRecordId(null); // Clear editing state
                setCashFlows([]); // Clear cash flows
                setEventHistoryRecords([]); // Clear event history
                // Reset new client detail fields
                setContactMethod('');
                setHomePhone('');
                setLineId('');
                setFacebook('');
                setInstagram('');
                setIdNumber('');
                setBirthday('');
                setAddress('');
                setResidentialArea('');
                setOccupation('');
                setCompanyPhone('');
                setCompanyAddress('');
                setDisbursementNotes('');
                setEmergencyContact1Name('');
                setEmergencyContact1Phone('');
                setEmergencyContact2Name('');
                setEmergencyContact2Phone('');
                // Reset cash flow input fields
                setNewCashFlowDate(getTodayDateString());
                setNewCashFlowAmount('');
                setNewCashFlowItem('本金+利息');
                setNewCashFlowNotes('');
                setCustomCashFlowItemInput('');
                // Reset event input fields
                setNewEventDate(getTodayDateString());
                setNewEventType('');
                setNewEventNotes('');
                setLoanDate(getTodayDateString()); // Reset loanDate
            };

            // Exports the filtered transaction history to a CSV file
            const exportToCsv = () => {
                if (filteredTransactionsHistory.length === 0) {
                    setErrorMessage('沒有紀錄可以導出。');
                    return;
                }

                // Define CSV headers
                const headers = ["序號", "借款日期", "客戶名稱", "借款金額", "淨額", "利率(%)", "還款方式", "期數", "實際結果", "聯絡方式", "住宅電話", "Line ID", "FB", "IG", "身分證字號", "生日", "住址", "居住地", "職業", "公司電話", "公司地址", "出款備註", "緊急聯絡人1", "緊急聯絡人1電話", "緊急聯絡人2", "緊急聯絡人2電話", "一般備註"];
                const csvRows = [];

                csvRows.push(headers.join(',')); // Add headers to CSV rows

                // Add data rows
                filteredTransactionsHistory.forEach((record, index) => {
                    const netProfitValue = calculateLoanNetProfit(record.id);
                    const netProfitDisplay = typeof netProfitValue === 'string' ? netProfitValue : netProfitValue.toFixed(2);
                    const row = [
                        index + 1,
                        record.loanDate ? record.loanDate.substring(0, 10) : record.date.substring(0, 10), // Use loanDate if available
                        record.clientName,
                        record.loanAmount,
                        netProfitDisplay, // Added Net Profit
                        record.interestRate,
                        record.repaymentMethod,
                        record.loanTerm || 'N/A', // Display 'N/A' if no loan term
                        record.status === 'pending' ? '待定' : (record.actualOutcome === 'completed_success' ? '成交' : '失敗'),
                        record.contactMethod || '',
                        record.homePhone || '',
                        record.lineId || '',
                        record.facebook || '',
                        record.instagram || '',
                        record.idNumber || '',
                        record.birthday || '',
                        record.address || '',
                        record.residentialArea || '',
                        record.occupation || '',
                        record.companyPhone || '',
                        record.companyAddress || '',
                        record.disbursementNotes || '',
                        record.emergencyContact1Name || '',
                        record.emergencyContact1Phone || '',
                        record.emergencyContact2Name || '',
                        record.emergencyContact2Phone || '',
                        record.notes || ''
                    ];
                    csvRows.push(row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',')); // Enclose fields in quotes and escape existing quotes
                });

                // Add summary statistics to CSV
                csvRows.push(''); // Empty line for separation
                csvRows.push(`總出款:,${(totalLoanAmountSumFiltered * -1).toFixed(2)} NTD`); // Total outgoing loans for filtered period
                csvRows.push(`總淨利:,${totalActualProfitAppLevelFiltered.toFixed(2)} NTD`); // Overall net profit for filtered period
                csvRows.push(`金流狀況 (結餘):,${totalActualProfitAppLevelFiltered.toFixed(2)} NTD`); // Overall net profit for filtered period
                csvRows.push(`總客戶數:,${totalCustomersFiltered}`); // Total customers for filtered period

                // Create and download the CSV file
                const csvString = csvRows.join('\n');
                const blob = new Blob(['\ufeff' + csvString], { type: 'text/csv;charset=utf-8;' }); // Add BOM for UTF-8 compatibility
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `客戶列表_${new Date().toISOString().split('T')[0]}.csv`; // Filename with current date
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href); // Clean up URL object
            };

            // Handles printing the client list section
            const handlePrintRecordsOnly = () => {
                const printContent = document.getElementById('transaction-history-section');
                if (!printContent) {
                    setErrorMessage('找不到客戶列表區塊進行列印。');
                    return;
                }

                // Construct the HTML content for printing, including necessary styles
                let printContentHtml = `
                    <!DOCTYPE html>
                    <html lang="zh-TW">
                    <head>
                        <meta charset="UTF-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <title>客戶列表列印</title>
                        <style>
                            body { font-family: 'Inter', sans-serif; margin: 20px; }
                            h2 { text-align: center; margin-bottom: 20px; font-size: 1.5em; }
                            table { width: 100%; border-collapse: collapse; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                            th { background-color: #f2f2f2; }
                            .success-text { color: #16A34A; font-weight: bold; }
                            .failure-text { color: #DC2626; font-weight: bold; }
                            .blue-text { color: #2563EB; font-weight: bold; }
                            .red-text { color: #DC2626; font-weight: bold; }
                            .outcome-badge {
                                display: inline-block;
                                padding: 4px 8px;
                                border-radius: 9999px;
                                font-weight: 600;
                                font-size: 0.8em;
                                line-height: 1;
                            }
                            .success-badge { background-color: #D1FAE5; color: #065F46; }
                            .failure-badge { background-color: #FEE2E2; color: #991B1B; }
                        </style>
                        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
                    </head>
                    <body>
                        <h2>客戶列表</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>序號</th>
                                    <th>借款日期</th>
                                    <th>客戶名稱</th>
                                    <th>借款金額</th>
                                    <th>淨額</th>
                                    <th>利率(%)</th>
                                    <th>還款方式</th>
                                    <th>期數</th>
                                    <th>實際結果</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filteredTransactionsHistory.map((record, index) => `
                                    <tr>
                                        <td>${index + 1}</td>
                                        <td>${record.loanDate ? record.loanDate.substring(0, 10) : record.date.substring(0, 10)}</td>
                                        <td>${record.clientName}</td>
                                        <td>${record.loanAmount}</td>
                                        <td>${calculateLoanNetProfit(record.id) !== null ? (typeof calculateLoanNetProfit(record.id) === 'number' ? calculateLoanNetProfit(record.id).toFixed(2) : calculateLoanNetProfit(record.id)) : '待計算'}</td>
                                        <td>${record.interestRate}</td>
                                        <td>${record.repaymentMethod}</td>
                                        <td>${record.loanTerm || 'N/A'}</td>
                                        <td>
                                            <span class="outcome-badge ${record.status === 'completed_success' ? 'success-badge' : (record.status === 'completed_failure' ? 'failure-badge' : '')}">
                                                ${record.status === 'pending' ? '待定' : (record.actualOutcome === 'completed_success' ? '成交' : '失敗')}
                                            </span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <div style="text-align: center; margin-top: 20px; font-size: 1.1em; font-weight: bold;">
                            金流狀況 (結餘):
                            <span class="${parseFloat(totalActualProfitAppLevelFiltered) >= 0 ? 'blue-text' : 'red-text'}">
                                ${totalActualProfitAppLevelFiltered.toFixed(2)} NTD
                            </span>
                        </div>
                        <div style="text-align: center; margin-top: 10px; font-size: 1em;">
                            總出款: ${(totalLoanAmountSumFiltered * -1).toFixed(2)} NTD
                        </div>
                        <div style="text-align: center; margin-top: 10px; font-size: 1em;">
                            總淨利: ${totalActualProfitAppLevelFiltered.toFixed(2)} NTD
                        </div>
                        <div style="text-align: center; margin-top: 10px; font-size: 1em;">
                            總客戶數: ${totalCustomersFiltered}
                        </div>
                        <div style="text-align: center; margin-top: 30px; font-size: 0.8em; color: #6B7280;">
                            威爾設計版權所有 ver ${currentVersion}
                        </div>
                    </body>
                    </html>
                `;
                const printWindow = window.open('', '_blank', 'width=800,height=600'); // Open a new window for printing
                if (printWindow) {
                    printWindow.document.write(printContentHtml); // Write the generated HTML to the new window
                    printWindow.document.close(); // Close the document to ensure content is rendered
                    printWindow.focus(); // Focus the new window

                    // Wait for the content to load before printing
                    printWindow.onload = () => {
                        printWindow.print(); // Trigger print dialog
                        printWindow.close(); // Close the window after printing
                    };
                } else {
                    setErrorMessage('無法開啟列印視窗，請檢查瀏覽器設定或彈出視窗阻擋。');
                }
            };

            // Chart.js rendering logic
            React.useEffect(() => {
                if (showChart && filteredTransactionsHistory.length > 0) {
                    const ctx = document.getElementById('cashFlowChart').getContext('2d');

                    // Prepare data for the chart
                    const chartData = {};
                    filteredTransactionsHistory.forEach(record => {
                        const dateKey = record.loanDate ? record.loanDate.substring(0, 7) : record.date.substring(0, 7); //YYYY-MM
                        if (!chartData[dateKey]) {
                            chartData[dateKey] = { totalOutgoing: 0, totalIncoming: 0, netProfit: 0 };
                        }
                        chartData[dateKey].totalOutgoing += record.loanAmount; // Initial loan is outgoing
                        if (record.actualProfit !== undefined && record.actualProfit !== null) {
                            chartData[dateKey].netProfit += record.actualProfit;
                        }

                        // Aggregate cash flows for each transaction within the filtered period
                        // This requires fetching cash flows for each filtered transaction, which can be heavy.
                        // For simplicity, we'll use the already calculated actualProfit for net.
                        // For detailed incoming/outgoing, a more complex query would be needed.
                    });

                    // Sort data by date for chart labels
                    const sortedDates = Object.keys(chartData).sort();
                    const labels = sortedDates;
                    const outgoingData = sortedDates.map(date => chartData[date].totalOutgoing);
                    const netProfitData = sortedDates.map(date => chartData[date].netProfit);

                    // Destroy existing chart if it exists
                    if (chartRef.current) {
                        chartRef.current.destroy();
                    }

                    // Create new chart instance
                    chartRef.current = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: '總出款 (初始借款)',
                                    data: outgoingData,
                                    backgroundColor: 'rgba(211, 47, 47, 0.8)', /* Red */
                                    borderColor: 'rgba(211, 47, 47, 1)',
                                    borderWidth: 1
                                },
                                {
                                    label: '金流淨額',
                                    data: netProfitData,
                                    backgroundColor: netProfitData.map(value => value >= 0 ? 'rgba(76, 175, 80, 0.8)' : 'rgba(211, 47, 47, 0.8)'), /* Green for positive, Red for negative */
                                    borderColor: netProfitData.map(value => value >= 0 ? 'rgba(76, 175, 80, 1)' : 'rgba(211, 47, 47, 1)'),
                                    borderWidth: 1
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        color: '#212121', /* Dark text color */
                                    },
                                    grid: {
                                        color: '#BDBDBD', /* Light border color */
                                    }
                                },
                                x: {
                                    ticks: {
                                        color: '#212121', /* Dark text color */
                                    },
                                    grid: {
                                        color: '#BDBDBD', /* Light border color */
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    labels: {
                                        color: '#212121', /* Dark text color */
                                    }
                                }
                            }
                        }
                    });
                } else if (chartRef.current) {
                    // Destroy chart if not visible or no data
                    chartRef.current.destroy();
                    chartRef.current = null;
                }
            }, [showChart, filteredTransactionsHistory]); // Re-render chart when visibility or data changes


            return (
                <div className="min-h-screen bg-red-white-gray-light flex flex-col items-center justify-center p-4 font-sans">
                    {/* Display loading state */}
                    {loadingFirebase && (
                        <div className="absolute inset-0 bg-gray-200 bg-opacity-75 flex items-center justify-center z-50">
                            <div className="text-gray-800 text-lg font-bold">載入中...</div>
                        </div>
                    )}

                    {/* User Info and Sign-in/Sign-out buttons */}
                    <div className="app-header absolute top-4 left-4 right-4">
                        {userId ? (
                            <div className="user-info">
                                <span className="font-bold mr-1">登入用戶:</span>
                                {userName || userEmail || userId}
                                {userEmail && <span className="ml-2 text-gray-200">({userEmail})</span>}
                            </div>
                        ) : (
                            <span className="font-bold">未登入</span>
                        )}
                        <div className="mt-2 sm:mt-0 flex space-x-2">
                            {userId && !userEmail ? (
                                <button
                                    onClick={handleGoogleSignIn}
                                    disabled={loadingFirebase || !isAuthReady}
                                >
                                    Google 登入
                                </button>
                            ) : userId && userEmail ? (
                                <button
                                    onClick={handleSignOut}
                                    disabled={loadingFirebase || !isAuthReady}
                                >
                                    登出
                                </button>
                            ) : (
                                <button
                                    onClick={handleGoogleSignIn}
                                    disabled={loadingFirebase || !isAuthReady}
                                >
                                    Google 登入
                                </button>
                            )}
                        </div>
                        {/* Settings Button */}
                        <button
                            onClick={() => setShowSettingsModal(true)}
                            className="settings-button"
                            title="設定"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fillRule="evenodd" d="M11.49 3.17c-.38-1.16-1.47-1.16-1.85 0L9 4.38a1 1 0 01-.78.78l-1.16.38c-1.16.38-1.16 1.47 0 1.85l.38.78a1 1 0 01.78.78l.38 1.16c.38 1.16 1.47 1.16 1.85 0l.78-.38a1 1 0 01.78-.78l1.16-.38c1.16-.38 11.16-1.47 0-1.85l-.38-.78a1 1 0 01-.78-.78l-.38-1.16zM15.5 13a3.5 3.5 0 11-7 0 3.5 3.5 0 017 0zM17.5 12a.5.5 0 00-.5.5v2a.5.5 0 00.5.5h2a.5.5 0 00.5-.5v-2a.5.5 0 00-.5-.5h-2z" clipRule="evenodd" />
                            </svg>
                        </button>
                    </div>

                    {/* Confirmation Dialog for single record delete */}
                    {showConfirmDeleteDialog && recordToDelete && (
                        <div className="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50">
                            <div className="card text-center">
                                <p className="text-lg font-semibold mb-4">確定要刪除這筆紀錄嗎？</p>
                                <p className="text-sm text-gray-600 mb-6">此操作無法復原。</p>
                                <div className="flex justify-center space-x-4">
                                    <button
                                        onClick={() => { setShowConfirmDeleteDialog(false); setRecordToDelete(null); }}
                                        className="btn-secondary"
                                    >
                                        取消
                                    </button>
                                    <button
                                        onClick={handleDeleteRecord}
                                        className="btn-danger"
                                    >
                                        確認刪除
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Settings Modal */}
                    {showSettingsModal && (
                        <div className="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4">
                            <div className="card max-w-md w-full">
                                <h2 className="text-2xl font-bold text-red-white-text-dark mb-4 text-center">設定</h2>
                                {/* Outcome Type Management (only custom outcomes allowed) */}
                                <div className="mb-4 border-t pt-4 mt-4">
                                    <h3 className="text-lg font-semibold text-red-white-text-dark mb-2">管理結果類型</h3>
                                    <div className="flex flex-wrap gap-2 mb-2">
                                        {managedOutcomeTypes.map(type => (
                                            <span key={type} className="bg-green-100 text-green-800 px-2 py-1 rounded-full text-sm flex items-center">
                                                {type}
                                                <button
                                                    onClick={() => handleDeleteManagedOutcomeType(type)}
                                                    className="ml-1 text-green-600 hover:text-green-800 focus:outline-none"
                                                >
                                                    &times;
                                                </button>
                                            </span>
                                        ))}
                                    </div>
                                    <div className="flex">
                                        <input
                                            type="text"
                                            placeholder="新增結果類型"
                                            value={newOutcomeTypeInput}
                                            onChange={(e) => setNewOutcomeTypeInput(e.target.value)}
                                            onKeyDown={(e) => {
                                                if (e.key === 'Enter') {
                                                    handleAddManagedOutcomeType();
                                                }
                                            }}
                                            className="flex-grow"
                                        />
                                        <button
                                            onClick={handleAddManagedOutcomeType}
                                            className="btn-primary rounded-r-lg"
                                        >
                                            新增
                                        </button>
                                    </div>
                                </div>

                                {/* Marquee Content Management */}
                                <div className="mb-4 border-t pt-4 mt-4">
                                    <h3 className="text-lg font-semibold text-red-white-text-dark mb-2">跑馬燈內容設定</h3>
                                    {[0, 1, 2].map(i => (
                                        <div key={i} className="mb-2">
                                            <label htmlFor={`marquee-${i}`} className="block text-red-white-text-dark text-sm font-semibold mb-1">
                                                跑馬燈 {i + 1} 內容:
                                            </label>
                                            <input
                                                type="text"
                                                id={`marquee-${i}`}
                                                value={marqueeContents[i]}
                                                onChange={(e) => {
                                                    const newContents = [...marqueeContents];
                                                    newContents[i] = e.target.value;
                                                    setMarqueeContents(newContents);
                                                }}
                                                placeholder={`輸入跑馬燈 ${i + 1} 的內容`}
                                                className="w-full"
                                            />
                                        </div>
                                    ))}
                                    <button
                                        onClick={async () => {
                                            if (!db || !userId) {
                                                setErrorMessage("資料庫未準備好或未登入。");
                                                return;
                                            }
                                            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                                            // Corrected: Use doc to reference the mainSettings document
                                            const userSettingsDocRef = window.firebase.doc(db, `artifacts/${appId}/users/${userId}/settings`, 'mainSettings');
                                            try {
                                                // Update only the marqueeContents field
                                                await window.firebase.setDoc(userSettingsDocRef, { marqueeContents: marqueeContents }, { merge: true });
                                                setErrorMessage("跑馬燈內容已儲存。");
                                            } catch (error) {
                                                console.error("Error saving marquee content:", error);
                                                setErrorMessage("儲存跑馬燈內容失敗。");
                                            }
                                        }}
                                        className="btn-primary w-full mt-3"
                                    >
                                        儲存跑馬燈內容
                                    </button>
                                </div>

                                <div className="text-center mt-4">
                                    <button
                                        onClick={() => setShowSettingsModal(false)}
                                        className="btn-primary"
                                    >
                                        確定更新
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Event History Modal */}
                    {showEventHistoryModal && editingRecordId && (
                        <div className="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4">
                            <div className="card max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                                <h2 className="text-2xl font-bold text-red-white-text-dark mb-4 text-center">
                                    事件紀錄 (客戶: {transactionsHistory.find(rec => rec.id === editingRecordId)?.clientName})
                                </h2>

                                {/* Add New Event Record Form */}
                                <div className="mb-8 p-6 bg-red-white-light rounded-lg shadow-inner">
                                    <h3 className="text-xl font-semibold text-red-white-text-dark mb-4">新增事件</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <label htmlFor="newEventDate" className="block text-red-white-text-dark text-sm font-semibold mb-2">
                                                日期:
                                            </label>
                                            <input
                                                type="date"
                                                id="newEventDate"
                                                value={newEventDate}
                                                onChange={(e) => setNewEventDate(e.target.value)}
                                                className="w-full"
                                            />
                                        </div>
                                        <div>
                                            <label htmlFor="newEventType" className="block text-red-white-text-dark text-sm font-semibold mb-2">
                                                類型:
                                            </label>
                                            <input
                                                type="text"
                                                id="newEventType"
                                                value={newEventType}
                                                onChange={(e) => setNewEventType(e.target.value)}
                                                placeholder="例如: 電話聯絡, 會面"
                                                className="w-full"
                                            />
                                        </div>
                                        <div className="md:col-span-2">
                                            <label htmlFor="newEventNotes" className="block text-red-white-text-dark text-sm font-semibold mb-2">
                                                備註:
                                            </label>
                                            <textarea
                                                id="newEventNotes"
                                                value={newEventNotes}
                                                onChange={(e) => setNewEventNotes(e.target.value)}
                                                placeholder="例如: 討論還款計畫"
                                                rows="2"
                                                className="w-full"
                                            ></textarea>
                                        </div>
                                    </div>
                                    <button
                                        onClick={handleSaveEventRecord}
                                        className="w-full btn-primary"
                                        disabled={loadingFirebase || !isAuthReady}
                                    >
                                        新增事件
                                    </button>
                                </div>

                                {/* Event History Table */}
                                <div className="mt-8">
                                    <h3 className="text-xl font-extrabold text-red-white-text-dark mb-4 text-center">事件紀錄列表</h3>
                                    {eventHistoryRecords.length > 0 ? (
                                        <div className="overflow-x-auto">
                                            <table className="min-w-full">
                                                <thead>
                                                    <tr>
                                                        <th>日期</th>
                                                        <th>類型</th>
                                                        <th>備註</th>
                                                        <th>操作</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="text-red-white-text-dark text-sm font-light">
                                                    {eventHistoryRecords.map(event => (
                                                        <tr key={event.id} className="border-b border-gray-200 hover:bg-gray-100">
                                                            <td className="py-3 px-6 text-left whitespace-nowrap">{event.date}</td>
                                                            <td className="py-3 px-6 text-left whitespace-nowrap">{event.type}</td>
                                                            <td className="py-3 px-6 text-left">{event.notes}</td>
                                                            <td className="py-3 px-6 text-left">
                                                                <button
                                                                    onClick={() => handleDeleteEventRecord(event.id)}
                                                                    className="bg-gray-400 hover:bg-gray-500 text-white text-xs px-2 py-1 rounded-md transition duration-200"
                                                                >
                                                                    刪除
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    ) : (
                                        <p className="text-center text-gray-500 mt-4">
                                            此客戶目前沒有事件紀錄。
                                        </p>
                                    )}
                                </div>

                                {/* Close Event History Modal Button */}
                                <div className="text-center mt-8">
                                    <button
                                        onClick={() => setShowEventHistoryModal(false)}
                                        className="btn-primary"
                                    >
                                        關閉
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}


                    {/* Main container for CRM pages */}
                    <div className="flex flex-col md:flex-row md:space-x-8 w-full max-w-7xl mt-20 sm:mt-24">
                        {/* Conditional Rendering based on currentPage */}
                        {currentPage === 'addClient' && (
                            <div className="card w-full mb-8">
                                <h1 className="text-3xl font-extrabold text-red-white-text-dark mb-6 text-center">
                                    新增客戶
                                </h1>

                                {/* Top navigation for Add/Edit Client Page */}
                                <div className="flex flex-wrap justify-center sm:justify-start gap-2 mb-6">
                                    <button
                                        onClick={() => setCurrentPage('clientList')}
                                        className="btn-secondary"
                                    >
                                        返回客戶列表
                                    </button>
                                    {editingRecordId && (
                                        <button
                                            onClick={() => setCurrentPage('cashFlowSummary')}
                                            className="bg-purple-600 hover:bg-purple-700 text-white text-sm font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-75"
                                        >
                                            金流收支
                                        </button>
                                    )}
                                    {editingRecordId && ( // New: Event History Button
                                        <button
                                            onClick={() => setShowEventHistoryModal(true)} // Open modal
                                            className="bg-yellow-600 hover:bg-yellow-700 text-white text-sm font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-opacity-75"
                                        >
                                            事件紀錄
                                        </button>
                                    )}
                                </div>


                                {/* Input fields arranged in two columns */}
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    {/* Client Name */}
                                    <div className="md:col-span-2 mb-4">
                                        <label htmlFor="clientName" className="block text-red-white-text-dark text-sm font-semibold mb-2">
                                            客戶名稱:
                                        </label>
                                        <input
                                            type="text"
                                            id="clientName"
                                            value={clientName}
                                            onChange={(e) => setClientName(e.target.value)}
                                            placeholder="例如: 王小明"
                                            className="w-full"
                                        />
                                    </div>

                                    {/* Loan Date */}
                                    <div className="md:col-span-2 mb-4">
                                        <label htmlFor="loanDate" className="block text-red-white-text-dark text-sm font-semibold mb-2">
                                            借款日期:
                                        </label>
                                        <input
                                            type="date"
                                            id="loanDate"
                                            value={loanDate}
                                            onChange={(e) => setLoanDate(e.target.value)}
                                            className="w-full"
                                        />
                                    </div>

                                    {/* ID Number */}
                                    <div className="mb-4">
                                        <label htmlFor="idNumber" className="block text-red-white-text-dark text-sm font-semibold mb-2">
                                            身分證字號:
                                        </label>
                                        <input
                                            type="text"
                                            id="idNumber"
                                            value={idNumber}
                                            onChange={(e) => setIdNumber(e.target.value)}
                                            placeholder="例如: A123456789"
                                            className="w-full"
                                        />
                                    </div>

                                    {/* Birthday */}
                                    <div className="mb-4">
                                        <label htmlFor="birthday" className="block text-red-white-text-dark text-sm font-semibold mb-2">
                                            生日:
                                        </label>
                                        <input
                                            type="date"
                                            id="birthday"
                                            value={birthday}
                                            onChange={(e) => setBirthday(e.target.value)}
                                            className="w-full"
                                        />
                                    </div>

                                    {/* Contact Method */}
                                    <div className="mb-4">
                                        <label htmlFor="contactMethod" className="block text-red-white-text-dark text-sm font-semibold mb-2">
                                            聯絡方式:
                                        </label>
                                        <input
                                            type="text"
                                            id="contactMethod"
                                            value={contactMethod}
                                            onChange={(e) => setContactMethod(e.target.value)}
                                            placeholder="例如: 手機號碼、Email"
                                            className="w-full"
                                        />
                                    </div>

                                    {/* Home Phone */}
                                    <div className="mb-4">
                                        <label htmlFor="homePhone" className="block text-red-white-text-dark text-sm font-semibold mb-2">
                                            住宅電話:
                                        </label>
                                        <input
                                            type="text"
                                            id="homePhone"
                                            value={homePhone}
                                            onChange={(e) => setHomePhone(e.target.value)}
                                            placeholder="例如: (02)1234-5678"
                                            className="w-full"
                                        />
                                    </div>

                                    {/* Line ID */}
                                    <div className="mb-4">
                                        <label htmlFor="lineId" className="block text-red-white-text-dark text-sm font-semibold mb-2">
                                            Line ID:
                                        </label>
                                        <input
                                            type="text"
                                            id="lineId"
                                            value={lineId}
                                            onChange={(e) => setLineId(e.target.value)}
                                            placeholder="例如: @yourlineid"
                                            className="w-full"
                                        />
                                    </div>

                                    {/* FB */}
                                    <div className="mb-4">
                                        <label htmlFor="facebook" className="block text-red-white-text-dark text-sm font-semibold mb-2">
                                            FB:
                                        </label>
                                        <input
                                            type="text"
                                            id="facebook"
                                            value={facebook}
                                            onChange={(e) => setFacebook(e.target.value)}
                                            placeholder="例如: facebook.com/yourprofile"
                                            className="w-full"
                                        />
                                    </div>

                                    {/* IG */}
                                    <div className="mb-4">
                                        <label htmlFor="instagram" className="block text-red-white-text-dark text-sm font-semibold mb-2">
                                            IG:
                                        </label>
                                        <input
                                            type="text"
                                            id="instagram"
                                            value={instagram}
                                            onChange={(e) => setInstagram(e.target.value)}
                                            placeholder="例如: @yourinstagram"
                                            className="w-full"
                                        />
                                    </div>

                                    {/* Address */}
                                    <div className="mb-4">
                                        <label htmlFor="address" className="block text-red-white-text-dark text-sm font-semibold mb-2">
                                            住址:
                                        </label>
                                        <input
                                            type="text"
                                            id="address"
                                            value={address}
                                            onChange={(e) => setAddress(e.target.value)}
                                            placeholder="例如: 台北市信義區忠孝東路一段1號"
                                            className="w-full"
                                        />
                                    </div>

                                    {/* Residential Area */}
                                    <div className="mb-4">
                                        <label htmlFor="residentialArea" className="block text-red-white-text-dark text-sm font-semibold mb-2">
                                            居住地:
                                        </label>
                                        <input
                                            type="text"
                                            id="residentialArea"
                                            value={residentialArea}
                                            onChange={(e) => setResidentialArea(e.target.value)}
                                            placeholder="例如: 台北市"
                                            className="w-full"
                                        />
                                    </div>

                                    {/* Occupation */}
                                    <div className="mb-4">
                                        <label htmlFor="occupation" className="block text-red-white-text-dark text-sm font-semibold mb-2">
                                            職業:
                                        </label>
                                        <input
                                            type="text"
                                            id="occupation"
                                            value={occupation}
                                            onChange={(e) => setOccupation(e.target.value)}
                                            placeholder="例如: 工程師"
                                            className="w-full"
                                        />
                                    </div>

                                    {/* Company Phone */}
                                    <div className="mb-4">
                                        <label htmlFor="companyPhone" className="block text-red-white-text-dark text-sm font-semibold mb-2">
                                            公司電話:
                                        </label>
                                        <input
                                            type="text"
                                            id="companyPhone"
                                            value={companyPhone}
                                            onChange={(e) => setCompanyPhone(e.target.value)}
                                            placeholder="例如: (02)1234-5678"
                                            className="w-full"
                                        />
                                    </div>

                                    {/* Company Address */}
                                    <div className="mb-4">
                                        <label htmlFor="companyAddress" className="block text-red-white-text-dark text-sm font-semibold mb-2">
                                            公司地址:
                                        </label>
                                        <input
                                            type="text"
                                            id="companyAddress"
                                            value={companyAddress}
                                            onChange={(e) => setCompanyAddress(e.target.value)}
                                            placeholder="例如: 台北市內湖區瑞光路99號"
                                            className="w-full"
                                        />
                                    </div>

                                    {/* Loan Amount */}
                                    <div className="mb-4">
                                        <label htmlFor="loanAmount" className="block text-red-white-text-dark text-sm font-semibold mb-2">
                                            借款金額 (NTD):
                                        </label>
                                        <input
                                            type="number"
                                            id="loanAmount"
                                            value={loanAmount}
                                            onChange={(e) => setLoanAmount(e.target.value)}
                                            placeholder="例如: 100000"
                                            className="w-full"
                                        />
                                    </div>

                                    {/* Interest Rate and Period */}
                                    <div className="mb-4 flex space-x-2">
                                        <div className="flex-1">
                                            <label htmlFor="interestRate" className="block text-red-white-text-dark text-sm font-semibold mb-2">
                                                利率 (%):
                                            </label>
                                            <input
                                                type="number"
                                                id="interestRate"
                                                value={interestRate}
                                                onChange={(e) => setInterestRate(e.target.value)}
                                                placeholder="例如: 5.0 (代表 5%)"
                                                step="0.01"
                                                className="w-full"
                                            />
                                        </div>
                                        <div>
                                            <label htmlFor="interestRatePeriod" className="block text-red-white-text-dark text-sm font-semibold mb-2">
                                                週期:
                                            </label>
                                            <select
                                                id="interestRatePeriod"
                                                value={interestRatePeriod}
                                                onChange={(e) => setInterestRatePeriod(e.target.value)}
                                                className="w-full"
                                            >
                                                {managedInterestRatePeriods.map(period => (
                                                    <option key={period} value={period}>{period}</option>
                                                ))}
                                            </select>
                                        </div>
                                    </div>

                                    {/* Repayment Method */}
                                    <div className="mb-4">
                                        <label htmlFor="repaymentMethod" className="block text-red-white-text-dark text-sm font-semibold mb-2">
                                            還款方式:
                                        </label>
                                        <select
                                            id="repaymentMethod"
                                            value={repaymentMethod}
                                            onChange={(e) => setRepaymentMethod(e.target.value)}
                                            className="w-full"
                                        >
                                            {managedRepaymentMethods.map(method => (
                                                <option key={method} value={method}>{method}</option>
                                            ))}
                                        </select>
                                    </div>

                                    {/* Loan Term Input - conditionally displayed */}
                                    {repaymentMethod === '本+利' && (
                                        <div className="mb-4">
                                            <label htmlFor="loanTerm" className="block text-red-white-text-dark text-sm font-semibold mb-2">
                                                期數:
                                            </label>
                                            <input
                                                type="number"
                                                id="loanTerm"
                                                value={loanTerm}
                                                onChange={(e) => setLoanTerm(e.target.value)}
                                                placeholder="例如: 12 (單位與利率週期一致)"
                                                className="w-full"
                                            />
                                            <p className="text-xs text-gray-500 mt-1">
                                                例如：若利率為年利率，期數為年；若利率為月利率，期數為月。
                                            </p>
                                        </div>
                                    )}

                                    {/* Disbursement Notes */}
                                    <div className="md:col-span-2 mb-4">
                                        <label htmlFor="disbursementNotes" className="block text-red-white-text-dark text-sm font-semibold mb-2">
                                            出款備註:
                                        </label>
                                        <textarea
                                            id="disbursementNotes"
                                            value={disbursementNotes}
                                            onChange={(e) => setDisbursementNotes(e.target.value)}
                                            placeholder="例如: 首次出款，已確認帳戶資訊。"
                                            rows="2"
                                            className="w-full"
                                        ></textarea>
                                    </div>

                                    {/* Emergency Contact 1 */}
                                    <div className="mb-4">
                                        <label htmlFor="emergencyContact1Name" className="block text-red-white-text-dark text-sm font-semibold mb-2">
                                            緊急聯絡人1姓名:
                                        </label>
                                        <input
                                            type="text"
                                            id="emergencyContact1Name"
                                            value={emergencyContact1Name}
                                            onChange={(e) => setEmergencyContact1Name(e.target.value)}
                                            placeholder="例如: 李大明"
                                            className="w-full"
                                        />
                                    </div>
                                    <div className="mb-4">
                                        <label htmlFor="emergencyContact1Phone" className="block text-red-white-text-dark text-sm font-semibold mb-2">
                                            緊急聯絡人1電話:
                                        </label>
                                        <input
                                            type="text"
                                            id="emergencyContact1Phone"
                                            value={emergencyContact1Phone}
                                            onChange={(e) => setEmergencyContact1Phone(e.target.value)}
                                            placeholder="例如: 0912345678"
                                            className="w-full"
                                        />
                                    </div>

                                    {/* Emergency Contact 2 */}
                                    <div className="mb-4">
                                        <label htmlFor="emergencyContact2Name" className="block text-red-white-text-dark text-sm font-semibold mb-2">
                                            緊急聯絡人2姓名:
                                        </label>
                                        <input
                                            type="text"
                                            id="emergencyContact2Name"
                                            value={emergencyContact2Name}
                                            onChange={(e) => setEmergencyContact2Name(e.target.value)}
                                            placeholder="例如: 陳小華"
                                            className="w-full"
                                        />
                                    </div>
                                    <div className="mb-4">
                                        <label htmlFor="emergencyContact2Phone" className="block text-red-white-text-dark text-sm font-semibold mb-2">
                                            緊急聯絡人2電話:
                                        </label>
                                        <input
                                            type="text"
                                            id="emergencyContact2Phone"
                                            value={emergencyContact2Phone}
                                            onChange={(e) => setEmergencyContact2Phone(e.target.value)}
                                            placeholder="例如: 0987654321"
                                            className="w-full"
                                        />
                                    </div>

                                    {/* General Notes */}
                                    <div className="md:col-span-2 mb-4">
                                        <label htmlFor="notes" className="block text-red-white-text-dark text-sm font-semibold mb-2">
                                            一般備註:
                                        </label>
                                        <textarea
                                            id="notes"
                                            value={notes}
                                            onChange={(e) => setNotes(e.target.value)}
                                            placeholder="例如: 客戶對此產品感興趣，需進一步追蹤。"
                                            rows="3"
                                            className="w-full"
                                        ></textarea>
                                    </div>
                                </div> {/* End of two-column grid */}

                                {/* Error message display */}
                                {errorMessage && (
                                    <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-4" role="alert">
                                        <span className="block sm:inline">{errorMessage}</span>
                                    </div>
                                )}

                                {/* Action buttons for Add/Edit Client (Moved to bottom) */}
                                <div className="flex space-x-4 mb-6 mt-6">
                                    <button
                                        onClick={handleSaveRecordButtonClick}
                                        className="flex-1 btn-primary"
                                        disabled={loadingFirebase || !isAuthReady}
                                    >
                                        {editingRecordId ? '更新客戶資料' : '新增客戶資料'}
                                    </button>
                                    <button
                                        onClick={resetFields}
                                        className="flex-1 btn-secondary"
                                        disabled={loadingFirebase || !isAuthReady}
                                    >
                                        重設
                                    </button>
                                    {editingRecordId && (
                                        <button
                                            onClick={handleCancelEdit}
                                            className="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75 ml-2"
                                        >
                                            取消編輯
                                        </button>
                                    )}
                                </div>

                                {/* Display area for the projected return (每期預期利息) */}
                                {projectedReturn !== null && (
                                    <div className="mt-6 p-6 bg-red-white-light rounded-xl shadow-inner text-center mb-4">
                                        <h2 className="text-xl font-semibold text-red-white-text-dark mb-2">借貸預覽 ({interestRatePeriod}預期利息):</h2>
                                        <p className={`text-4xl font-extrabold ${parseFloat(projectedReturn) >= 0 ? 'text-status-success' : 'text-status-failure'}`}>
                                            {projectedReturn} NTD
                                        </p>
                                        <p className="text-sm text-red-white-text-dark mt-2">此為借款金額在當前{interestRatePeriod}利率下，一{interestRatePeriod}預期產生之利息。</p>
                                    </div>
                                )}
                            </div>
                        )}

                        {currentPage === 'clientList' && (
                            <div id="transaction-history-section" className="card w-full overflow-y-auto max-h-[85vh] min-h-[200px]">
                                <h2 className="text-xl font-extrabold text-red-white-text-dark mb-4 text-center">客戶列表</h2>

                                {/* Top navigation/action buttons */}
                                <div className="mb-4 flex flex-col sm:flex-row sm:space-x-4 items-end justify-end">
                                    <button
                                        onClick={() => setCurrentPage('addClient')}
                                        className="w-full sm:w-auto btn-primary mb-2 sm:mb-0"
                                    >
                                        新增客戶
                                    </button>
                                    <button
                                        onClick={exportToCsv}
                                        className="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75 mb-2 sm:mb-0"
                                    >
                                        導出列表
                                    </button>
                                    <button
                                        onClick={handlePrintRecordsOnly}
                                        className="w-full sm:w-auto bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-75"
                                    >
                                        列印列表
                                    </button>
                                </div>

                                {/* Marquees Display */}
                                {marqueeContents.map((content, index) => (
                                    content && ( // Only render if content exists
                                        <div key={`marquee-${index}`} className="marquee-container">
                                            <span className="marquee-text">{content}</span>
                                        </div>
                                    )
                                ))}

                                {/* Year and Month filter for summary */}
                                <div className="mb-4 flex flex-wrap gap-4 justify-center items-center p-4 bg-red-white-light rounded-lg shadow-inner">
                                    <label htmlFor="summaryYear" className="text-red-white-text-dark text-sm font-semibold">年月份篩選:</label>
                                    <select
                                        id="summaryYear"
                                        value={selectedSummaryYear}
                                        onChange={(e) => setSelectedSummaryYear(e.target.value)}
                                        className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-white-primary focus:border-transparent transition duration-200 ease-in-out text-red-white-text-dark"
                                    >
                                        <option value="all">全部年份</option>
                                        {yearOptions.map(year => (
                                            <option key={year} value={year.toString()}>{year}年</option>
                                        ))}
                                    </select>
                                    <select
                                        id="summaryMonth"
                                        value={selectedSummaryMonth}
                                        onChange={(e) => setSelectedSummaryMonth(e.target.value)}
                                        className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-white-primary focus:border-transparent transition duration-200 ease-in-out text-red-white-text-dark"
                                    >
                                        {monthOptions.map(month => (
                                            <option key={month.value} value={month.value}>{month.label}</option>
                                        ))}
                                    </select>
                                    <button
                                        onClick={() => setShowChart(!showChart)}
                                        className="w-full sm:w-auto btn-secondary"
                                    >
                                        {showChart ? '隱藏圖表' : '查看圖表'}
                                    </button>
                                </div>

                                {/* Statistical Chart Section */}
                                {showChart && (
                                    <div className="mb-8 p-6 bg-white rounded-lg shadow-xl" style={{ height: '400px' }}>
                                        <h3 className="text-xl font-extrabold text-red-white-text-dark mb-4 text-center">金流趨勢圖 ({selectedSummaryYear === 'all' ? '全部年份' : `${selectedSummaryYear}年`} {selectedSummaryMonth === 'all' ? '全部月份' : `${parseInt(selectedSummaryMonth)}月`})</h3>
                                        <canvas id="cashFlowChart"></canvas>
                                    </div>
                                )}

                                {filteredTransactionsHistory.length > 0 ? (
                                    <>
                                        <div className="overflow-x-auto">
                                            <table className="min-w-full">
                                                <thead>
                                                    <tr>
                                                        <th>序號</th>
                                                        <th>借款日期</th>
                                                        <th>客戶名稱</th>
                                                        <th>借款金額</th>
                                                        <th>淨額</th> {/* Added Net Profit */}
                                                        <th>利率(%)</th>
                                                        <th>還款方式</th>
                                                        <th>期數</th>
                                                        <th>實際結果</th>
                                                        <th>操作</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="text-red-white-text-dark text-sm font-light">
                                                    {filteredTransactionsHistory.map((record, index) => (
                                                        <tr key={record.id} className="border-b border-gray-200 hover:bg-gray-100">
                                                            <td className="py-3 px-6 text-left whitespace-nowrap">{index + 1}</td>
                                                            <td className="py-3 px-6 text-left whitespace-nowrap">{record.loanDate ? record.loanDate.substring(0, 10) : record.date.substring(0, 10)}</td> {/* Use loanDate if available */}
                                                            <td className="py-3 px-6 text-left whitespace-nowrap">{record.clientName}</td>
                                                            <td className="py-3 px-6 text-left whitespace-nowrap">{record.loanAmount}</td>
                                                            <td className={`py-3 px-6 text-left whitespace-nowrap ${calculateLoanNetProfit(record.id) !== null && typeof calculateLoanNetProfit(record.id) === 'number' && calculateLoanNetProfit(record.id) >= 0 ? 'text-status-success' : 'text-status-failure'}`}>
                                                                {calculateLoanNetProfit(record.id) !== null ? (typeof calculateLoanNetProfit(record.id) === 'number' ? calculateLoanNetProfit(record.id).toFixed(2) : calculateLoanNetProfit(record.id)) : '待計算'}
                                                            </td> {/* Display Net Profit */}
                                                            <td className="py-3 px-6 text-left">{record.interestRate}</td>
                                                            <td className="py-3 px-6 text-left whitespace-nowrap">{record.repaymentMethod}</td>
                                                            <td className="py-3 px-6 text-left whitespace-nowrap">{record.loanTerm || 'N/A'}</td>
                                                            <td className="py-3 px-6 text-left">
                                                                {record.status === 'pending' ? (
                                                                    <div className="flex space-x-2">
                                                                        <button
                                                                            onClick={() => updateTransactionStatus(record.id, 'completed_success')}
                                                                            className="outcome-action-button success"
                                                                            disabled={loadingFirebase || !isAuthReady}
                                                                        >
                                                                            成交
                                                                        </button>
                                                                        <button
                                                                            onClick={() => updateTransactionStatus(record.id, 'completed_failure')}
                                                                            className="outcome-action-button failure"
                                                                            disabled={loadingFirebase || !isAuthReady}
                                                                        >
                                                                            失敗
                                                                        </button>
                                                                    </div>
                                                                ) : (
                                                                    <span className={`px-2 py-1 font-semibold leading-tight rounded-full ${record.actualOutcome === 'completed_success' ? 'success-badge' : 'failure-badge'}`}>
                                                                        {record.actualOutcome === 'completed_success' ? '成交' : '失敗'}
                                                                    </span>
                                                                )}
                                                            </td>
                                                            <td className="py-3 px-6 text-left">
                                                                <div className="flex space-x-2">
                                                                    <button
                                                                        onClick={() => handleEditRecord(record)}
                                                                        className="table-action-button btn-edit"
                                                                        disabled={loadingFirebase || !isAuthReady}
                                                                    >
                                                                        編輯
                                                                    </button>
                                                                    <button
                                                                        onClick={() => { setShowConfirmDeleteDialog(true); setRecordToDelete(record.id); }}
                                                                        className="table-action-button btn-delete"
                                                                        disabled={loadingFirebase || !isAuthReady}
                                                                    >
                                                                        刪除
                                                                    </button>
                                                                    <button
                                                                        onClick={() => { setEditingRecordId(record.id); setCurrentPage('cashFlowSummary'); }}
                                                                        className="table-action-button btn-cashflow"
                                                                        disabled={loadingFirebase || !isAuthReady}
                                                                    >
                                                                        金流
                                                                    </button>
                                                                    <button
                                                                        onClick={() => { setEditingRecordId(record.id); setShowEventHistoryModal(true); }}
                                                                        className="table-action-button btn-event"
                                                                        disabled={loadingFirebase || !isAuthReady}
                                                                    >
                                                                        事件
                                                                    </button>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                        {/* Updated statistics display for filtered period */}
                                        <div className="mt-4 text-center text-lg font-bold">
                                            金流狀況 (結餘):
                                            <span className={`ml-2 ${parseFloat(totalActualProfitAppLevelFiltered) >= 0 ? 'text-status-success' : 'text-status-failure'}`}>
                                                {totalActualProfitAppLevelFiltered.toFixed(2)} NTD
                                            </span>
                                        </div>
                                        <div className="mt-2 text-center text-base font-semibold text-red-white-text-dark">
                                            總出款: <span className="text-status-failure">${(totalLoanAmountSumFiltered * -1).toFixed(2)} NTD</span> |
                                            總淨利: <span className={`${parseFloat(totalActualProfitAppLevelFiltered) >= 0 ? 'text-status-success' : 'text-status-failure'}`}>{totalActualProfitAppLevelFiltered.toFixed(2)} NTD</span> |
                                            總客戶數: <span className="text-status-success">{totalCustomersFiltered}</span>
                                        </div>
                                    </>
                                ) : (
                                    <p className="text-center text-gray-500 mt-8">
                                        沒有符合篩選條件的交易紀錄。
                                    </p>
                                )}
                            </div>
                        )}

                        {currentPage === 'cashFlowSummary' && editingRecordId && (
                            <div className="card w-full mb-8">
                                <h1 className="text-3xl font-extrabold text-red-white-text-dark mb-6 text-center">
                                    金流收支 (客戶: {transactionsHistory.find(rec => rec.id === editingRecordId)?.clientName})
                                </h1>

                                {/* Summary Statistics for Current Loan (Moved to top) */}
                                <div className="mb-8 p-6 bg-red-white-light rounded-lg shadow-inner text-center">
                                    <h2 className="text-xl font-semibold text-red-white-primary mb-4">當前借款金流概覽</h2>
                                    <div className="grid grid-cols-2 gap-4 text-lg font-bold text-red-white-text-dark">
                                        <div>
                                            <p>總出款金額:</p>
                                            <span className="text-status-failure text-3xl">
                                                {(transactionsHistory.find(rec => rec.id === editingRecordId)?.loanAmount * -1 || 0).toFixed(2)} NTD
                                            </span>
                                        </div>
                                        <div>
                                            <p>金流收入:</p>
                                            <span className="text-status-success text-3xl">
                                                {totalIncomingFromCashFlows.toFixed(2)} NTD
                                            </span>
                                        </div>
                                        <div className="col-span-2">
                                            <p>金流狀況 (淨額):</p>
                                            <span className={`text-4xl ${parseFloat(currentCashFlowStatus) >= 0 ? 'text-red-white-primary' : 'text-status-failure'}`}>
                                                {currentCashFlowStatus} NTD
                                            </span>
                                        </div>
                                        {/* Display '每期應繳金額' if repayment method is '本+利' or '純繳利息' */}
                                        {transactionsHistory.find(rec => rec.id === editingRecordId) && (transactionsHistory.find(rec => rec.id === editingRecordId)?.repaymentMethod === '本+利' || transactionsHistory.find(rec => rec.id === editingRecordId)?.repaymentMethod === '純繳利息') && (
                                            <div className="col-span-2">
                                                <p>每期應繳金額:</p>
                                                <span className="text-purple-600 text-3xl">
                                                    {calculateAmountDuePerPeriod(
                                                        transactionsHistory.find(rec => rec.id === editingRecordId)?.loanAmount,
                                                        transactionsHistory.find(rec => rec.id === editingRecordId)?.interestRate,
                                                        transactionsHistory.find(rec => rec.id === editingRecordId)?.loanTerm,
                                                        transactionsHistory.find(rec => rec.id === editingRecordId)?.interestRatePeriod,
                                                        transactionsHistory.find(rec => rec.id === editingRecordId)?.repaymentMethod
                                                    )} NTD
                                                </span>
                                            </div>
                                        )}
                                    </div>
                                </div>

                                {/* Cash Flow History Table (Moved to top) */}
                                <div className="mt-8">
                                    <h2 className="text-xl font-extrabold text-red-white-text-dark mb-4 text-center">金流紀錄列表</h2>
                                    {cashFlows.length > 0 ? (
                                        <div className="overflow-x-auto">
                                            <table className="min-w-full">
                                                <thead>
                                                    <tr>
                                                        <th>類型</th>
                                                        <th>日期</th>
                                                        <th>金額</th>
                                                        <th>名目</th>
                                                        <th>備註</th>
                                                        <th>操作</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="text-red-white-text-dark text-sm font-light">
                                                    {cashFlows.map(cf => (
                                                        <tr key={cf.id} className="border-b border-gray-200 hover:bg-gray-100">
                                                            <td className="py-3 px-6 text-left whitespace-nowrap">{cf.type}</td>
                                                            <td className="py-3 px-6 text-left whitespace-nowrap">{cf.date}</td>
                                                            <td className={`py-3 px-6 text-left ${cf.type === '還款' ? 'text-status-success' : 'text-status-failure'}`}>
                                                                {cf.amount.toFixed(2)}
                                                            </td>
                                                            <td className="py-3 px-6 text-left whitespace-nowrap">{cf.item}</td>
                                                            <td className="py-3 px-6 text-left">{cf.notes}</td>
                                                            <td className="py-3 px-6 text-left">
                                                                <button
                                                                    onClick={() => handleDeleteCashFlowRecord(cf.id)}
                                                                    className="bg-gray-400 hover:bg-gray-500 text-white text-xs px-2 py-1 rounded-md transition duration-200"
                                                                >
                                                                    刪除
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    ) : (
                                        <p className="text-center text-gray-500 mt-4">
                                            此客戶目前沒有金流紀錄。
                                        </p>
                                    )}
                                </div>

                                {/* Add New Cash Flow Record Form (Moved to top) */}
                                <div className="mb-8 p-6 bg-red-white-light rounded-lg shadow-inner mt-8">
                                    <h2 className="text-xl font-semibold text-red-white-text-dark mb-4 text-center">新增金流紀錄</h2>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                        {/* Removed Type dropdown and its custom input */}
                                        <div>
                                            <label htmlFor="newCashFlowDate" className="block text-red-white-text-dark text-sm font-semibold mb-2">
                                                日期:
                                            </label>
                                            <input
                                                type="date"
                                                id="newCashFlowDate"
                                                value={newCashFlowDate}
                                                onChange={(e) => setNewCashFlowDate(e.target.value)}
                                                className="w-full"
                                            />
                                        </div>
                                        <div>
                                            <label htmlFor="newCashFlowAmount" className="block text-red-white-text-dark text-sm font-semibold mb-2">
                                                金額 (NTD):
                                            </label>
                                            <input
                                                type="number"
                                                id="newCashFlowAmount"
                                                value={newCashFlowAmount}
                                                onChange={(e) => setNewCashFlowAmount(e.target.value)}
                                                placeholder="例如: 1000 (還款), -500 (出款)"
                                                className="w-full"
                                            />
                                        </div>
                                        <div>
                                            <label htmlFor="newCashFlowItem" className="block text-red-white-text-dark text-sm font-semibold mb-2">
                                                名目:
                                            </label>
                                            <select
                                                id="newCashFlowItem"
                                                value={newCashFlowItem}
                                                onChange={(e) => setNewCashFlowItem(e.target.value)}
                                                className="w-full"
                                            >
                                                {managedCashFlowItems.map(item => (
                                                    <option key={item} value={item}>{item}</option>
                                                ))}
                                                <option value="其他">其他</option>
                                            </select>
                                            {newCashFlowItem === '其他' && (
                                                <input
                                                    type="text"
                                                    value={customCashFlowItemInput}
                                                    onChange={(e) => setCustomCashFlowItemInput(e.target.value)}
                                                    placeholder="輸入自訂名目"
                                                    className="w-full mt-2"
                                                />
                                            )}
                                        </div>
                                        <div className="md:col-span-2">
                                            <label htmlFor="newCashFlowNotes" className="block text-red-white-text-dark text-sm font-semibold mb-2">
                                                備註:
                                            </label>
                                            <textarea
                                                id="newCashFlowNotes"
                                                value={newCashFlowNotes}
                                                onChange={(e) => setNewCashFlowNotes(e.target.value)}
                                                placeholder="例如: 繳交第一期利息"
                                                rows="2"
                                                className="w-full"
                                            ></textarea>
                                        </div>
                                    </div>
                                    <button
                                        onClick={handleSaveCashFlowRecord}
                                        className="w-full btn-primary"
                                        disabled={loadingFirebase || !isAuthReady}
                                    >
                                        新增金流
                                    </button>
                                </div>

                                {/* Return to client list button */}
                                <div className="mt-8 text-center">
                                    <button
                                        onClick={() => setCurrentPage('clientList')}
                                        className="btn-secondary"
                                    >
                                        返回客戶列表
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                    {/* Copyright notice at the bottom */}
                    <div className="w-full text-center text-gray-600 text-sm mt-8 pb-4">
                        威爾設計版權所有 ver {currentVersion}
                        <button
                            onClick={() => setShowUpdateLogModal(true)}
                            className="ml-2 px-2 py-1 bg-gray-200 hover:bg-gray-300 text-gray-700 text-xs rounded-full transition duration-200"
                        >
                            更新紀錄
                        </button>
                    </div>

                    {/* Update Log Modal */}
                    {showUpdateLogModal && (
                        <div className="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4">
                            <div className="card max-w-md w-full max-h-[80vh] overflow-y-auto">
                                <h2 className="text-2xl font-bold text-red-white-text-dark mb-4 text-center">更新紀錄</h2>
                                {versionHistoryData.map((v, i) => (
                                    <div key={v.version} className={`mb-4 pb-4 ${i < versionHistoryData.length - 1 ? 'border-b border-gray-200' : ''}`}>
                                        <p className="text-lg font-semibold text-red-white-primary">版本: {v.version}</p>
                                        <p className="text-sm text-gray-500 mb-2">日期: {v.date}</p>
                                        <p className="text-red-white-text-dark">{v.content}</p>
                                    </div>
                                ))}
                                <div className="text-center mt-4">
                                    <button
                                        onClick={() => setShowUpdateLogModal(false)}
                                        className="btn-primary"
                                    >
                                        關閉
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Mount the React app to the root div
        const domContainer = document.querySelector('#root');
        const root = ReactDOM.createRoot(domContainer);
        root.render(<FinancialCRM />);
    </script>
</body>
</html>
