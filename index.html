<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>金融業客戶管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <style>
        /* 您可以將自定義的 CSS 樣式放在這裡 */
        body { font-family: sans-serif; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // =======================================================
        // IMPORTANT: 已根據您提供的資訊更新 Firebase 專案配置資訊
        // =======================================================
         const firebaseConfig = {
            apiKey: "AIzaSyADSbeZr04Rxr0Al5jKVY1u5j9dnD2Bfx4", // Web API 密鑰
            authDomain: "wds-sport.firebaseapp.com", // 根據專案 ID 推斷
            projectId: "wds-sport", // 項目 ID
            storageBucket: "wds-sport.appspot.com", // 根據專案 ID 推斷
            messagingSenderId: "765754214969", // 項目編號
            appId: "1:358067975632:web:fc3bb4abc715e8476235d5" 
        };

        // =======================================================
        // IMPORTANT: 已更新為您提供的 canvasAppId
        // =======================================================
        const canvasAppId = ""; 

        // =======================================================
        // IMPORTANT: 如果您有來自 Canvas 的自定義認證令牌，請替換此處。
        // 對於本機測試，如果您只是想匿名登入，可以保持為 null。
        // =======================================================
        const initialAuthToken = null; 

        // 初始化 Firebase (使用兼容版本以符合 CDN 引入)
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(app); 
        const auth = firebase.auth(app);   

        // =======================================================
        // 以下是您的 React 應用程式代碼
        // =======================================================

        // Utility function to format currency
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD' }).format(amount);
        };

        // Utility function to calculate loan details
        const calculateLoanDetails = (loanAmount, interestRate, rateUnit, repaymentMethod, periods, repaymentCycle) => {
            let amountPerPeriod = 0;
            let totalInterest = 0;
            let totalRepayment = 0;

            let ratePerUnit = interestRate / 100;
            let dailyRate = 0;

            switch (rateUnit) {
                case 'year': dailyRate = ratePerUnit / 365; break;
                case 'month': dailyRate = ratePerUnit / 30; break;
                case 'week': dailyRate = ratePerUnit / 7; break;
                case 'day': dailyRate = ratePerUnit; break;
                default: dailyRate = 0;
            }

            let effectiveRatePerPeriod = 0;
            switch (repaymentCycle) {
                case 'month': effectiveRatePerPeriod = dailyRate * 30; break;
                case '15day': effectiveRatePerPeriod = dailyRate * 15; break;
                case '10day': effectiveRatePerPeriod = dailyRate * 10; break;
                case 'week': effectiveRatePerPeriod = dailyRate * 7; break;
                case 'day': effectiveRatePerPeriod = dailyRate; break;
                default: effectiveRatePerPeriod = 0;
            }

            if (repaymentMethod === 'pureInterest') {
                amountPerPeriod = loanAmount * effectiveRatePerPeriod;
                totalInterest = 0;
                totalRepayment = loanAmount;
            } else {
                let numPeriods = periods;
                let rateForCalculation = effectiveRatePerPeriod;

                if (rateForCalculation > 0 && numPeriods > 0) {
                    amountPerPeriod = (loanAmount * rateForCalculation * Math.pow(1 + rateForCalculation, numPeriods)) / (Math.pow(1 + rateForCalculation, numPeriods) - 1);
                    totalRepayment = amountPerPeriod * numPeriods;
                    totalInterest = totalRepayment - loanAmount;
                } else if (numPeriods > 0) {
                    amountPerPeriod = loanAmount / numPeriods;
                    totalRepayment = loanAmount;
                    totalInterest = 0;
                }
            }
            return { amountPerPeriod, totalInterest, totalRepayment };
        };

        const ConfirmationModal = ({ message, onConfirm, onCancel, show }) => {
            if (!show) return null;
            return (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-[100]">
                    <div className="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
                        <h3 className="text-xl font-semibold text-gray-800 mb-4">確認</h3>
                        <p className="text-gray-700 mb-6">{message}</p>
                        <div className="flex justify-center space-x-4">
                            <button onClick={onCancel} className="px-6 py-3 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition duration-300">取消</button>
                            <button onClick={onConfirm} className="px-6 py-3 bg-red-600 text-white rounded-md hover:bg-red-700 transition duration-300">確定</button>
                        </div>
                    </div>
                </div>
            );
        };

        const CustomerList = ({ customers, onAddBorrower, onEditBorrower, onDeleteBorrower, userId, onGoogleSignIn, onSignOut, userName }) => {
            console.log("CustomerList rendering. Customers data received:", customers.map(c => ({id: c.id, name: c.name, dis: c.disbursementTotal, rep: c.repaymentTotal})));
            return (
                <div className="p-6 bg-gray-100 min-h-screen font-inter">
                    <div className="max-w-7xl mx-auto bg-white p-8 rounded-lg shadow-lg">
                        <div className="flex justify-between items-center mb-6">
                            <h1 className="text-3xl font-bold text-gray-800">客戶列表</h1>
                            {userId ? (
                                <div className="flex items-center space-x-4">
                                    <span className="text-gray-700">您好, {userName || '用戶'}!</span>
                                    <button
                                        onClick={onSignOut}
                                        className="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition duration-300 shadow-md"
                                    >
                                        登出
                                    </button>
                                    <button onClick={onAddBorrower} className="px-6 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-300 shadow-md">新增借款人</button>
                                </div>
                            ) : (
                                <button
                                    onClick={onGoogleSignIn}
                                    className="px-6 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-300 shadow-md flex items-center justify-center space-x-2"
                                >
                                    <svg className="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M12.24 10.21L12 10.22c-2.31 0-4.18 1.9-4.18 4.25s1.87 4.25 4.18 4.25c2.31 0 4.18-1.9 4.18-4.25s-1.87-4.25-4.18-4.25zm0-8.21c-2.31 0-4.18 1.9-4.18 4.25s1.87 4.25 4.18 4.25c2.31 0 4.18-1.9 4.18-4.25s-1.87-4.25-4.18-4.25zm0 16.42c-2.31 0-4.18 1.9-4.18 4.25s1.87 4.25 4.18 4.25c2.31 0 4.18-1.9 4.18-4.25s-1.87-4.25-4.18-4.25zM23.99 12c0-6.63-5.37-12-12-12s-12 5.37-12 12 5.37 12 12 12 12-5.37 12-12zM12 21.99c-5.52 0-9.99-4.47-9.99-9.99s4.47-9.99 9.99-9.99 9.99 4.47 9.99 9.99-4.47 9.99-9.99 9.99z"/>
                                    </svg>
                                    <span>使用 Google 登入</span>
                                </button>
                            )}
                        </div>
                        <div className="mb-4 text-sm text-gray-600">您的用戶 ID: <span className="font-mono bg-gray-200 px-2 py-1 rounded">{userId || '未登入'}</span></div>
                        <div className="overflow-x-auto">
                            <table className="min-w-full bg-white border border-gray-200 rounded-lg">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">序號</th>
                                        <th className="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">姓名</th>
                                        <th className="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">借款金額</th>
                                        <th className="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">金流狀況</th>
                                        <th className="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">訂單日期</th>
                                        <th className="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">操作</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-200">
                                    {customers.length === 0 ? (
                                        <tr><td colSpan="6" className="py-4 px-4 text-center text-gray-500">目前沒有借款人資料。</td></tr>
                                    ) : (
                                        customers.map((customer, index) => (
                                            <tr key={customer.id} className="hover:bg-gray-50">
                                                <td className="py-3 px-4 whitespace-nowrap text-sm text-gray-900">{index + 1}</td>
                                                <td className="py-3 px-4 whitespace-nowrap text-sm text-gray-900">{customer.name}</td>
                                                <td className="py-3 px-4 whitespace-nowrap text-sm text-gray-900">{formatCurrency(customer.loanAmount)}</td>
                                                <td className="py-3 px-4 whitespace-nowrap text-sm text-gray-900">
                                                    出款: {formatCurrency(customer.disbursementTotal || 0)} <br />
                                                    還款: {formatCurrency(customer.repaymentTotal || 0)}
                                                </td>
                                                <td className="py-3 px-4 whitespace-nowrap text-sm text-gray-900">{customer.loanDate}</td>
                                                <td className="py-3 px-4 whitespace-nowrap text-sm font-medium">
                                                    <button onClick={() => onEditBorrower(customer)} className="text-blue-600 hover:text-blue-900 mr-4 transition duration-300">編輯/查看</button>
                                                    <button onClick={() => onDeleteBorrower(customer.id)} className="text-red-600 hover:text-red-900 transition duration-300">刪除</button>
                                                </td>
                                            </tr>
                                        ))
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        const BorrowerForm = ({ customer, onSave, onCancel, onViewCashFlow }) => {
            const [formData, setFormData] = React.useState({
                id: customer?.id || '', name: customer?.name || '', loanDate: customer?.loanDate || new Date().toISOString().slice(0, 10),
                loanAmount: customer?.loanAmount || 0, interestRate: customer?.interestRate || 0, rateUnit: customer?.rateUnit || 'year',
                repaymentMethod: customer?.repaymentMethod || 'principalInterest', periods: customer?.periods || 1,
                repaymentCycle: customer?.repaymentCycle || 'month', paymentDayOfMonth: customer?.paymentDayOfMonth || '',
                dailyLatePenaltyPercentage: customer?.dailyLatePenaltyPercentage || 0, enableLatePenalty: customer?.enableLatePenalty || false,
                remarks: customer?.remarks || '', disbursementTotal: customer?.disbursementTotal || 0, repaymentTotal: customer?.repaymentTotal || 0,
            });

            const [amountPerPeriod, setAmountPerPeriod] = React.useState(0);
            const [showModal, setShowModal] = React.useState(false);
            const [modalMessage, setModalMessage] = React.useState('');

            React.useEffect(() => {
                const { loanAmount, interestRate, rateUnit, repaymentMethod, periods, repaymentCycle } = formData;
                if (loanAmount > 0 && interestRate >= 0) {
                    const { amountPerPeriod } = calculateLoanDetails(parseFloat(loanAmount), parseFloat(interestRate), rateUnit, repaymentMethod, parseInt(periods), repaymentCycle);
                    setAmountPerPeriod(amountPerPeriod);
                } else {
                    setAmountPerPeriod(0);
                }
            }, [formData]);

            const handleChange = (e) => {
                const { name, value, type, checked } = e.target;
                setFormData((prev) => ({ ...prev, [name]: type === 'checkbox' ? checked : value }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (formData.loanAmount <= 0) { setModalMessage('借款金額必須大於 0。'); setShowModal(true); return; }
                if (formData.interestRate < 0) { setModalMessage('利率不能為負數。'); setShowModal(true); return; }
                if (formData.repaymentMethod !== 'pureInterest' && formData.periods <= 0) { setModalMessage('期數必須大於 0。'); setShowModal(true); return; }
                onSave({ ...formData, loanAmount: parseFloat(formData.loanAmount), interestRate: parseFloat(formData.interestRate), periods: parseInt(formData.periods), dailyLatePenaltyPercentage: parseFloat(formData.dailyLatePenaltyPercentage), amountPerPeriod: amountPerPeriod, });
            };

            const closeModal = () => { setShowModal(false); setModalMessage(''); };

            return (
                <div className="p-6 bg-gray-100 min-h-screen font-inter">
                    <div className="max-w-4xl mx-auto bg-white p-8 rounded-lg shadow-lg">
                        <h1 className="text-3xl font-bold text-gray-800 mb-6">{customer ? '編輯借款人' : '新增借款人'}</h1>
                        <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label htmlFor="name" className="block text-sm font-medium text-gray-700 mb-1">姓名</label><input type="text" id="name" name="name" value={formData.name} onChange={handleChange} required className="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"/></div>
                            <div><label htmlFor="loanDate" className="block text-sm font-medium text-gray-700 mb-1">借款日期</label><input type="date" id="loanDate" name="loanDate" value={formData.loanDate} onChange={handleChange} required className="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"/></div>
                            <div><label htmlFor="loanAmount" className="block text-sm font-medium text-gray-700 mb-1">借款金額</label><input type="number" id="loanAmount" name="loanAmount" value={formData.loanAmount} onChange={handleChange} required min="0" step="0.01" className="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"/></div>
                            <div className="flex items-end"><div className="flex-grow"><label htmlFor="interestRate" className="block text-sm font-medium text-gray-700 mb-1">利率 (%)</label><input type="number" id="interestRate" name="interestRate" value={formData.interestRate} onChange={handleChange} required min="0" step="0.01" className="w-full px-4 py-2 border border-gray-300 rounded-l-md focus:ring-blue-500 focus:border-blue-500"/></div><select id="rateUnit" name="rateUnit" value={formData.rateUnit} onChange={handleChange} className="px-4 py-2 border border-gray-300 rounded-r-md bg-gray-50 focus:ring-blue-500 focus:border-blue-500"><option value="year">年</option><option value="month">月</option><option value="week">週</option><option value="day">日</option></select></div>
                            <div><label htmlFor="repaymentMethod" className="block text-sm font-medium text-gray-700 mb-1">還款方式</label><select id="repaymentMethod" name="repaymentMethod" value={formData.repaymentMethod} onChange={handleChange} className="w-full px-4 py-2 border border-gray-300 rounded-md bg-gray-50 focus:ring-blue-500 focus:border-blue-500"><option value="principalInterest">本金+利息</option><option value="pureInterest">純繳利息</option></select></div>
                            <div><label htmlFor="periods" className="block text-sm font-medium text-gray-700 mb-1">期數</label><input type="number" id="periods" name="periods" value={formData.repaymentMethod === 'pureInterest' ? '' : formData.periods} onChange={handleChange} disabled={formData.repaymentMethod === 'pureInterest'} required={formData.repaymentMethod !== 'pureInterest'} min="1" step="1" className={`w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 ${formData.repaymentMethod === 'pureInterest' ? 'bg-gray-200 cursor-not-allowed' : ''}`}/></div>
                            <div><label htmlFor="repaymentCycle" className="block text-sm font-medium text-gray-700 mb-1">還款週期</label><select id="repaymentCycle" name="repaymentCycle" value={formData.repaymentCycle} onChange={handleChange} className="w-full px-4 py-2 border border-gray-300 rounded-md bg-gray-50 focus:ring-blue-500 focus:border-blue-500"><option value="month">月</option><option value="15day">15日</option><option value="10day">10日</option><option value="week">週</option><option value="day">日</option></select></div>
                            <div><label htmlFor="paymentDayOfMonth" className="block text-sm font-medium text-gray-700 mb-1">每月幾號繳款 (非必填)</label><input type="number" id="paymentDayOfMonth" name="paymentDayOfMonth" value={formData.paymentDayOfMonth} onChange={handleChange} min="1" max="31" className="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"/></div>
                            <div className="col-span-1 md:col-span-2"><label htmlFor="dailyLatePenaltyPercentage" className="block text-sm font-medium text-gray-700 mb-1">每日遲繳罰款總借款的 % 數</label><div className="flex items-center"><input type="number" id="dailyLatePenaltyPercentage" name="dailyLatePenaltyPercentage" value={formData.dailyLatePenaltyPercentage} onChange={handleChange} min="0" step="0.01" disabled={!formData.enableLatePenalty} className={`flex-grow px-4 py-2 border border-gray-300 rounded-l-md focus:ring-blue-500 focus:border-blue-500 ${!formData.enableLatePenalty ? 'bg-gray-200 cursor-not-allowed' : ''}`}/><span className="px-3 py-2 border-y border-r border-gray-300 bg-gray-50 text-gray-700">%</span><div className="ml-4 flex items-center"><input type="checkbox" id="enableLatePenalty" name="enableLatePenalty" checked={formData.enableLatePenalty} onChange={handleChange} className="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"/><label htmlFor="enableLatePenalty" className="ml-2 text-sm font-medium text-gray-700">啟用此選項</label></div></div></div>
                            <div className="col-span-1 md:col-span-2 bg-blue-50 p-4 rounded-md border border-blue-200"><h3 className="text-lg font-semibold text-blue-800 mb-2">計算結果</h3><p className="text-gray-700 mb-1">每期應繳金額: <span className="font-bold text-blue-600">{formatCurrency(amountPerPeriod)}</span></p></div>
                            <div className="col-span-1 md:col-span-2"><label htmlFor="remarks" className="block text-sm font-medium text-gray-700 mb-1">備註</label><textarea id="remarks" name="remarks" value={formData.remarks} onChange={handleChange} rows="3" className="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"></textarea></div>
                            <div className="col-span-1 md:col-span-2 flex justify-end space-x-4 mt-6">{customer && (<button type="button" onClick={() => onViewCashFlow(customer)} className="px-6 py-3 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition duration-300 shadow-md">查看金流收支</button>)}<button type="button" onClick={onCancel} className="px-6 py-3 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition duration-300 shadow-md">取消</button><button type="submit" className="px-6 py-3 bg-green-600 text-white rounded-md hover:bg-green-700 transition duration-300 shadow-md">儲存</button></div>
                        </form>
                        {showModal && (<div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50"><div className="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center"><h3 className="text-xl font-semibold text-gray-800 mb-4">提示</h3><p className="text-gray-700 mb-6">{modalMessage}</p><button onClick={closeModal} className="px-6 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-300">確定</button></div></div>)}
                    </div>
                </div>
            );
        };

        const CashFlowModal = ({ customer, onClose, userId, appId, db }) => {
            const [cashFlows, setCashFlows] = React.useState([]);
            const [newEntry, setNewEntry] = React.useState({ type: '還款', date: new Date().toISOString().slice(0, 10), amount: '', category: '本金還款', remarks: '', });
            const [modalMessage, setModalMessage] = React.useState('');
            const [showInnerModal, setShowInnerModal] = React.useState(false);
            const [showDeleteCashFlowConfirm, setShowDeleteCashFlowConfirm] = React.useState(false);
            const [cashFlowEntryToDelete, setCashFlowEntryToDelete] = React.useState(null);

            React.useEffect(() => {
                if (!customer || !userId || typeof customer.id !== 'string' || customer.id.trim() === '') {
                    console.error("CashFlowModal useEffect: customer, userId, or customer.id is missing/invalid or empty string. Cannot fetch cash flows. Customer:", customer, "UserID:", userId);
                    return;
                }
                const cashFlowsCollectionRef = firebase.firestore().collection(`artifacts/${appId}/users/${userId}/customers/${customer.id}/cashFlows`);
                const unsubscribe = cashFlowsCollectionRef.onSnapshot((snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    const sortedData = data.sort((a, b) => new Date(b.date) - new Date(a.date));
                    setCashFlows(sortedData);
                }, (error) => {
                    console.error("Error fetching cash flows:", error);
                });
                return () => unsubscribe();
            }, [customer, userId, appId, db]);

            const handleNewEntryChange = (e) => {
                const { name, value } = e.target;
                setNewEntry(prev => ({ ...prev, [name]: value }));
            };

            const handleAddCashFlow = async (e) => {
                e.preventDefault();
                if (!newEntry.amount || parseFloat(newEntry.amount) <= 0) { setModalMessage('金額必須大於 0。'); setShowInnerModal(true); return; }
                if (!customer || !customer.id || typeof customer.id !== 'string' || customer.id.trim() === '') { setModalMessage('無法新增金流：客戶資料不完整 (缺少客戶ID)。'); setShowInnerModal(true); console.error("Attempted to add cash flow for a customer with missing or invalid ID. Customer object at error:", customer); return; }

                try {
                    const cashFlowsCollectionRef = firebase.firestore().collection(`artifacts/${appId}/users/${userId}/customers/${customer.id}/cashFlows`);
                    await cashFlowsCollectionRef.doc().set({ ...newEntry, amount: parseFloat(newEntry.amount), date: newEntry.date || new Date().toISOString().slice(0, 10), });

                    const customerDocRef = firebase.firestore().doc(`artifacts/${appId}/users/${userId}/customers/${customer.id}`);
                    const customerSnapshot = await customerDocRef.get();
                    let currentDisbursement = customerSnapshot.exists ? (customerSnapshot.data().disbursementTotal || 0) : 0;
                    let currentRepayment = customerSnapshot.exists ? (customerSnapshot.data().repaymentTotal || 0) : 0;

                    if (newEntry.type === '出款') { currentDisbursement += parseFloat(newEntry.amount); }
                    else if (newEntry.type === '還款') { currentRepayment += parseFloat(newEntry.amount); }
                    await customerDocRef.set({ disbursementTotal: currentDisbursement, repaymentTotal: currentRepayment, }, { merge: true });

                    console.log(`CashFlowModal: Updated customer ${customer.id} totals in Firestore: Disbursement=${currentDisbursement}, Repayment=${currentRepayment}`);
                    setNewEntry({ type: '還款', date: new Date().toISOString().slice(0, 10), amount: '', category: '本金還款', remarks: '', });
                } catch (error) {
                    console.error("Error adding cash flow:", error);
                    let errorMessage = '新增金流失敗。';
                    if (error.code) { errorMessage += ` 錯誤碼: ${error.code}.`; }
                    if (error.message) { errorMessage += ` 詳情: ${error.message}`; }
                    setModalMessage(errorMessage); setShowInnerModal(true);
                }
            };

            const handleDeleteCashFlow = (entry) => { setCashFlowEntryToDelete(entry); setShowDeleteCashFlowConfirm(true); };

            const confirmDeleteCashFlow = async () => {
                if (!cashFlowEntryToDelete) return;
                try {
                    await firebase.firestore().doc(`artifacts/${appId}/users/${userId}/customers/${customer.id}/cashFlows/${cashFlowEntryToDelete.id}`).delete();

                    const customerDocRef = firebase.firestore().doc(`artifacts/${appId}/users/${userId}/customers/${customer.id}`);
                    const customerSnapshot = await customerDocRef.get();
                    let currentDisbursement = customerSnapshot.exists ? (customerSnapshot.data().disbursementTotal || 0) : 0;
                    let currentRepayment = customerSnapshot.exists ? (customerSnapshot.data().repaymentTotal || 0) : 0;

                    if (cashFlowEntryToDelete.type === '出款') { currentDisbursement -= cashFlowEntryToDelete.amount; }
                    else if (cashFlowEntryToDelete.type === '還款') { currentRepayment -= cashFlowEntryToDelete.amount; }
                    await customerDocRef.set({ disbursementTotal: currentDisbursement, repaymentTotal: currentRepayment, }, { merge: true });
                    console.log(`CashFlowModal: Updated customer ${customer.id} totals in Firestore after delete: Disbursement=${currentDisbursement}, Repayment=${currentRepayment}`);
                } catch (error) {
                    console.error("Error deleting cash flow:", error);
                    let errorMessage = '刪除金流失敗。';
                    if (error.code) { errorMessage += ` 錯誤碼: ${error.code}.`; }
                    if (error.message) { errorMessage += ` 詳情: ${error.message}`; }
                    setModalMessage(errorMessage); setShowInnerModal(true);
                } finally { setShowDeleteCashFlowConfirm(false); setCashFlowEntryToDelete(null); }
            };

            const cancelDeleteCashFlow = () => { setShowDeleteCashFlowConfirm(false); setCashFlowEntryToDelete(null); };
            const closeInnerModal = () => { setShowInnerModal(false); setModalMessage(''); };

            const totalDisbursementRaw = cashFlows.filter(cf => cf.type === '出款').reduce((sum, cf) => sum + cf.amount, 0);
            const totalRepaymentRaw = cashFlows.filter(cf => cf.type === '還款').reduce((sum, cf) => sum + cf.amount, 0);
            const displayedDisbursement = totalDisbursementRaw * -1;
            const subtotal = totalRepaymentRaw + displayedDisbursement;

            return (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                        <div className="p-6 border-b border-gray-200 flex justify-between items-center">
                            <h2 className="text-2xl font-bold text-gray-800">金流收支 - {customer?.name}</h2>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-700 text-2xl font-semibold">&times;</button>
                        </div>
                        <div className="p-6">
                            <h3 className="text-xl font-semibold text-gray-800 mb-4">金流記錄</h3>
                            {cashFlows.length === 0 ? (<p className="text-gray-500 text-center mb-8">目前沒有金流記錄。</p>) : (
                                <div className="overflow-x-auto mb-8">
                                    <table className="min-w-full bg-white border border-gray-200 rounded-lg">
                                        <thead className="bg-gray-50">
                                            <tr><th className="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">類型</th><th className="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">日期</th><th className="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">金額</th><th className="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">名目</th><th className="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">備註</th><th className="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">操作</th></tr>
                                        </thead>
                                        <tbody className="divide-y divide-gray-200">
                                            {cashFlows.map((entry) => (
                                                <tr key={entry.id} className="hover:bg-gray-50">
                                                    <td className="py-2 px-3 whitespace-nowrap text-sm text-gray-900">{entry.type}</td>
                                                    <td className="py-2 px-3 whitespace-nowrap text-sm text-gray-900">{entry.date}</td>
                                                    <td className="py-2 px-3 whitespace-nowrap text-sm text-gray-900">{formatCurrency(entry.amount)}</td>
                                                    <td className="py-2 px-3 whitespace-nowrap text-sm text-gray-900">{entry.category}</td>
                                                    <td className="py-2 px-3 text-sm text-gray-900 max-w-xs overflow-hidden text-ellipsis">{entry.remarks}</td>
                                                    <td className="py-2 px-3 whitespace-nowrap text-sm font-medium"><button onClick={() => handleDeleteCashFlow(entry)} className="text-red-600 hover:text-red-900 transition duration-300">刪除</button></td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            )}
                            <h3 className="text-xl font-semibold text-gray-800 mb-4">金流總覽</h3>
                            <div className="flex justify-around mb-6 text-lg font-medium">
                                <p className="text-green-600">總出款: {formatCurrency(displayedDisbursement)}</p>
                                <p className="text-red-600">總還款: {formatCurrency(totalRepaymentRaw)}</p>
                                <p className="text-blue-600">小計: {formatCurrency(subtotal)}</p>
                            </div>
                            <h3 className="text-xl font-semibold text-gray-800 mb-4">新增金流</h3>
                            <form onSubmit={handleAddCashFlow} className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-8 p-4 border border-gray-200 rounded-md bg-gray-50">
                                <div><label htmlFor="cashFlowType" className="block text-sm font-medium text-gray-700 mb-1">類型</label><select id="cashFlowType" name="type" value={newEntry.type} onChange={handleNewEntryChange} className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"><option value="還款">還款</option><option value="出款">出款</option></select></div>
                                <div><label htmlFor="cashFlowDate" className="block text-sm font-medium text-gray-700 mb-1">日期</label><input type="date" id="cashFlowDate" name="date" value={newEntry.date} onChange={handleNewEntryChange} required className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"/></div>
                                <div><label htmlFor="cashFlowAmount" className="block text-sm font-medium text-gray-700 mb-1">金額</label><input type="number" id="cashFlowAmount" name="amount" value={newEntry.amount} onChange={handleNewEntryChange} required min="0" step="0.01" className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"/></div>
                                <div><label htmlFor="cashFlowCategory" className="block text-sm font-medium text-gray-700 mb-1">名目</label><select id="cashFlowCategory" name="category" value={newEntry.category} onChange={handleNewEntryChange} className="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50 focus:ring-blue-500 focus:border-blue-500"><option value="本金出款">本金出款</option><option value="本金還款">本金還款</option><option value="利息">利息</option><option value="罰金">罰金</option><option value="其他">其他</option></select></div>
                                <div className="col-span-full"><label htmlFor="cashFlowRemarks" className="block text-sm font-medium text-gray-700 mb-1">備註</label><textarea id="cashFlowRemarks" name="remarks" value={newEntry.remarks} onChange={handleChange} rows="2" className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"></textarea></div>
                                <div className="col-span-full flex justify-end"><button type="submit" className="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-300 shadow-md">新增金流</button></div>
                            </form>
                        </div>
                        {showInnerModal && (<div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50"><div className="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center"><h3 className="text-xl font-semibold text-gray-800 mb-4">提示</h3><p className="text-gray-700 mb-6">{modalMessage}</p><button onClick={closeInnerModal} className="px-6 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-300">確定</button></div></div>)}
                        <ConfirmationModal show={showDeleteCashFlowConfirm} message={`您確定要刪除這筆金流記錄嗎？ (金額: ${formatCurrency(cashFlowEntryToDelete?.amount || 0)})`} onConfirm={confirmDeleteCashFlow} onCancel={cancelDeleteCashFlow}/>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [customers, setCustomers] = React.useState([]);
            const [currentPage, setCurrentPage] = React.useState('list');
            const [editingCustomer, setEditingCustomer] = React.useState(null);
            const [currentUserId, setCurrentUserId] = React.useState(null);
            const [isAuthReady, setIsAuthReady] = React.useState(false);
            const [showCashFlowModal, setShowCashFlowModal] = React.useState(false);
            const [selectedCustomerForCashFlow, setSelectedCustomerForCashFlow] = React.useState(null);
            const [showDeleteConfirmModal, setShowDeleteConfirmModal] = React.useState(false);
            const [itemToDelete, setItemToDelete] = React.useState(null);
            const [userName, setUserName] = React.useState(''); // State to store user's display name

            React.useEffect(() => {
                const unsubscribeAuth = firebase.auth().onAuthStateChanged(async (user) => {
                    if (user) {
                        // User is signed in.
                        setCurrentUserId(user.uid);
                        setUserName(user.displayName || user.email || '用戶'); // Set display name
                        setIsAuthReady(true);
                    } else {
                        // No user is signed in. Attempt anonymous sign-in or wait for Google sign-in.
                        try {
                            if (initialAuthToken) {
                                await firebase.auth().signInWithCustomToken(initialAuthToken);
                            } else {
                                // Only sign in anonymously if there's no initialAuthToken and no user
                                // This prevents automatic anonymous sign-in if user intends to use Google sign-in
                                // and hasn't clicked the button yet.
                                // For this example, we'll let the Google button handle explicit sign-in.
                                // If you want anonymous fallback, uncomment the line below:
                                // await firebase.auth().signInAnonymously();
                            }
                        } catch (error) {
                            console.error("Firebase authentication failed:", error);
                        }
                        setCurrentUserId(null); // Ensure userId is null if not authenticated
                        setUserName('');
                        setIsAuthReady(true);
                    }
                });
                return () => unsubscribeAuth();
            }, []);

            React.useEffect(() => {
                if (isAuthReady && currentUserId) {
                    const customersCollectionRef = firebase.firestore().collection(`artifacts/${canvasAppId}/users/${currentUserId}/customers`);
                    const unsubscribe = customersCollectionRef.onSnapshot((snapshot) => {
                        const customerData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setCustomers(customerData);

                        if (editingCustomer && editingCustomer.id) {
                            const updatedEditingCustomer = customerData.find(c => c.id === editingCustomer.id);
                            if (updatedEditingCustomer) {
                                if (JSON.stringify(editingCustomer) !== JSON.stringify(updatedEditingCustomer)) {
                                    setEditingCustomer(updatedEditingCustomer);
                                    console.log("App: editingCustomer updated with latest data from Firestore.");
                                }
                            }
                        }
                        console.log("App's onSnapshot updated customers state. New customer data:", customerData.map(c => ({id: c.id, name: c.name, dis: c.disbursementTotal, rep: c.repaymentTotal})));
                    }, (error) => { console.error("Error fetching customers:", error); });
                    return () => unsubscribe();
                } else if (isAuthReady && !currentUserId) {
                    // Clear customers if user logs out or is not authenticated
                    setCustomers([]);
                    setEditingCustomer(null);
                }
            }, [isAuthReady, currentUserId, editingCustomer]);

            const handleGoogleSignIn = async () => {
                const provider = new firebase.auth.GoogleAuthProvider();
                try {
                    await firebase.auth().signInWithPopup(provider);
                    // onAuthStateChanged will handle updating the user state
                } catch (error) {
                    console.error("Google Sign-In failed:", error);
                    alert(`Google 登入失敗: ${error.message}`); // Use alert for simplicity in HTML version
                }
            };

            const handleSignOut = async () => {
                try {
                    await firebase.auth().signOut();
                    // onAuthStateChanged will handle updating the user state
                } catch (error) {
                    console.error("Sign Out failed:", error);
                    alert(`登出失敗: ${error.message}`); // Use alert for simplicity in HTML version
                }
            };

            const handleAddBorrower = () => { setCurrentPage('form'); setEditingCustomer(null); };
            const handleEditBorrower = (customer) => { setCurrentPage('form'); setEditingCustomer(customer); };
            const handleSaveBorrower = async (borrowerData) => {
                if (!currentUserId) { console.error("User ID not available. Cannot save data."); alert("請先登入才能儲存資料。"); return; }
                try {
                    let customerDocRef; let newCustomerId = borrowerData.id;
                    if (borrowerData.id) { customerDocRef = firebase.firestore().doc(`artifacts/${canvasAppId}/users/${currentUserId}/customers/${borrowerData.id}`); }
                    else { customerDocRef = firebase.firestore().collection(`artifacts/${canvasAppId}/users/${currentUserId}/customers`).doc(); newCustomerId = customerDocRef.id; }
                    await customerDocRef.set({ ...borrowerData, id: newCustomerId }, { merge: true });
                    setCurrentPage('list'); console.log("App: handleSaveBorrower completed. Data saved to Firestore.");
                } catch (error) { console.error("Error saving borrower:", error); alert(`儲存失敗: ${error.message}`); }
            };

            const handleDeleteBorrower = (id) => {
                const customerToDelete = customers.find(c => c.id === id);
                if (customerToDelete) { setItemToDelete({ type: 'borrower', id: id, name: customerToDelete.name }); setShowDeleteConfirmModal(true); }
            };
            const confirmDeleteAction = async () => {
                if (!currentUserId || !itemToDelete) { console.error("User ID or item to delete not available."); alert("請先登入才能刪除資料。"); return; }
                try {
                    if (itemToDelete.type === 'borrower') { await firebase.firestore().doc(`artifacts/${canvasAppId}/users/${currentUserId}/customers/${itemToDelete.id}`).delete(); console.log("App: Borrower deleted from Firestore:", itemToDelete.id); }
                } catch (error) { console.error("Error during deletion:", error); alert(`刪除失敗: ${error.message}`); }
                finally { setShowDeleteConfirmModal(false); setItemToDelete(null); }
            };
            const cancelDeleteAction = () => { setShowDeleteConfirmModal(false); setItemToDelete(null); };

            const handleCancel = () => { setCurrentPage('list'); setEditingCustomer(null); };
            const handleViewCashFlow = (customer) => {
                if (!currentUserId) { alert("請先登入才能查看金流。"); return; }
                setSelectedCustomerForCashFlow(customer); setShowCashFlowModal(true); console.log("App: Opening CashFlowModal for customer:", customer.id, "Current totals:", customer.disbursementTotal, customer.repaymentTotal);
            };
            const handleCloseCashFlowModal = () => { setShowCashFlowModal(false); setSelectedCustomerForCashFlow(null); console.log("App: Closing CashFlowModal."); };

            if (!isAuthReady) { return (<div className="flex items-center justify-center min-h-screen bg-gray-100"><div className="text-xl text-gray-700">載入中...</div></div>); }

            return (
                <div className="App">
                    {currentPage === 'list' ? (
                        <CustomerList
                            customers={customers}
                            onAddBorrower={handleAddBorrower}
                            onEditBorrower={handleEditBorrower}
                            onDeleteBorrower={handleDeleteBorrower}
                            userId={currentUserId}
                            onGoogleSignIn={handleGoogleSignIn}
                            onSignOut={handleSignOut}
                            userName={userName}
                        />
                    ) : (
                        <BorrowerForm customer={editingCustomer} onSave={handleSaveBorrower} onCancel={handleCancel} onViewCashFlow={handleViewCashFlow}/>
                    )}
                    {showCashFlowModal && selectedCustomerForCashFlow && (<CashFlowModal customer={selectedCustomerForCashFlow} onClose={handleCloseCashFlowModal} userId={currentUserId} appId={canvasAppId} db={db}/>)}
                    <ConfirmationModal show={showDeleteConfirmModal} message={`您確定要刪除客戶 ${itemToDelete?.name} 嗎？這將同時刪除所有相關金流記錄。`} onConfirm={confirmDeleteAction} onCancel={cancelDeleteAction}/>
                </div>
            );
        };

        // Render the App component
        const rootElement = document.getElementById('root');
        if (ReactDOM.createRoot) {
            ReactDOM.createRoot(rootElement).render(<App />);
        } else {
            // Fallback for older React versions if createRoot is not available
            ReactDOM.render(<App />, rootElement);
        }
    </script>
</body>
</html>
